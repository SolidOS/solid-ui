{"version":3,"sources":["../src/media-capture.js"],"names":["$rdf","require","media","module","exports","UI","icons","log","ns","pad","rdf","store","utils","widgets","cameraIcon","iconBase","retakeIcon","canvasWidth","canvasHeight","controlStyle","contentType","cameraCaptureControl","dom","getImageDoc","doneCallback","div","createElement","destination","imageBlob","player","canvas","table","appendChild","mainTR","main","setAttribute","buttons","cancelButton","addEventListener","_event","stopVideo","retakeButton","button","retake","style","visibility","shutterButton","grabCanvas","sendButton","continueButton","saveBlob","displayPlayer","navigator","mediaDevices","Error","getUserMedia","constraints","then","stream","srcObject","video","removeChild","context","getContext","drawImage","width","height","parentNode","toBlob","blob","msg","type","size","console","reviewImage","getVideoTracks","forEach","track","stop","fetcher","webOperation","uri","data","_resp","err","alert","cameraButton","but","control","restoreButton","imageDoc","cameraOLD","_gotBlob","takeSnapshot","img","ctx","offsetWidth","offsetHeight","document","src","toDataURL","window","URL","createObjectURL","error","name"],"mappings":"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","sourcesContent":["/// /////////////////////////////////////////////\r\n//\r\n//   Media input widget\r\n//\r\n//\r\n// Workflow:\r\n// The HTML5 functionality (on mobille) is to prompt for either\r\n// a realtime camera capture , OR a selection from images already ont the device\r\n// (eg camera roll).\r\n//\r\n// The solid alternative is to either take a phtoto\r\n// or access cemra roll (etc) OR to access solid cloud storage of favorite photo almbums.\r\n// (Especially latest taken ones)\r\n//\r\n/* global alert */\r\n\r\n/** @module mediaCapture */\r\n\r\nvar $rdf = require('rdflib')\r\nvar media = (module.exports = {})\r\n\r\nvar UI = {\r\n  icons: require('./iconBase'),\r\n  log: require('./log'),\r\n  ns: require('./ns'),\r\n  pad: require('./pad'),\r\n  media: media,\r\n  rdf: $rdf,\r\n  store: require('./store'),\r\n  utils: require('./utils'),\r\n  widgets: require('./widgets')\r\n}\r\n\r\n// const cameraIcon = require('./noun_Camera_1618446_000000') // load it in JS\r\nconst cameraIcon = UI.icons.iconBase + 'noun_Camera_1618446_000000.svg' // Get it from github\r\nconst retakeIcon = UI.icons.iconBase + 'noun_479395.svg' // Get it from github\r\n\r\nconst canvasWidth = '640'\r\nconst canvasHeight = '480'\r\n\r\nconst controlStyle = `border-radius: 0.5em; margin: 0.8em; width: ${canvasWidth}; height:${canvasHeight};`\r\n// const controlStyle = 'border-radius: 0.5em; margin: 0.8em; width: 320; height:240;'\r\nconst contentType = 'image/png'\r\n\r\n/** A control to capture a picture using camera\r\n * @param {Docuemnt} dom - The Document object\r\n * @param {IndexedForumla} store - The quadstore to store data in\r\n * @param {NamedNode} getImageDoc() - NN of the image file to be created\r\n * @param {function} doneCallback - Called when a picture has been taken\r\n */\r\nmodule.exports.cameraCaptureControl = function cameraCaptureControl (\r\n  dom,\r\n  store,\r\n  getImageDoc,\r\n  doneCallback\r\n) {\r\n  const div = dom.createElement('div')\r\n  var destination, imageBlob, player, canvas\r\n\r\n  const table = div.appendChild(dom.createElement('table'))\r\n  const mainTR = table.appendChild(dom.createElement('tr'))\r\n  const main = mainTR.appendChild(dom.createElement('td'))\r\n  main.setAttribute('colspan', '4')\r\n\r\n  const buttons = table.appendChild(dom.createElement('tr'))\r\n\r\n  buttons\r\n    .appendChild(dom.createElement('td')) // Cancel button\r\n    .appendChild(UI.widgets.cancelButton(dom))\r\n    .addEventListener('click', _event => {\r\n      stopVideo()\r\n      doneCallback(null)\r\n    })\r\n\r\n  const retakeButton = buttons\r\n    .appendChild(dom.createElement('td')) // Retake button\r\n    .appendChild(UI.widgets.button(dom, retakeIcon, 'Retake'))\r\n  retakeButton.addEventListener('click', _event => {\r\n    retake()\r\n  })\r\n  retakeButton.style.visibility = 'collapse' // Hide for now\r\n\r\n  const shutterButton = buttons\r\n    .appendChild(dom.createElement('td')) // Trigger capture button\r\n    .appendChild(\r\n      UI.widgets.button(dom, UI.icons.iconBase + 'noun_10636.svg', 'Snap')\r\n    )\r\n  shutterButton.addEventListener('click', grabCanvas)\r\n  shutterButton.style.visibility = 'collapse' // Hide for now\r\n\r\n  const sendButton = buttons\r\n    .appendChild(dom.createElement('td')) // Confirm and save button\r\n    .appendChild(UI.widgets.continueButton(dom)) // @@ or send icon??\r\n  sendButton.addEventListener('click', _event => {\r\n    saveBlob(imageBlob, destination)\r\n  })\r\n  sendButton.style.visibility = 'collapse' // Hide for now\r\n\r\n  function displayPlayer () {\r\n    player = main.appendChild(dom.createElement('video'))\r\n    player.setAttribute('controls', '1')\r\n    player.setAttribute('autoplay', '1')\r\n    player.setAttribute('style', controlStyle)\r\n    if (!navigator.mediaDevices) {\r\n      throw new Error('navigator.mediaDevices not available')\r\n    }\r\n    navigator.mediaDevices.getUserMedia(constraints).then(stream => {\r\n      player.srcObject = stream\r\n      shutterButton.style.visibility = 'visible' // Enable\r\n      sendButton.style.visibility = 'collapse'\r\n      retakeButton.style.visibility = 'collapse'\r\n    })\r\n  }\r\n\r\n  const constraints = {\r\n    video: true\r\n  }\r\n\r\n  function retake () {\r\n    main.removeChild(canvas)\r\n    displayPlayer() // Make new one as old one is stuck black\r\n  }\r\n\r\n  function grabCanvas () {\r\n    // Draw the video frame to the canvas.\r\n    canvas = dom.createElement('canvas')\r\n    canvas.setAttribute('width', canvasWidth)\r\n    canvas.setAttribute('height', canvasHeight)\r\n    canvas.setAttribute('style', controlStyle)\r\n    main.appendChild(canvas)\r\n\r\n    const context = canvas.getContext('2d')\r\n    context.drawImage(player, 0, 0, canvas.width, canvas.height)\r\n\r\n    player.parentNode.removeChild(player)\r\n\r\n    canvas.toBlob(blob => {\r\n      const msg = `got blob type ${blob.type} size ${blob.size}`\r\n      console.log(msg)\r\n      destination = getImageDoc()\r\n      imageBlob = blob // save for review\r\n      reviewImage()\r\n      // alert(msg)\r\n    }, contentType) // toBlob\r\n  }\r\n\r\n  function reviewImage () {\r\n    sendButton.style.visibility = 'visible'\r\n    retakeButton.style.visibility = 'visible'\r\n    shutterButton.style.visibility = 'collapse' // Hide for now\r\n  }\r\n\r\n  function stopVideo () {\r\n    if (player && player.srcObject) {\r\n      player.srcObject.getVideoTracks().forEach(track => track.stop())\r\n    }\r\n  }\r\n  function saveBlob (blob, destination) {\r\n    const contentType = blob.type\r\n    // if (!confirm('Save picture to ' + destination + ' ?')) return\r\n    console.log(\r\n      'Putting ' + blob.size + ' bytes of ' + contentType + ' to ' + destination\r\n    )\r\n    store.fetcher\r\n      .webOperation('PUT', destination.uri, {\r\n        data: blob,\r\n        contentType: contentType\r\n      })\r\n      .then(\r\n        _resp => {\r\n          console.log('ok saved ' + destination)\r\n          stopVideo()\r\n          doneCallback(destination)\r\n        },\r\n        err => {\r\n          stopVideo()\r\n          alert(err)\r\n        }\r\n      )\r\n  }\r\n\r\n  // Attach the video stream to the video element and autoplay.\r\n  displayPlayer()\r\n  return div\r\n}\r\n\r\n/** A button to capture a picture using camera\r\n * @param {Docuemnt} dom - The Document object\r\n * @param {IndexedForumla} store - The quadstore to store data in\r\n * @param {fuunction} getImageDoc - returns NN of the image file to be created\r\n * @param {function<Node>} doneCallback - called with the image taken\r\n * @returns {DomElement} - A div element with the buton in it\r\n *\r\n * This expacts the buttton to a large control when it is pressed\r\n */\r\n\r\nmodule.exports.cameraButton = function cameraButton (\r\n  dom,\r\n  store,\r\n  getImageDoc,\r\n  doneCallback\r\n) {\r\n  const div = dom.createElement('div')\r\n  const but = UI.widgets.button(dom, cameraIcon, 'Take picture')\r\n  var control\r\n  function restoreButton (imageDoc) {\r\n    div.removeChild(control)\r\n    div.appendChild(but)\r\n    doneCallback(imageDoc)\r\n  }\r\n  div.appendChild(but)\r\n  but.addEventListener('click', _event => {\r\n    div.removeChild(but)\r\n    control = UI.media.cameraCaptureControl(\r\n      dom,\r\n      store,\r\n      getImageDoc,\r\n      restoreButton\r\n    )\r\n    div.appendChild(control)\r\n  })\r\n  return div\r\n}\r\n\r\n/// /////////////////////////////////////// OLD BROKEN\r\n\r\n//  Put up a video stream and take a picture\r\n//  In: context.div, dom\r\n\r\nUI.media.cameraOLD = function (context, _gotBlob) {\r\n  function takeSnapshot () {\r\n    var dom = context.dom\r\n    var img = dom.createElement('img')\r\n    var ctx\r\n    var width = video.offsetWidth\r\n    var height = video.offsetHeight\r\n\r\n    var canvas = context.canvas || document.createElement('canvas')\r\n    canvas.width = width\r\n    canvas.height = height\r\n\r\n    ctx = canvas.getContext('2d')\r\n    ctx.drawImage(video, 0, 0, width, height)\r\n\r\n    img.src = canvas.toDataURL(contentType) // @@@\r\n    context.div.appendChild(img)\r\n  }\r\n\r\n  var video = context.dom.createElement('video')\r\n  context.div.appendChild(video)\r\n  // https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia\r\n  // https://developer.mozilla.org/en-US/docs/Web/API/HTMLCanvasElement/toBlob\r\n  navigator.mediaDevices\r\n    .getUserMedia({ video: true })\r\n    .then(function (stream) {\r\n      video.src = window.URL.createObjectURL(stream)\r\n      video.addEventListener('click', takeSnapshot)\r\n    })\r\n    .catch(function (error) {\r\n      alert('Could not access the camera. Error: ' + error.name)\r\n    })\r\n  return video\r\n}\r\n"],"file":"media-capture.js"}