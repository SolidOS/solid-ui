{"version":3,"sources":["../../src/chat/message.js"],"names":["UI","authn","require","icons","log","ns","media","pad","rdf","store","style","utils","widgets","dom","window","document","messageBodyStyle","label","elementForImageURI","imageUri","options","img","createElement","height","inlineImageHeightEms","trim","setAttribute","anchor","appendChild","makeDraggable","$rdf","sym","text","term","a","uri","addEventListener","openHrefInOutlineMode","textContent","nick","person","s","any","foaf","value","creatorAndDate","td1","creator","date","message","nickAnchor","fetcher","nowOrWhenFetched","doc","undefined","_ok","_body","creatorAndDateHorizontal","dateBit","fontSize","marginLeft","renderMessage","messageTable","bindings","fresh","userContext","colorizeByAuthor","content","dateString","messageRow","AJAR_date","AJAR_subject","selectedMessage","sameTerm","backgroundColor","selectedElement","done","ele","firstChild","nextSibling","newestFirst","newestfirst","insertBefore","authorAboveContent","setImage","shortDate","td2","isURI","test","para","isImage","expandImagesInline","anc","href","bgcolor","lightColorHash","getBgColor","strip","children","length","td3","toolsButton","button","iconBase","_event","toolTR","parentNode","removeChild","toolsTR","tools","parentElement","toolsTD"],"mappings":"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","sourcesContent":["/**\r\n * Contains the [[renderMessage]] function,\r\n * along with [[elementForImageURI]],\r\n * [[creatorAndDate]], and [[creatorAndDateHorizontal]]\r\n * @packageDocumentation\r\n */\r\n\r\n/* global $rdf */\r\n\r\nimport { messageToolbar, sentimentStripLinked } from './messageTools'\r\nconst UI = {\r\n  authn: require('../authn/authn'),\r\n  icons: require('../iconBase'),\r\n  log: require('../log'),\r\n  ns: require('../ns'),\r\n  media: require('../media-capture'),\r\n  pad: require('../pad'),\r\n  rdf: require('rdflib'),\r\n  store: require('../store'),\r\n  style: require('../style'),\r\n  utils: require('../utils'),\r\n  widgets: require('../widgets')\r\n}\r\nconst dom = UI.dom || window.document\r\n// const kb = UI.store\r\n\r\n// module.exports = { renderMessage, creatorAndDate, creatorAndDateHorizontal }\r\n\r\nconst messageBodyStyle = UI.style.messageBodyStyle\r\n\r\n// const { messageToolbar, sentimentStripLinked } = require('./messageTools')\r\nconst label = UI.utils.label\r\n\r\n/**\r\n * HTML component for an image\r\n */\r\nexport function elementForImageURI (imageUri, options) {\r\n  const img = dom.createElement('img')\r\n  let height = '10'\r\n  if (options.inlineImageHeightEms) {\r\n    height = ('' + options.inlineImageHeightEms).trim()\r\n  }\r\n  img.setAttribute(\r\n    'style',\r\n    'max-height: ' + height + 'em; border-radius: 1em; margin: 0.7em;'\r\n  )\r\n  // UI.widgets.makeDropTarget(img, handleURIsDroppedOnMugshot, droppedFileHandler)\r\n  if (imageUri) img.setAttribute('src', imageUri)\r\n  const anchor = dom.createElement('a')\r\n  anchor.setAttribute('href', imageUri)\r\n  anchor.setAttribute('target', 'images')\r\n  anchor.appendChild(img)\r\n  UI.widgets.makeDraggable(img, $rdf.sym(imageUri))\r\n  return anchor\r\n}\r\n\r\nvar anchor = function (text, term) {\r\n  // If there is no link return an element anyway\r\n  var a = dom.createElement('a')\r\n  if (term && term.uri) {\r\n    a.setAttribute('href', term.uri)\r\n    a.addEventListener('click', UI.widgets.openHrefInOutlineMode, true)\r\n    a.setAttribute('style', 'color: #3B5998; text-decoration: none; ') // font-weight: bold\r\n  }\r\n  a.textContent = text\r\n  return a\r\n}\r\n\r\nfunction nick (person) {\r\n  var s = UI.store.any(person, UI.ns.foaf('nick'))\r\n  if (s) return '' + s.value\r\n  return '' + label(person)\r\n}\r\n\r\n/**\r\n * Displays creator and date for a chat message\r\n * inside the `td1` element\r\n */\r\nexport function creatorAndDate (td1, creator, date, message) {\r\n  var nickAnchor = td1.appendChild(anchor(nick(creator), creator))\r\n  if (creator.uri) {\r\n    UI.store.fetcher.nowOrWhenFetched(creator.doc(), undefined, function (\r\n      _ok,\r\n      _body\r\n    ) {\r\n      nickAnchor.textContent = nick(creator)\r\n    })\r\n  }\r\n  td1.appendChild(dom.createElement('br'))\r\n  td1.appendChild(anchor(date, message))\r\n}\r\n\r\n/**\r\n * Horizontally displays creator and date for a chat message\r\n * inside the `td1` element\r\n */\r\nexport function creatorAndDateHorizontal (td1, creator, date, message) {\r\n  var nickAnchor = td1.appendChild(anchor(label(creator), creator))\r\n  if (creator.uri) {\r\n    UI.store.fetcher.nowOrWhenFetched(creator.doc(), undefined, function (\r\n      _ok,\r\n      _body\r\n    ) {\r\n      nickAnchor.textContent = nick(creator)\r\n    })\r\n  }\r\n  const dateBit = td1.appendChild(anchor(date, message))\r\n  dateBit.style.fontSize = '80%'\r\n  dateBit.style.marginLeft = '1em'\r\n  td1.appendChild(dom.createElement('br'))\r\n}\r\n\r\n/**\r\n * Renders a chat message inside a `messageTable`\r\n */\r\nexport function renderMessage (\r\n  messageTable,\r\n  bindings,\r\n  fresh,\r\n  options,\r\n  userContext\r\n) {\r\n  var colorizeByAuthor =\r\n    options.colorizeByAuthor === '1' || options.colorizeByAuthor === true\r\n\r\n  var creator = bindings['?creator']\r\n  var message = bindings['?msg']\r\n  var date = bindings['?date']\r\n  var content = bindings['?content']\r\n\r\n  var dateString = date.value\r\n  var messageRow = dom.createElement('tr')\r\n  messageRow.AJAR_date = dateString\r\n  messageRow.AJAR_subject = message\r\n\r\n  if (options.selectedMessage && options.selectedMessage.sameTerm(message)) {\r\n    messageRow.style.backgroundColor = 'yellow'\r\n    options.selectedElement = messageRow\r\n    messageTable.selectedElement = messageRow\r\n  }\r\n\r\n  var done = false\r\n  for (var ele = messageTable.firstChild; ; ele = ele.nextSibling) {\r\n    if (!ele) {\r\n      // empty\r\n      break\r\n    }\r\n    var newestFirst = options.newestfirst === true\r\n    if (\r\n      (dateString > ele.AJAR_date && newestFirst) ||\r\n      (dateString < ele.AJAR_date && !newestFirst)\r\n    ) {\r\n      messageTable.insertBefore(messageRow, ele)\r\n      done = true\r\n      break\r\n    }\r\n  }\r\n  if (!done) {\r\n    messageTable.appendChild(messageRow)\r\n  }\r\n\r\n  var td1 = dom.createElement('td')\r\n  messageRow.appendChild(td1)\r\n  if (options.authorAboveContent) {\r\n    const img = dom.createElement('img')\r\n    img.setAttribute(\r\n      'style',\r\n      'max-height: 2.5em; max-width: 2.5em; border-radius: 0.5em; margin: auto;'\r\n    )\r\n    UI.widgets.setImage(img, creator)\r\n    td1.appendChild(img)\r\n  } else {\r\n    creatorAndDate(td1, creator, UI.widgets.shortDate(dateString), message)\r\n  }\r\n\r\n  // Render the content ot the message itself\r\n  var td2 = messageRow.appendChild(dom.createElement('td'))\r\n\r\n  if (options.authorAboveContent) {\r\n    creatorAndDateHorizontal(\r\n      td2,\r\n      creator,\r\n      UI.widgets.shortDate(dateString),\r\n      message\r\n    )\r\n  }\r\n  const text = content.value.trim()\r\n  const isURI = /^https?:\\/[^ <>]*$/i.test(text)\r\n  let para = null\r\n  if (isURI) {\r\n    var isImage = /\\.(gif|jpg|jpeg|tiff|png|svg)$/i.test(text) // @@ Should use content-type not URI\r\n    if (isImage && options.expandImagesInline) {\r\n      const img = elementForImageURI(text, options)\r\n      td2.appendChild(img)\r\n    } else {\r\n      // Link but not Image\r\n      const anc = td2.appendChild(dom.createElement('a'))\r\n      para = anc.appendChild(dom.createElement('p'))\r\n      anc.href = text\r\n      para.textContent = text\r\n      td2.appendChild(anc)\r\n    }\r\n  } else {\r\n    // text\r\n    para = dom.createElement('p')\r\n    td2.appendChild(para)\r\n    para.textContent = text\r\n  }\r\n  if (para) {\r\n    var bgcolor = colorizeByAuthor\r\n      ? UI.pad.lightColorHash(creator)\r\n      : getBgColor(fresh)\r\n    para.setAttribute(\r\n      'style',\r\n      messageBodyStyle + 'background-color: ' + bgcolor + ';'\r\n    )\r\n  }\r\n\r\n  function getBgColor (fresh) {\r\n    return fresh ? '#e8ffe8' : 'white'\r\n  }\r\n\r\n  // Sentiment strip\r\n  const strip = sentimentStripLinked(message, message.doc())\r\n  if (strip.children.length) {\r\n    td2.appendChild(dom.createElement('br'))\r\n    td2.appendChild(strip)\r\n  }\r\n\r\n  // Message tool bar button\r\n  var td3 = dom.createElement('td')\r\n  messageRow.appendChild(td3)\r\n  var toolsButton = UI.widgets.button(\r\n    dom,\r\n    UI.icons.iconBase + 'noun_243787.svg',\r\n    '...'\r\n  )\r\n  td3.appendChild(toolsButton)\r\n  toolsButton.addEventListener('click', function (_event) {\r\n    if (messageRow.toolTR) {\r\n      // already got a toolbar? Toogle\r\n      messageRow.parentNode.removeChild(messageRow.toolTR)\r\n      delete messageRow.toolTR\r\n      return\r\n    }\r\n    const toolsTR = dom.createElement('tr')\r\n    const tools = messageToolbar(message, messageRow, userContext)\r\n    tools.style =\r\n      'border: 0.05em solid #888; border-radius: 0 0 0.7em 0.7em;  border-top: 0; height:3.5em; background-color: #fff;' // @@ fix\r\n    if (messageRow.nextSibling) {\r\n      messageRow.parentElement.insertBefore(toolsTR, messageRow.nextSibling)\r\n    } else {\r\n      messageRow.parentElement.appendChild(toolsTR)\r\n    }\r\n    messageRow.toolTR = toolsTR\r\n    toolsTR.appendChild(dom.createElement('td')) // left\r\n    const toolsTD = toolsTR.appendChild(dom.createElement('td'))\r\n    toolsTR.appendChild(dom.createElement('td')) // right\r\n    toolsTD.appendChild(tools)\r\n  })\r\n  return messageRow\r\n}\r\n"],"file":"message.js"}