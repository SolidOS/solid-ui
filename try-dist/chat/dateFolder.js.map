{"version":3,"sources":["../../src/chat/dateFolder.js"],"names":["kb","require","ns","module","exports","rootThing","leafFileName","membershipProperty","root","rootFolder","dir","wf","date","isoDate","toISOString","path","split","replace","uri","sym","doc","head","length","str","slice","Date","console","log","backwards","previousPeriod","file","level","younger","suitable","lastNonEmpty","siblings","filter","sort","reverse","pop","folder","leafDocument","thisDateFolder","fetcher","load","statementsMatching","dct","x","tail","includes","parent","each","ldp","uncle","cousins","result","leafDocumentFromDate","found","dateFromLeafDocument","earliestSubfolder","folderFetcher","requested","force","kids","folderStore","Error","$rdf","graph","Fetcher","y","month","d","leafObjects","msg","trace","sortMe","map","leafObject","any"],"mappings":"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","sourcesContent":["/**\r\n * Contains the [[DateFolder]] class\r\n * @packageDocumentation\r\n */\r\n\r\n/* global $rdf */\r\n\r\nconst kb = require('../store.js')\r\nconst ns = require('../ns.js')\r\n\r\n/**\r\n * Track back through the YYYY/MM/DD tree to find the previous/next day\r\n */\r\nmodule.exports = class DateFolder {\r\n  constructor (rootThing, leafFileName, membershipProperty) {\r\n    this.root = rootThing\r\n    this.rootFolder = rootThing.dir()\r\n    this.leafFileName = leafFileName || 'index.ttl' // typically chat.ttl\r\n    this.membershipProperty = membershipProperty || ns.wf('leafObject')\r\n  }\r\n\r\n  /* Generate the leaf document (rdf object) from date\r\n   * @returns: <NamedNode> - document\r\n   */\r\n  leafDocumentFromDate (date) {\r\n    // console.log('incoming date: ' + date)\r\n    const isoDate = date.toISOString() // Like \"2018-05-07T17:42:46.576Z\"\r\n    var path = isoDate.split('T')[0].replace(/-/g, '/') //  Like \"2018/05/07\"\r\n    path = this.root.dir().uri + path + '/' + this.leafFileName\r\n    return kb.sym(path)\r\n  }\r\n\r\n  /* Generate a date object from the leaf file name\r\n   */\r\n  dateFromLeafDocument (doc) {\r\n    const head = this.rootFolder.uri.length\r\n    const str = doc.uri.slice(head, head + 10).replace(/\\//g, '-')\r\n    // let date = new Date(str + 'Z') // GMT - but fails in FF - invalid format :-(\r\n    var date = new Date(str) // not explicitly UTC but is assumed so in spec\r\n    // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/parse\r\n    console.log('Date for ' + doc + ':' + date.toISOString())\r\n    return date\r\n  }\r\n\r\n  async loadPrevious (date, backwards) {\r\n    const thisDateFolder = this\r\n    async function previousPeriod (file, level) {\r\n      function younger (x) {\r\n        if (backwards ? x.uri >= file.uri : x.uri <= file.uri) return false // later than we want or same -- looking for different\r\n        return true\r\n      }\r\n      function suitable (x) {\r\n        const tail = x.uri\r\n          .slice(0, -1)\r\n          .split('/')\r\n          .slice(-1)[0]\r\n        if (!'0123456789'.includes(tail[0])) return false // not numeric\r\n        return true\r\n      }\r\n\r\n      async function lastNonEmpty (siblings) {\r\n        siblings = siblings.filter(suitable)\r\n        siblings.sort() // chronological order\r\n        if (!backwards) siblings.reverse()\r\n        if (level !== 3) return siblings.pop() // only length chck final leverl\r\n        while (siblings.length) {\r\n          const folder = siblings.pop()\r\n          const leafDocument = kb.sym(folder.uri + thisDateFolder.leafFileName)\r\n          await kb.fetcher.load(leafDocument)\r\n          // files can have seealso links. skip ones with no leafObjects with a date\r\n          if (\r\n            kb.statementsMatching(null, ns.dct('created'), null, leafDocument)\r\n              .length > 0\r\n          ) {\r\n            return folder\r\n          }\r\n        }\r\n        return null\r\n      }\r\n      // console.log('  previousPeriod level' + level + ' file ' + file)\r\n      const parent = file.dir()\r\n      await kb.fetcher.load(parent)\r\n      var siblings = kb.each(parent, ns.ldp('contains'))\r\n      siblings = siblings.filter(younger)\r\n      const folder = await lastNonEmpty(siblings)\r\n      if (folder) return folder\r\n\r\n      if (level === 0) return null // 3:day, 2:month, 1: year  0: no\r\n\r\n      const uncle = await previousPeriod(parent, level - 1)\r\n      if (!uncle) return null // reached first ever\r\n      await kb.fetcher.load(uncle)\r\n      var cousins = kb.each(uncle, ns.ldp('contains'))\r\n      const result = await lastNonEmpty(cousins)\r\n      return result\r\n    } // previousPeriod\r\n\r\n    const folder = this.leafDocumentFromDate(date).dir()\r\n    const found = await previousPeriod(folder, 3)\r\n    if (found) {\r\n      const doc = kb.sym(found.uri + this.leafFileName)\r\n      return this.dateFromLeafDocument(doc)\r\n    }\r\n    return null\r\n  } // loadPrevious\r\n\r\n  async firstLeaf (backwards) {\r\n    // backwards -> last leafObject\r\n    var folderStore = $rdf.graph()\r\n    var folderFetcher = new $rdf.Fetcher(folderStore)\r\n    async function earliestSubfolder (parent) {\r\n      function suitable (x) {\r\n        const tail = x.uri\r\n          .slice(0, -1)\r\n          .split('/')\r\n          .slice(-1)[0]\r\n        if (!'0123456789'.includes(tail[0])) return false // not numeric\r\n        return true\r\n      }\r\n      console.log('            parent ' + parent)\r\n      delete folderFetcher.requested[parent.uri]\r\n      // try {\r\n      await folderFetcher.load(parent, { force: true }) // Force fetch as will have changed\r\n      // }catch (err) {\r\n      // }\r\n\r\n      var kids = folderStore.each(parent, ns.ldp('contains'))\r\n      kids = kids.filter(suitable)\r\n      if (kids.length === 0) {\r\n        throw new Error(' @@@  No children to         parent2 ' + parent)\r\n      }\r\n\r\n      kids.sort()\r\n      if (backwards) kids.reverse()\r\n      return kids[0]\r\n    }\r\n    const y = await earliestSubfolder(this.root.dir())\r\n    const month = await earliestSubfolder(y)\r\n    const d = await earliestSubfolder(month)\r\n    const leafDocument = $rdf.sym(d.uri + 'chat.ttl')\r\n    await folderFetcher.load(leafDocument)\r\n    const leafObjects = folderStore.each(\r\n      this.root,\r\n      this.membershipProperty,\r\n      null,\r\n      leafDocument\r\n    )\r\n    if (leafObjects.length === 0) {\r\n      const msg =\r\n        '  INCONSISTENCY -- no chat leafObject in file ' + leafDocument\r\n      console.trace(msg)\r\n      throw new Error(msg)\r\n    }\r\n    const sortMe = leafObjects.map(leafObject => [\r\n      folderStore.any(leafObject, ns.dct('created')),\r\n      leafObject\r\n    ])\r\n    sortMe.sort()\r\n    if (backwards) sortMe.reverse()\r\n    console.log(\r\n      (backwards ? 'Latest' : 'Earliest') + ' leafObject is ' + sortMe[0][1]\r\n    )\r\n    return sortMe[0][1]\r\n  } // firstleafObject\r\n} // class\r\n"],"file":"dateFolder.js"}