{"version":3,"sources":["../src/messageArea.js"],"names":["UI","authn","require","icons","log","ns","pad","rdf","store","style","widgets","utils","module","exports","dom","kb","subject","messageStore","options","doc","WF","$rdf","Namespace","DCT","newestFirst","messageBodyStyle","div","createElement","messageTable","me","updater","anchor","text","term","a","uri","setAttribute","addEventListener","openHrefInOutlineMode","textContent","mention","message","pre","appendChild","createTextNode","announce","warn","error","newMessageForm","form","lhs","middle","rhs","AJAR_date","sendMessage","field","disabled","sts","now","Date","timestamp","getTime","dateStamp","sym","push","Statement","wf","sioc","literal","value","foaf","sendComplete","success","body","errorMessageBlock","bindings","renderMessage","update","sendButton","turnOnInput","creatorAndDate","innerHTML","rows","e","keyCode","altKey","button","iconBase","buttonStyle","context","logIn","then","nick","person","s","any","label","td1","creator","date","nickAnchor","fetcher","nowOrWhenFetched","undefined","_ok","_body","syncMessages","about","displayed","ele","ele2","firstChild","nextSibling","AJAR_subject","messages","each","stored","map","m","addMessage","removeChild","deleteMessage","deletions","statementsMatching","concat","ok","fresh","content","dateString","tr","done","insertBefore","shortDate","td2","td3","delButton","_event","cancelButton","sureButton","query","Query","v","vs","x","vars","variable","pat","add","msg","dct","doneQuery","refresh"],"mappings":";;AAAA;AACA;AACA;AACA,IAAIA,EAAE,GAAG;AACPC,EAAAA,KAAK,EAAEC,OAAO,CAAC,eAAD,CADP;AAEPC,EAAAA,KAAK,EAAED,OAAO,CAAC,YAAD,CAFP;AAGPE,EAAAA,GAAG,EAAEF,OAAO,CAAC,OAAD,CAHL;AAIPG,EAAAA,EAAE,EAAEH,OAAO,CAAC,MAAD,CAJJ;AAKPI,EAAAA,GAAG,EAAEJ,OAAO,CAAC,IAAD,CALL;AAMPK,EAAAA,GAAG,EAAEL,OAAO,CAAC,QAAD,CANL;AAOPM,EAAAA,KAAK,EAAEN,OAAO,CAAC,SAAD,CAPP;AAQPO,EAAAA,KAAK,EAAEP,OAAO,CAAC,SAAD,CARP;AASPQ,EAAAA,OAAO,EAAER,OAAO,CAAC,WAAD;AATT,CAAT;;AAYA,IAAMS,KAAK,GAAGT,OAAO,CAAC,SAAD,CAArB,C,CAEA;;;AAEAU,MAAM,CAACC,OAAP,GAAiB,UAAUC,GAAV,EAAeC,EAAf,EAAmBC,OAAnB,EAA4BC,YAA5B,EAA0CC,OAA1C,EAAmD;AAClEH,EAAAA,EAAE,GAAGA,EAAE,IAAIf,EAAE,CAACQ,KAAd;AACAS,EAAAA,YAAY,GAAGA,YAAY,CAACE,GAAb,EAAf,CAFkE,CAEhC;;AAClC,MAAId,EAAE,GAAGL,EAAE,CAACK,EAAZ;AACA,MAAIe,EAAE,GAAGC,IAAI,CAACC,SAAL,CAAe,oCAAf,CAAT;AACA,MAAIC,GAAG,GAAGF,IAAI,CAACC,SAAL,CAAe,2BAAf,CAAV;AAEAJ,EAAAA,OAAO,GAAGA,OAAO,IAAI,EAArB;AAEA,MAAIM,WAAW,GAAG,CAAC,CAACN,OAAO,CAACM,WAA5B;AAEA,MAAIC,gBAAgB,GAClB,iIADF,CAXkE,CAalE;;AAEA,MAAIC,GAAG,GAAGZ,GAAG,CAACa,aAAJ,CAAkB,KAAlB,CAAV;AACA,MAAIC,YAAJ,CAhBkE,CAgBjD;;AAEjB,MAAIC,EAAJ;AAEA,MAAIC,OAAO,GAAG9B,EAAE,CAACQ,KAAH,CAASsB,OAAvB;;AAEA,MAAIC,MAAM,GAAG,SAATA,MAAS,CAAUC,IAAV,EAAgBC,IAAhB,EAAsB;AACjC;AACA,QAAIC,CAAC,GAAGpB,GAAG,CAACa,aAAJ,CAAkB,GAAlB,CAAR;;AACA,QAAIM,IAAI,IAAIA,IAAI,CAACE,GAAjB,EAAsB;AACpBD,MAAAA,CAAC,CAACE,YAAF,CAAe,MAAf,EAAuBH,IAAI,CAACE,GAA5B;AACAD,MAAAA,CAAC,CAACG,gBAAF,CAAmB,OAAnB,EAA4BrC,EAAE,CAACU,OAAH,CAAW4B,qBAAvC,EAA8D,IAA9D;AACAJ,MAAAA,CAAC,CAACE,YAAF,CAAe,OAAf,EAAwB,yCAAxB,EAHoB,CAG+C;AACpE;;AACDF,IAAAA,CAAC,CAACK,WAAF,GAAgBP,IAAhB;AACA,WAAOE,CAAP;AACD,GAVD;;AAYA,MAAIM,OAAO,GAAG,SAASA,OAAT,CAAkBC,OAAlB,EAA2BhC,KAA3B,EAAkC;AAC9C,QAAIiC,GAAG,GAAG5B,GAAG,CAACa,aAAJ,CAAkB,KAAlB,CAAV;AACAe,IAAAA,GAAG,CAACN,YAAJ,CAAiB,OAAjB,EAA0B3B,KAAK,IAAI,aAAnC;AACAiB,IAAAA,GAAG,CAACiB,WAAJ,CAAgBD,GAAhB;AACAA,IAAAA,GAAG,CAACC,WAAJ,CAAgB7B,GAAG,CAAC8B,cAAJ,CAAmBH,OAAnB,CAAhB;AACA,WAAOC,GAAP;AACD,GAND;;AAQA,MAAIG,QAAQ,GAAG;AACbzC,IAAAA,GAAG,EAAE,aAAUqC,OAAV,EAAmB;AACtBD,MAAAA,OAAO,CAACC,OAAD,EAAU,cAAV,CAAP;AACD,KAHY;AAIbK,IAAAA,IAAI,EAAE,cAAUL,OAAV,EAAmB;AACvBD,MAAAA,OAAO,CAACC,OAAD,EAAU,cAAV,CAAP;AACD,KANY;AAObM,IAAAA,KAAK,EAAE,eAAUN,OAAV,EAAmB;AACxBD,MAAAA,OAAO,CAACC,OAAD,EAAU,cAAV,CAAP;AACD;AATY,GAAf,CA1CkE,CAsDlE;AACA;;AACA,MAAIO,cAAc,GAAG,SAAjBA,cAAiB,GAAY;AAC/B,QAAIC,IAAI,GAAGnC,GAAG,CAACa,aAAJ,CAAkB,IAAlB,CAAX;AACA,QAAIuB,GAAG,GAAGpC,GAAG,CAACa,aAAJ,CAAkB,IAAlB,CAAV;AACA,QAAIwB,MAAM,GAAGrC,GAAG,CAACa,aAAJ,CAAkB,IAAlB,CAAb;AACA,QAAIyB,GAAG,GAAGtC,GAAG,CAACa,aAAJ,CAAkB,IAAlB,CAAV;AACAsB,IAAAA,IAAI,CAACN,WAAL,CAAiBO,GAAjB;AACAD,IAAAA,IAAI,CAACN,WAAL,CAAiBQ,MAAjB;AACAF,IAAAA,IAAI,CAACN,WAAL,CAAiBS,GAAjB;AACAH,IAAAA,IAAI,CAACI,SAAL,GAAiB,sBAAjB,CAR+B,CAQS;;AAExC,QAAIC,WAAW,GAAG,SAAdA,WAAc,GAAY;AAC5B;AACA;AACAC,MAAAA,KAAK,CAACnB,YAAN,CAAmB,OAAnB,EAA4B,aAA5B;AACAmB,MAAAA,KAAK,CAACC,QAAN,GAAiB,IAAjB;AACA,UAAIC,GAAG,GAAG,EAAV;AACA,UAAIC,GAAG,GAAG,IAAIC,IAAJ,EAAV;AACA,UAAIC,SAAS,GAAG,KAAKF,GAAG,CAACG,OAAJ,EAArB;AACA,UAAIC,SAAS,GAAGzC,IAAI,CAACY,IAAL,CAAUyB,GAAV,CAAhB,CAR4B,CAS5B;;AACA,UAAIjB,OAAO,GAAG1B,EAAE,CAACgD,GAAH,CAAO9C,YAAY,CAACkB,GAAb,GAAmB,GAAnB,GAAyB,KAAzB,GAAiCyB,SAAxC,CAAd;AAEAH,MAAAA,GAAG,CAACO,IAAJ,CACE,IAAI3C,IAAI,CAAC4C,SAAT,CAAmBjD,OAAnB,EAA4BX,EAAE,CAAC6D,EAAH,CAAM,SAAN,CAA5B,EAA8CzB,OAA9C,EAAuDxB,YAAvD,CADF,EAZ4B,CAe5B;;AACAwC,MAAAA,GAAG,CAACO,IAAJ,CACE,IAAI3C,IAAI,CAAC4C,SAAT,CACExB,OADF,EAEEpC,EAAE,CAAC8D,IAAH,CAAQ,SAAR,CAFF,EAGEpD,EAAE,CAACqD,OAAH,CAAWb,KAAK,CAACc,KAAjB,CAHF,EAIEpD,YAJF,CADF;AAQAwC,MAAAA,GAAG,CAACO,IAAJ,CACE,IAAI3C,IAAI,CAAC4C,SAAT,CAAmBxB,OAAnB,EAA4BlB,GAAG,CAAC,SAAD,CAA/B,EAA4CuC,SAA5C,EAAuD7C,YAAvD,CADF;;AAGA,UAAIY,EAAJ,EAAQ;AACN4B,QAAAA,GAAG,CAACO,IAAJ,CACE,IAAI3C,IAAI,CAAC4C,SAAT,CAAmBxB,OAAnB,EAA4BpC,EAAE,CAACiE,IAAH,CAAQ,OAAR,CAA5B,EAA8CzC,EAA9C,EAAkDZ,YAAlD,CADF;AAGD;;AAED,UAAIsD,YAAY,GAAG,SAAfA,YAAe,CAAUpC,GAAV,EAAeqC,OAAf,EAAwBC,IAAxB,EAA8B;AAC/C,YAAI,CAACD,OAAL,EAAc;AACZvB,UAAAA,IAAI,CAACN,WAAL,CACE3C,EAAE,CAACU,OAAH,CAAWgE,iBAAX,CAA6B5D,GAA7B,EAAkC,4BAA4B2D,IAA9D,CADF;AAGD,SAJD,MAIO;AACL,cAAIE,QAAQ,GAAG;AACb,oBAAQlC,OADK;AAEb,wBAAY1B,EAAE,CAACqD,OAAH,CAAWb,KAAK,CAACc,KAAjB,CAFC;AAGb,qBAASP,SAHI;AAIb,wBAAYjC;AAJC,WAAf;AAMA+C,UAAAA,aAAa,CAACD,QAAD,EAAW,KAAX,CAAb,CAPK,CAO0B;;AAE/BpB,UAAAA,KAAK,CAACc,KAAN,GAAc,EAAd,CATK,CASY;;AACjBd,UAAAA,KAAK,CAACnB,YAAN,CAAmB,OAAnB,EAA4B,EAA5B;AACAmB,UAAAA,KAAK,CAACC,QAAN,GAAiB,KAAjB;AACD;AACF,OAlBD;;AAmBA1B,MAAAA,OAAO,CAAC+C,MAAR,CAAe,EAAf,EAAmBpB,GAAnB,EAAwBc,YAAxB;AACD,KArDD;;AAsDAtB,IAAAA,IAAI,CAACN,WAAL,CAAiB7B,GAAG,CAACa,aAAJ,CAAkB,IAAlB,CAAjB;AAEA,QAAI4B,KAAJ,EAAWuB,UAAX;;AACA,QAAIC,WAAW,GAAG,SAAdA,WAAc,GAAY;AAC5BC,MAAAA,cAAc,CAAC9B,GAAD,EAAMrB,EAAN,EAAU,EAAV,EAAc,IAAd,CAAd;AAEA0B,MAAAA,KAAK,GAAGzC,GAAG,CAACa,aAAJ,CAAkB,UAAlB,CAAR;AACAwB,MAAAA,MAAM,CAAC8B,SAAP,GAAmB,EAAnB;AACA9B,MAAAA,MAAM,CAACR,WAAP,CAAmBY,KAAnB;AACAA,MAAAA,KAAK,CAAC2B,IAAN,GAAa,CAAb,CAN4B,CAO5B;;AACA3B,MAAAA,KAAK,CAACnB,YAAN,CAAmB,OAAnB,EAA4BX,gBAAgB,GAAG,yBAA/C;AAEA8B,MAAAA,KAAK,CAAClB,gBAAN,CACE,OADF,EAEE,UAAU8C,CAAV,EAAa;AACX;AACA,YAAIA,CAAC,CAACC,OAAF,KAAc,EAAlB,EAAsB;AACpB,cAAI,CAACD,CAAC,CAACE,MAAP,EAAe;AACb;AACA/B,YAAAA,WAAW;AACZ;AACF;AACF,OAVH,EAWE,KAXF;AAcAF,MAAAA,GAAG,CAAC6B,SAAJ,GAAgB,EAAhB;AACAH,MAAAA,UAAU,GAAG9E,EAAE,CAACU,OAAH,CAAW4E,MAAX,CACXxE,GADW,EAEXd,EAAE,CAACG,KAAH,CAASoF,QAAT,GAAoB,iBAFT,EAGX,MAHW,CAAb;AAKAT,MAAAA,UAAU,CAAC1C,YAAX,CAAwB,OAAxB,EAAiCpC,EAAE,CAACS,KAAH,CAAS+E,WAAT,GAAuB,eAAxD;AACAV,MAAAA,UAAU,CAACzC,gBAAX,CAA4B,OAA5B,EAAqCiB,WAArC,EAAkD,KAAlD;AACAF,MAAAA,GAAG,CAACT,WAAJ,CAAgBmC,UAAhB;AACD,KAjCD;;AAmCA,QAAMW,OAAO,GAAG;AAAE/D,MAAAA,GAAG,EAAEyB,MAAP;AAAerC,MAAAA,GAAG,EAAEA;AAApB,KAAhB;AACAd,IAAAA,EAAE,CAACC,KAAH,CAASyF,KAAT,CAAeD,OAAf,EAAwBE,IAAxB,CAA6B,UAAAF,OAAO,EAAI;AACtC5D,MAAAA,EAAE,GAAG4D,OAAO,CAAC5D,EAAb;AACAkD,MAAAA,WAAW;AACZ,KAHD;AAKA,WAAO9B,IAAP;AACD,GA7GD;;AA+GA,WAAS2C,IAAT,CAAeC,MAAf,EAAuB;AACrB,QAAIC,CAAC,GAAG9F,EAAE,CAACQ,KAAH,CAASuF,GAAT,CAAaF,MAAb,EAAqB7F,EAAE,CAACK,EAAH,CAAMiE,IAAN,CAAW,MAAX,CAArB,CAAR;AACA,QAAIwB,CAAJ,EAAO,OAAO,KAAKA,CAAC,CAACzB,KAAd;AACP,WAAO,KAAK1D,KAAK,CAACqF,KAAN,CAAYH,MAAZ,CAAZ;AACD;;AAED,WAASb,cAAT,CAAyBiB,GAAzB,EAA8BC,OAA9B,EAAuCC,IAAvC,EAA6C1D,OAA7C,EAAsD;AACpD,QAAI2D,UAAU,GAAGH,GAAG,CAACtD,WAAJ,CAAgBZ,MAAM,CAAC6D,IAAI,CAACM,OAAD,CAAL,EAAgBA,OAAhB,CAAtB,CAAjB;;AACA,QAAIA,OAAO,CAAC/D,GAAZ,EAAiB;AACfnC,MAAAA,EAAE,CAACQ,KAAH,CAAS6F,OAAT,CAAiBC,gBAAjB,CAAkCJ,OAAO,CAAC/E,GAAR,EAAlC,EAAiDoF,SAAjD,EAA4D,UAC1DC,GAD0D,EAE1DC,KAF0D,EAG1D;AACAL,QAAAA,UAAU,CAAC7D,WAAX,GAAyBqD,IAAI,CAACM,OAAD,CAA7B;AACD,OALD;AAMD;;AACDD,IAAAA,GAAG,CAACtD,WAAJ,CAAgB7B,GAAG,CAACa,aAAJ,CAAkB,IAAlB,CAAhB;AACAsE,IAAAA,GAAG,CAACtD,WAAJ,CAAgBZ,MAAM,CAACoE,IAAD,EAAO1D,OAAP,CAAtB;AACD,GAzLiE,CA2LlE;;;AAEA,WAASiE,YAAT,CAAuBC,KAAvB,EAA8B/E,YAA9B,EAA4C;AAC1C,QAAIgF,SAAS,GAAG,EAAhB;AACA,QAAIC,GAAJ,EAASC,IAAT;;AACA,SAAKD,GAAG,GAAGjF,YAAY,CAACmF,UAAxB,EAAoCF,GAApC,EAAyCA,GAAG,GAAGA,GAAG,CAACG,WAAnD,EAAgE;AAC9D,UAAIH,GAAG,CAACI,YAAR,EAAsB;AACpBL,QAAAA,SAAS,CAACC,GAAG,CAACI,YAAJ,CAAiB9E,GAAlB,CAAT,GAAkC,IAAlC;AACD;AACF;;AACD,QAAI+E,QAAQ,GAAGnG,EAAE,CAACoG,IAAH,CAAQR,KAAR,EAAetG,EAAE,CAAC6D,EAAH,CAAM,SAAN,CAAf,CAAf;AACA,QAAIkD,MAAM,GAAG,EAAb;AACAF,IAAAA,QAAQ,CAACG,GAAT,CAAa,UAAUC,CAAV,EAAa;AACxBF,MAAAA,MAAM,CAACE,CAAC,CAACnF,GAAH,CAAN,GAAgB,IAAhB;;AACA,UAAI,CAACyE,SAAS,CAACU,CAAC,CAACnF,GAAH,CAAd,EAAuB;AACrBoF,QAAAA,UAAU,CAACD,CAAD,CAAV;AACD;AACF,KALD,EAV0C,CAiB1C;;AACA,SAAKT,GAAG,GAAGjF,YAAY,CAACmF,UAAxB,EAAoCF,GAApC,GAA2C;AACzCC,MAAAA,IAAI,GAAGD,GAAG,CAACG,WAAX;;AACA,UAAIH,GAAG,CAACI,YAAJ,IAAoB,CAACG,MAAM,CAACP,GAAG,CAACI,YAAJ,CAAiB9E,GAAlB,CAA/B,EAAuD;AACrDP,QAAAA,YAAY,CAAC4F,WAAb,CAAyBX,GAAzB;AACD;;AACDA,MAAAA,GAAG,GAAGC,IAAN;AACD;AACF;;AAED,MAAIW,aAAa,GAAG,SAAhBA,aAAgB,CAAUhF,OAAV,EAAmB;AACrC,QAAIiF,SAAS,GAAG3G,EAAE,CACf4G,kBADa,CACMlF,OADN,EAEbmF,MAFa,CAEN7G,EAAE,CAAC4G,kBAAH,CAAsBpB,SAAtB,EAAiCA,SAAjC,EAA4C9D,OAA5C,CAFM,CAAhB;AAGAX,IAAAA,OAAO,CAAC+C,MAAR,CAAe6C,SAAf,EAA0B,EAA1B,EAA8B,UAAUvF,GAAV,EAAe0F,EAAf,EAAmBpD,IAAnB,EAAyB;AACrD,UAAI,CAACoD,EAAL,EAAS;AACPhF,QAAAA,QAAQ,CAACE,KAAT,CAAe,0BAA0B0B,IAAzC;AACD,OAFD,MAEO;AACLiC,QAAAA,YAAY,CAAC1F,OAAD,EAAUY,YAAV,CAAZ;AACD;AACF,KAND;AAOD,GAXD;;AAaA,MAAI2F,UAAU,GAAG,SAAbA,UAAa,CAAU9E,OAAV,EAAmB;AAClC,QAAIkC,QAAQ,GAAG;AACb,cAAQlC,OADK;AAEb,kBAAY1B,EAAE,CAACgF,GAAH,CAAOtD,OAAP,EAAgBpC,EAAE,CAACiE,IAAH,CAAQ,OAAR,CAAhB,CAFC;AAGb,eAASvD,EAAE,CAACgF,GAAH,CAAOtD,OAAP,EAAgBlB,GAAG,CAAC,SAAD,CAAnB,CAHI;AAIb,kBAAYR,EAAE,CAACgF,GAAH,CAAOtD,OAAP,EAAgBpC,EAAE,CAAC8D,IAAH,CAAQ,SAAR,CAAhB;AAJC,KAAf;AAMAS,IAAAA,aAAa,CAACD,QAAD,EAAW,IAAX,CAAb,CAPkC,CAOJ;AAC/B,GARD;;AAUA,MAAIC,aAAa,GAAG,SAAhBA,aAAgB,CAAUD,QAAV,EAAoBmD,KAApB,EAA2B;AAC7C,QAAI5B,OAAO,GAAGvB,QAAQ,CAAC,UAAD,CAAtB;AACA,QAAIlC,OAAO,GAAGkC,QAAQ,CAAC,MAAD,CAAtB;AACA,QAAIwB,IAAI,GAAGxB,QAAQ,CAAC,OAAD,CAAnB;AACA,QAAIoD,OAAO,GAAGpD,QAAQ,CAAC,UAAD,CAAtB;AAEA,QAAIqD,UAAU,GAAG7B,IAAI,CAAC9B,KAAtB;AACA,QAAI4D,EAAE,GAAGnH,GAAG,CAACa,aAAJ,CAAkB,IAAlB,CAAT;AACAsG,IAAAA,EAAE,CAAC5E,SAAH,GAAe2E,UAAf;AACAC,IAAAA,EAAE,CAAChB,YAAH,GAAkBxE,OAAlB;AAEA,QAAIyF,IAAI,GAAG,KAAX;;AACA,SAAK,IAAIrB,GAAG,GAAGjF,YAAY,CAACmF,UAA5B,GAA0CF,GAAG,GAAGA,GAAG,CAACG,WAApD,EAAiE;AAC/D,UAAI,CAACH,GAAL,EAAU;AACR;AACA;AACD;;AACD,UACGmB,UAAU,GAAGnB,GAAG,CAACxD,SAAjB,IAA8B7B,WAA/B,IACCwG,UAAU,GAAGnB,GAAG,CAACxD,SAAjB,IAA8B,CAAC7B,WAFlC,EAGE;AACAI,QAAAA,YAAY,CAACuG,YAAb,CAA0BF,EAA1B,EAA8BpB,GAA9B;AACAqB,QAAAA,IAAI,GAAG,IAAP;AACA;AACD;AACF;;AACD,QAAI,CAACA,IAAL,EAAW;AACTtG,MAAAA,YAAY,CAACe,WAAb,CAAyBsF,EAAzB;AACD;;AAED,QAAIhC,GAAG,GAAGnF,GAAG,CAACa,aAAJ,CAAkB,IAAlB,CAAV;AACAsG,IAAAA,EAAE,CAACtF,WAAH,CAAesD,GAAf;AACAjB,IAAAA,cAAc,CAACiB,GAAD,EAAMC,OAAN,EAAelG,EAAE,CAACU,OAAH,CAAW0H,SAAX,CAAqBJ,UAArB,CAAf,EAAiDvF,OAAjD,CAAd;AAEA,QAAI4F,GAAG,GAAGvH,GAAG,CAACa,aAAJ,CAAkB,IAAlB,CAAV;AACAsG,IAAAA,EAAE,CAACtF,WAAH,CAAe0F,GAAf;AACA,QAAI3F,GAAG,GAAG5B,GAAG,CAACa,aAAJ,CAAkB,GAAlB,CAAV;AACAe,IAAAA,GAAG,CAACN,YAAJ,CACE,OADF,EAEEX,gBAAgB,IACbqG,KAAK,GAAG,4BAAH,GAAkC,2BAD1B,CAFlB;AAKAO,IAAAA,GAAG,CAAC1F,WAAJ,CAAgBD,GAAhB;AACAA,IAAAA,GAAG,CAACH,WAAJ,GAAkBwF,OAAO,CAAC1D,KAA1B;AAEA,QAAIiE,GAAG,GAAGxH,GAAG,CAACa,aAAJ,CAAkB,IAAlB,CAAV;AACAsG,IAAAA,EAAE,CAACtF,WAAH,CAAe2F,GAAf;AAEA,QAAIC,SAAS,GAAGzH,GAAG,CAACa,aAAJ,CAAkB,QAAlB,CAAhB;AACA2G,IAAAA,GAAG,CAAC3F,WAAJ,CAAgB4F,SAAhB;AACAA,IAAAA,SAAS,CAAChG,WAAV,GAAwB,GAAxB;AAEA0F,IAAAA,EAAE,CAAC7F,YAAH,CAAgB,OAAhB,EAAyB,cAAzB,EApD6C,CAoDJ;;AACzCmG,IAAAA,SAAS,CAACnG,YAAV,CAAuB,OAAvB,EAAgC,kBAAhC;AACAmG,IAAAA,SAAS,CAACnG,YAAV,CAAuB,OAAvB,EAAgC,aAAhC;AACAmG,IAAAA,SAAS,CAAClG,gBAAV,CACE,OADF,EAEE,UAAUmG,MAAV,EAAkB;AAChBF,MAAAA,GAAG,CAACd,WAAJ,CAAgBe,SAAhB,EADgB,CACW;;AAC3B,UAAIE,YAAY,GAAG3H,GAAG,CAACa,aAAJ,CAAkB,QAAlB,CAAnB;AACA8G,MAAAA,YAAY,CAAClG,WAAb,GAA2B,QAA3B;AACA+F,MAAAA,GAAG,CAAC3F,WAAJ,CAAgB8F,YAAhB,EAA8BpG,gBAA9B,CACE,OADF,EAEE,UAAUmG,MAAV,EAAkB;AAChBF,QAAAA,GAAG,CAACd,WAAJ,CAAgBkB,UAAhB;AACAJ,QAAAA,GAAG,CAACd,WAAJ,CAAgBiB,YAAhB;AACAH,QAAAA,GAAG,CAAC3F,WAAJ,CAAgB4F,SAAhB;AACD,OANH,EAOE,KAPF;AASA,UAAIG,UAAU,GAAG5H,GAAG,CAACa,aAAJ,CAAkB,QAAlB,CAAjB;AACA+G,MAAAA,UAAU,CAACnG,WAAX,GAAyB,gBAAzB;AACA+F,MAAAA,GAAG,CAAC3F,WAAJ,CAAgB+F,UAAhB,EAA4BrG,gBAA5B,CACE,OADF,EAEE,UAAUmG,MAAV,EAAkB;AAChBF,QAAAA,GAAG,CAACd,WAAJ,CAAgBkB,UAAhB;AACAJ,QAAAA,GAAG,CAACd,WAAJ,CAAgBiB,YAAhB;AACAhB,QAAAA,aAAa,CAAChF,OAAD,CAAb;AACD,OANH,EAOE,KAPF;AASD,KA1BH,EA2BE,KA3BF;AA6BD,GApFD,CA/OkE,CAqUlE;;;AAEAb,EAAAA,YAAY,GAAGd,GAAG,CAACa,aAAJ,CAAkB,OAAlB,CAAf;AACAC,EAAAA,YAAY,CAACkG,KAAb,GAAqB,KAArB;AACApG,EAAAA,GAAG,CAACiB,WAAJ,CAAgBf,YAAhB;AACAA,EAAAA,YAAY,CAACQ,YAAb,CAA0B,OAA1B,EAAmC,cAAnC,EA1UkE,CA0Uf;;AAEnD,MAAI6F,EAAE,GAAGjF,cAAc,EAAvB;;AACA,MAAIxB,WAAJ,EAAiB;AACfI,IAAAA,YAAY,CAACuG,YAAb,CAA0BF,EAA1B,EAA8BrG,YAAY,CAACmF,UAA3C,EADe,CACwC;AACxD,GAFD,MAEO;AACLnF,IAAAA,YAAY,CAACe,WAAb,CAAyBsF,EAAzB,EADK,CACwB;AAC9B;;AAED,MAAIU,KAAJ,CAnVkE,CAoVlE;;AACA,MAAIzH,OAAO,CAACyH,KAAZ,EAAmB;AACjBA,IAAAA,KAAK,GAAGzH,OAAO,CAACyH,KAAhB;AACD,GAFD,MAEO;AACLA,IAAAA,KAAK,GAAG,IAAItH,IAAI,CAACuH,KAAT,CAAe,UAAf,CAAR;AACA,QAAIC,CAAC,GAAG,EAAR,CAFK,CAEM;;AACX,QAAIC,EAAE,GAAG,CAAC,KAAD,EAAQ,MAAR,EAAgB,SAAhB,EAA2B,SAA3B,CAAT;AACAA,IAAAA,EAAE,CAACzB,GAAH,CAAO,UAAU0B,CAAV,EAAa;AAClBJ,MAAAA,KAAK,CAACK,IAAN,CAAWhF,IAAX,CAAiB6E,CAAC,CAACE,CAAD,CAAD,GAAO1H,IAAI,CAAC4H,QAAL,CAAcF,CAAd,CAAxB;AACD,KAFD;AAGAJ,IAAAA,KAAK,CAACO,GAAN,CAAUC,GAAV,CAAcnI,OAAd,EAAuBI,EAAE,CAAC,SAAD,CAAzB,EAAsCyH,CAAC,CAACO,GAAxC;AACAT,IAAAA,KAAK,CAACO,GAAN,CAAUC,GAAV,CAAcN,CAAC,CAACO,GAAhB,EAAqB/I,EAAE,CAACgJ,GAAH,CAAO,SAAP,CAArB,EAAwCR,CAAC,CAAC1C,IAA1C;AACAwC,IAAAA,KAAK,CAACO,GAAN,CAAUC,GAAV,CAAcN,CAAC,CAACO,GAAhB,EAAqB/I,EAAE,CAACiE,IAAH,CAAQ,OAAR,CAArB,EAAuCuE,CAAC,CAAC3C,OAAzC;AACAyC,IAAAA,KAAK,CAACO,GAAN,CAAUC,GAAV,CAAcN,CAAC,CAACO,GAAhB,EAAqB/I,EAAE,CAAC8D,IAAH,CAAQ,SAAR,CAArB,EAAyC0E,CAAC,CAACd,OAA3C;AACD;;AACD,WAASuB,SAAT,GAAsB;AACpB1H,IAAAA,YAAY,CAACkG,KAAb,GAAqB,IAArB,CADoB,CACM;AAC3B;;AACD/G,EAAAA,EAAE,CAAC4H,KAAH,CAASA,KAAT,EAAgB/D,aAAhB,EAA+B2B,SAA/B,EAA0C+C,SAA1C;;AACA5H,EAAAA,GAAG,CAAC6H,OAAJ,GAAc,YAAY;AACxB7C,IAAAA,YAAY,CAAC1F,OAAD,EAAUY,YAAV,CAAZ;AACD,GAFD,CAvWkE,CA0WlE;;;AACA,SAAOF,GAAP;AACD,CA5WD","sourcesContent":["/* global $rdf */\r\n//  Common code for a discussion are a of messages about something\r\n//\r\nvar UI = {\r\n  authn: require('./authn/authn'),\r\n  icons: require('./iconBase'),\r\n  log: require('./log'),\r\n  ns: require('./ns'),\r\n  pad: require('./'),\r\n  rdf: require('rdflib'),\r\n  store: require('./store'),\r\n  style: require('./style'),\r\n  widgets: require('./widgets')\r\n}\r\n\r\nconst utils = require('./utils')\r\n\r\n// var buttonStyle = 'font-size: 100%; margin: 0.8em; padding:0.5em; background-color: white;'\r\n\r\nmodule.exports = function (dom, kb, subject, messageStore, options) {\r\n  kb = kb || UI.store\r\n  messageStore = messageStore.doc() // No hash\r\n  var ns = UI.ns\r\n  var WF = $rdf.Namespace('http://www.w3.org/2005/01/wf/flow#')\r\n  var DCT = $rdf.Namespace('http://purl.org/dc/terms/')\r\n\r\n  options = options || {}\r\n\r\n  var newestFirst = !!options.newestFirst\r\n\r\n  var messageBodyStyle =\r\n    'white-space: pre-wrap; width: 90%; font-size:100%; border: 0.07em solid #eee; padding: .2em 0.5em; margin: 0.1em 1em 0.1em 1em;'\r\n  // 'font-size: 100%; margin: 0.1em 1em 0.1em 1em;  background-color: white; white-space: pre-wrap; padding: 0.1em;'\r\n\r\n  var div = dom.createElement('div')\r\n  var messageTable // Shared by initial build and addMessageFromBindings\r\n\r\n  var me\r\n\r\n  var updater = UI.store.updater\r\n\r\n  var anchor = function (text, term) {\r\n    // If there is no link return an element anyway\r\n    var a = dom.createElement('a')\r\n    if (term && term.uri) {\r\n      a.setAttribute('href', term.uri)\r\n      a.addEventListener('click', UI.widgets.openHrefInOutlineMode, true)\r\n      a.setAttribute('style', 'color: #3B5998; text-decoration: none; ') // font-weight: bold\r\n    }\r\n    a.textContent = text\r\n    return a\r\n  }\r\n\r\n  var mention = function mention (message, style) {\r\n    var pre = dom.createElement('pre')\r\n    pre.setAttribute('style', style || 'color: grey')\r\n    div.appendChild(pre)\r\n    pre.appendChild(dom.createTextNode(message))\r\n    return pre\r\n  }\r\n\r\n  var announce = {\r\n    log: function (message) {\r\n      mention(message, 'color: #111;')\r\n    },\r\n    warn: function (message) {\r\n      mention(message, 'color: #880;')\r\n    },\r\n    error: function (message) {\r\n      mention(message, 'color: #800;')\r\n    }\r\n  }\r\n\r\n  //       Form for a new message\r\n  //\r\n  var newMessageForm = function () {\r\n    var form = dom.createElement('tr')\r\n    var lhs = dom.createElement('td')\r\n    var middle = dom.createElement('td')\r\n    var rhs = dom.createElement('td')\r\n    form.appendChild(lhs)\r\n    form.appendChild(middle)\r\n    form.appendChild(rhs)\r\n    form.AJAR_date = '9999-01-01T00:00:00Z' // ISO format for field sort\r\n\r\n    var sendMessage = function () {\r\n      // titlefield.setAttribute('class','pendingedit')\r\n      // titlefield.disabled = true\r\n      field.setAttribute('class', 'pendingedit')\r\n      field.disabled = true\r\n      var sts = []\r\n      var now = new Date()\r\n      var timestamp = '' + now.getTime()\r\n      var dateStamp = $rdf.term(now)\r\n      // http://www.w3schools.com/jsref/jsref_obj_date.asp\r\n      var message = kb.sym(messageStore.uri + '#' + 'Msg' + timestamp)\r\n\r\n      sts.push(\r\n        new $rdf.Statement(subject, ns.wf('message'), message, messageStore)\r\n      )\r\n      // sts.push(new $rdf.Statement(message, ns.dc('title'), kb.literal(titlefield.value), messageStore))\r\n      sts.push(\r\n        new $rdf.Statement(\r\n          message,\r\n          ns.sioc('content'),\r\n          kb.literal(field.value),\r\n          messageStore\r\n        )\r\n      )\r\n      sts.push(\r\n        new $rdf.Statement(message, DCT('created'), dateStamp, messageStore)\r\n      )\r\n      if (me) {\r\n        sts.push(\r\n          new $rdf.Statement(message, ns.foaf('maker'), me, messageStore)\r\n        )\r\n      }\r\n\r\n      var sendComplete = function (uri, success, body) {\r\n        if (!success) {\r\n          form.appendChild(\r\n            UI.widgets.errorMessageBlock(dom, 'Error writing message: ' + body)\r\n          )\r\n        } else {\r\n          var bindings = {\r\n            '?msg': message,\r\n            '?content': kb.literal(field.value),\r\n            '?date': dateStamp,\r\n            '?creator': me\r\n          }\r\n          renderMessage(bindings, false) // not green\r\n\r\n          field.value = '' // clear from out for reuse\r\n          field.setAttribute('class', '')\r\n          field.disabled = false\r\n        }\r\n      }\r\n      updater.update([], sts, sendComplete)\r\n    }\r\n    form.appendChild(dom.createElement('br'))\r\n\r\n    var field, sendButton\r\n    var turnOnInput = function () {\r\n      creatorAndDate(lhs, me, '', null)\r\n\r\n      field = dom.createElement('textarea')\r\n      middle.innerHTML = ''\r\n      middle.appendChild(field)\r\n      field.rows = 3\r\n      // field.cols = 40\r\n      field.setAttribute('style', messageBodyStyle + 'background-color: #eef;')\r\n\r\n      field.addEventListener(\r\n        'keyup',\r\n        function (e) {\r\n          // User preference?\r\n          if (e.keyCode === 13) {\r\n            if (!e.altKey) {\r\n              // Alt-Enter just adds a new line\r\n              sendMessage()\r\n            }\r\n          }\r\n        },\r\n        false\r\n      )\r\n\r\n      rhs.innerHTML = ''\r\n      sendButton = UI.widgets.button(\r\n        dom,\r\n        UI.icons.iconBase + 'noun_383448.svg',\r\n        'Send'\r\n      )\r\n      sendButton.setAttribute('style', UI.style.buttonStyle + 'float: right;')\r\n      sendButton.addEventListener('click', sendMessage, false)\r\n      rhs.appendChild(sendButton)\r\n    }\r\n\r\n    const context = { div: middle, dom: dom }\r\n    UI.authn.logIn(context).then(context => {\r\n      me = context.me\r\n      turnOnInput()\r\n    })\r\n\r\n    return form\r\n  }\r\n\r\n  function nick (person) {\r\n    var s = UI.store.any(person, UI.ns.foaf('nick'))\r\n    if (s) return '' + s.value\r\n    return '' + utils.label(person)\r\n  }\r\n\r\n  function creatorAndDate (td1, creator, date, message) {\r\n    var nickAnchor = td1.appendChild(anchor(nick(creator), creator))\r\n    if (creator.uri) {\r\n      UI.store.fetcher.nowOrWhenFetched(creator.doc(), undefined, function (\r\n        _ok,\r\n        _body\r\n      ) {\r\n        nickAnchor.textContent = nick(creator)\r\n      })\r\n    }\r\n    td1.appendChild(dom.createElement('br'))\r\n    td1.appendChild(anchor(date, message))\r\n  }\r\n\r\n  // ///////////////////////////////////////////////////////////////////////\r\n\r\n  function syncMessages (about, messageTable) {\r\n    var displayed = {}\r\n    var ele, ele2\r\n    for (ele = messageTable.firstChild; ele; ele = ele.nextSibling) {\r\n      if (ele.AJAR_subject) {\r\n        displayed[ele.AJAR_subject.uri] = true\r\n      }\r\n    }\r\n    var messages = kb.each(about, ns.wf('message'))\r\n    var stored = {}\r\n    messages.map(function (m) {\r\n      stored[m.uri] = true\r\n      if (!displayed[m.uri]) {\r\n        addMessage(m)\r\n      }\r\n    })\r\n\r\n    // eslint-disable-next-line space-in-parens\r\n    for (ele = messageTable.firstChild; ele; ) {\r\n      ele2 = ele.nextSibling\r\n      if (ele.AJAR_subject && !stored[ele.AJAR_subject.uri]) {\r\n        messageTable.removeChild(ele)\r\n      }\r\n      ele = ele2\r\n    }\r\n  }\r\n\r\n  var deleteMessage = function (message) {\r\n    var deletions = kb\r\n      .statementsMatching(message)\r\n      .concat(kb.statementsMatching(undefined, undefined, message))\r\n    updater.update(deletions, [], function (uri, ok, body) {\r\n      if (!ok) {\r\n        announce.error('Cant delete messages:' + body)\r\n      } else {\r\n        syncMessages(subject, messageTable)\r\n      }\r\n    })\r\n  }\r\n\r\n  var addMessage = function (message) {\r\n    var bindings = {\r\n      '?msg': message,\r\n      '?creator': kb.any(message, ns.foaf('maker')),\r\n      '?date': kb.any(message, DCT('created')),\r\n      '?content': kb.any(message, ns.sioc('content'))\r\n    }\r\n    renderMessage(bindings, true) // fresh from elsewhere\r\n  }\r\n\r\n  var renderMessage = function (bindings, fresh) {\r\n    var creator = bindings['?creator']\r\n    var message = bindings['?msg']\r\n    var date = bindings['?date']\r\n    var content = bindings['?content']\r\n\r\n    var dateString = date.value\r\n    var tr = dom.createElement('tr')\r\n    tr.AJAR_date = dateString\r\n    tr.AJAR_subject = message\r\n\r\n    var done = false\r\n    for (var ele = messageTable.firstChild; ; ele = ele.nextSibling) {\r\n      if (!ele) {\r\n        // empty\r\n        break\r\n      }\r\n      if (\r\n        (dateString > ele.AJAR_date && newestFirst) ||\r\n        (dateString < ele.AJAR_date && !newestFirst)\r\n      ) {\r\n        messageTable.insertBefore(tr, ele)\r\n        done = true\r\n        break\r\n      }\r\n    }\r\n    if (!done) {\r\n      messageTable.appendChild(tr)\r\n    }\r\n\r\n    var td1 = dom.createElement('td')\r\n    tr.appendChild(td1)\r\n    creatorAndDate(td1, creator, UI.widgets.shortDate(dateString), message)\r\n\r\n    var td2 = dom.createElement('td')\r\n    tr.appendChild(td2)\r\n    var pre = dom.createElement('p')\r\n    pre.setAttribute(\r\n      'style',\r\n      messageBodyStyle +\r\n        (fresh ? 'background-color: #e8ffe8;' : 'background-color: #white;')\r\n    )\r\n    td2.appendChild(pre)\r\n    pre.textContent = content.value\r\n\r\n    var td3 = dom.createElement('td')\r\n    tr.appendChild(td3)\r\n\r\n    var delButton = dom.createElement('button')\r\n    td3.appendChild(delButton)\r\n    delButton.textContent = '-'\r\n\r\n    tr.setAttribute('class', 'hoverControl') // See tabbedtab.css (sigh global CSS)\r\n    delButton.setAttribute('class', 'hoverControlHide')\r\n    delButton.setAttribute('style', 'color: red;')\r\n    delButton.addEventListener(\r\n      'click',\r\n      function (_event) {\r\n        td3.removeChild(delButton) // Ask -- are you sure?\r\n        var cancelButton = dom.createElement('button')\r\n        cancelButton.textContent = 'cancel'\r\n        td3.appendChild(cancelButton).addEventListener(\r\n          'click',\r\n          function (_event) {\r\n            td3.removeChild(sureButton)\r\n            td3.removeChild(cancelButton)\r\n            td3.appendChild(delButton)\r\n          },\r\n          false\r\n        )\r\n        var sureButton = dom.createElement('button')\r\n        sureButton.textContent = 'Delete message'\r\n        td3.appendChild(sureButton).addEventListener(\r\n          'click',\r\n          function (_event) {\r\n            td3.removeChild(sureButton)\r\n            td3.removeChild(cancelButton)\r\n            deleteMessage(message)\r\n          },\r\n          false\r\n        )\r\n      },\r\n      false\r\n    )\r\n  }\r\n\r\n  // Messages with date, author etc\r\n\r\n  messageTable = dom.createElement('table')\r\n  messageTable.fresh = false\r\n  div.appendChild(messageTable)\r\n  messageTable.setAttribute('style', 'width: 100%;') // fill that div!\r\n\r\n  var tr = newMessageForm()\r\n  if (newestFirst) {\r\n    messageTable.insertBefore(tr, messageTable.firstChild) // If newestFirst\r\n  } else {\r\n    messageTable.appendChild(tr) // not newestFirst\r\n  }\r\n\r\n  var query\r\n  // Do this with a live query to pull in messages from web\r\n  if (options.query) {\r\n    query = options.query\r\n  } else {\r\n    query = new $rdf.Query('Messages')\r\n    var v = {} // semicolon needed\r\n    var vs = ['msg', 'date', 'creator', 'content']\r\n    vs.map(function (x) {\r\n      query.vars.push((v[x] = $rdf.variable(x)))\r\n    })\r\n    query.pat.add(subject, WF('message'), v.msg)\r\n    query.pat.add(v.msg, ns.dct('created'), v.date)\r\n    query.pat.add(v.msg, ns.foaf('maker'), v.creator)\r\n    query.pat.add(v.msg, ns.sioc('content'), v.content)\r\n  }\r\n  function doneQuery () {\r\n    messageTable.fresh = true // any new are fresh and so will be greenish\r\n  }\r\n  kb.query(query, renderMessage, undefined, doneQuery)\r\n  div.refresh = function () {\r\n    syncMessages(subject, messageTable)\r\n  }\r\n  // syncMessages(subject, messageTable) // no the query will do this async\r\n  return div\r\n}\r\n"],"file":"messageArea.js"}