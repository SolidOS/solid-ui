{"version":3,"sources":["../../src/widgets/forms.js"],"names":["module","exports","forms","field","UI","icons","require","log","ns","store","style","widgets","$rdf","error","buttons","utils","checkMarkCharacter","cancelCharacter","dashCharacter","ui","uri","dom","container","already","subject","form","callbackFunction","kb","box","createElement","setAttribute","formBorderColor","appendChild","key","toNT","createTextNode","plist","st","owl","outlineManager","appendPropertyTRs","already2","x","parts","any","p2","elements","each","sortBySequence","errorMessageBlock","eles","original","i","length","t","mostSpecificClassURI","dep","fn","fieldFunction","itemChanged","ok","body","j","newOne","removeChild","insertBefore","push","dependingOn","rdf","cases","values","sameTerm","findTypeURIs","value","undefined","c","tests","the","appendForm","debugString","map","toString","slice","join","addItem","object","newThing","ordered","createListIfNecessary","list","saveListThenRefresh","toBeInserted","property","updater","update","msg","console","refresh","renderItem","deleteThisItem","splice","holds","del","message","subField","moveThisItem","event","upwards","alert","itemDone","linkDone","debug","element","editable","deleteButtonWithCheck","label","button","iconBase","plusIconURI","UpdateManager","orderedNode","Node","toJS","min","tail","padding","img","title","prompt","textContent","addEventListener","_eventNotUsed","Collection","add","fetcher","putBack","vals","li","sort","syncTableToArrayReOrdered","asyncStuff","extra","then","err","fieldParams","size","type","dt","pattern","namedNode","uriPrefix","basicField","lhs","rhs","fieldLabel","params","textInputStyle","maxLength","fieldStore","obj","decodeURIComponent","replace","readonly","_e","match","disabled","ds","statementsMatching","result","sym","encodeURIComponent","Literal","trim","xsd","is","predicate","why","updateMany","callback","docs","forEach","includes","Error","doc","pop","is1","filter","is2","ds1","ds2","makeDescription","booleanField","tristate","errorBlock","lab","state","ins","buildCheckboxForm","category","checkOptions","makeSelectForNestedCategory","multiple","p","from","subForm","possible","possibleProperties","np","opts","nullLabel","disambiguate","findMembersNT","fromNT","rdfs","allClassURIs","propertyTriage","op","dp","addSubForm","possible2","sortByLabel","mint","selector","makeSelectForOptions","formHeadingColor","_store","_callbackFunction","contents","ft","bot","bottomTypeURIs","bots","b","fun","editFormButton","innerHTML","ff","parentNode","propertiesForClass","explicit","dc","foaf","members","used","findClosest","cla","prop","agenda","shift","lists","supers","formsFor","t1","bottom","candidates","concat","k","a","pair","toLowerCase","newButton","theClass","promptForNew","GotoSubject","formFunction","gotButton","insertMe","linkButton","info","f","rb","removeButton","AJAR_subject","group","sts","desc","rows","split","cols","multilineTextInputStyle","select","v","saveChange","submit","br","options","n","uris","sub","warn","getActual","actual","onChange","removeValue","opt","selected","AJAR_mint","newObject","mintClass","thisForm","mintStatementsFun","AJAR_uri","currentURI","sel","subSelect","superSelect","doneNew","children","option","labelWithOntology","backgroundColor","firstChild","makeSelectForCategory","du","subs","nullPrompt","child","tx","input","fix","Array","holdsAll","missing","displayState","negation","defa","boxHandler","toDelete","newState","toInsert","success","errorBody","hmmm","anchor","def","now","Date","getTime"],"mappings":"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","sourcesContent":["/*       F O R M S\r\n *\r\n *      A Vanilla Dom implementation of the form language\r\n */\r\n\r\n/* global alert */\r\n\r\nmodule.exports = {}\r\n\r\nvar forms = {}\r\n\r\nforms.field = {} // Form field functions by URI of field type.\r\n\r\nvar UI = {\r\n  icons: require('../iconBase'),\r\n  log: require('../log'),\r\n  ns: require('../ns'),\r\n  store: require('../store'),\r\n  style: require('../style'),\r\n  widgets: forms\r\n}\r\nconst $rdf = require('rdflib')\r\nconst error = require('./error')\r\nconst buttons = require('./buttons')\r\nconst ns = require('../ns')\r\nconst utils = require('../utils')\r\n\r\nconst checkMarkCharacter = '\\u2713'\r\nconst cancelCharacter = '\\u2715'\r\nconst dashCharacter = '-'\r\n\r\n// ///////////////////////////////////////////////////////////////////////\r\n\r\n/*                                  Form Field implementations\r\n **\r\n */\r\n/**          Group of different fields\r\n **\r\n **  One type of form field is an ordered Group of other fields.\r\n **  A Form is actually just the same as a group.\r\n **\r\n ** @param {Document} dom The HTML Document object aka Document Object Model\r\n ** @param {Element?} container  If present, the created widget will be appended to this\r\n ** @param {Map} already A hash table of (form, subject) kept to prevent recursive forms looping\r\n ** @param {Node} subject The thing about which the form displays/edits data\r\n ** @param {Node} form The form or field to be rendered\r\n ** @param {Node} store The web document in which the data is\r\n ** @param {function(ok, errorMessage)} callbackFunction Called when data is changed?\r\n **\r\n ** @returns {Element} The HTML widget created\r\n */\r\nforms.field[ns.ui('Form').uri] = forms.field[\r\n  ns.ui('Group').uri\r\n] = function (dom, container, already, subject, form, store, callbackFunction) {\r\n  const kb = UI.store\r\n  var box = dom.createElement('div')\r\n  box.setAttribute('style', `padding-left: 2em; border: 0.05em solid ${UI.style.formBorderColor};`) // Indent a group\r\n  const ui = UI.ns.ui\r\n  if (container) container.appendChild(box)\r\n\r\n  // Prevent loops\r\n  var key = subject.toNT() + '|' + form.toNT()\r\n  if (already[key]) {\r\n    // been there done that\r\n    box.appendChild(dom.createTextNode('Group: see above ' + key))\r\n    var plist = [$rdf.st(subject, ns.owl('sameAs'), subject)] // @@ need prev subject\r\n    dom.outlineManager.appendPropertyTRs(box, plist)\r\n    return box\r\n  }\r\n  // box.appendChild(dom.createTextNode('Group: first time, key: '+key))\r\n  var already2 = {}\r\n  for (var x in already) already2[x] = 1\r\n  already2[key] = 1\r\n\r\n  var parts = kb.any(form, ui('parts'))\r\n  var p2\r\n  if (parts) {\r\n    p2 = parts.elements\r\n  } else {\r\n    parts = kb.each(form, ui('part')) //  Warning: unordered\r\n    p2 = forms.sortBySequence(parts)\r\n  }\r\n  if (!parts) {\r\n    box.appendChild(error.errorMessageBlock(dom, 'No parts to form! '))\r\n    return dom\r\n  }\r\n  var eles = []\r\n  var original = []\r\n  for (var i = 0; i < p2.length; i++) {\r\n    var field = p2[i]\r\n    var t = forms.mostSpecificClassURI(field) // Field type\r\n    if (t === ui('Options').uri) {\r\n      var dep = kb.any(field, ui('dependingOn'))\r\n      if (dep && kb.any(subject, dep)) original[i] = kb.any(subject, dep).toNT()\r\n    }\r\n\r\n    var fn = forms.fieldFunction(dom, field)\r\n\r\n    var itemChanged = function (ok, body) {\r\n      if (ok) {\r\n        for (var j = 0; j < p2.length; j++) {\r\n          // This is really messy.\r\n          var field = p2[j]\r\n          var t = forms.mostSpecificClassURI(field) // Field type\r\n          if (t === ui('Options').uri) {\r\n            var dep = kb.any(field, ui('dependingOn'))\r\n            var newOne = fn(\r\n              dom,\r\n              box,\r\n              already,\r\n              subject,\r\n              field,\r\n              store,\r\n              callbackFunction\r\n            )\r\n            box.removeChild(newOne)\r\n            box.insertBefore(newOne, eles[j])\r\n            box.removeChild(eles[j])\r\n            original[j] = kb.any(subject, dep).toNT()\r\n            eles[j] = newOne\r\n          }\r\n        }\r\n      }\r\n      callbackFunction(ok, body)\r\n    }\r\n    eles.push(fn(dom, box, already2, subject, field, store, itemChanged))\r\n  }\r\n  return box\r\n}\r\n\r\n/**          Options field: Select one or more cases\r\n **\r\n ** @param {Document} dom The HTML Document object aka Document Object Model\r\n ** @param {Element?} container  If present, the created widget will be appended to this\r\n ** @param {Map} already A hash table of (form, subject) kept to prevent recursive forms looping\r\n ** @param {Node} subject The thing about which the form displays/edits data\r\n ** @param {Node} form The form or field to be rendered\r\n ** @param {Node} store The web document in which the data is\r\n ** @param {function(ok, errorMessage)} callbackFunction Called when data is changed?\r\n **\r\n ** @returns {Element} The HTML widget created\r\n */\r\n\r\nforms.field[ns.ui('Options').uri] = function (\r\n  dom,\r\n  container,\r\n  already,\r\n  subject,\r\n  form,\r\n  store,\r\n  callbackFunction\r\n) {\r\n  const kb = UI.store\r\n  var box = dom.createElement('div')\r\n  // box.setAttribute('style', 'padding-left: 2em; border: 0.05em dotted purple;')  // Indent Options\r\n  const ui = UI.ns.ui\r\n  if (container) container.appendChild(box)\r\n\r\n  var dependingOn = kb.any(form, ui('dependingOn'))\r\n  if (!dependingOn) {\r\n    dependingOn = ns.rdf('type')\r\n  } // @@ default to type (do we want defaults?)\r\n  var cases = kb.each(form, ui('case'))\r\n  if (!cases) {\r\n    box.appendChild(error.errorMessageBlock(dom, 'No cases to Options form. '))\r\n  }\r\n  var values\r\n  if (dependingOn.sameTerm(ns.rdf('type'))) {\r\n    values = kb.findTypeURIs(subject)\r\n  } else {\r\n    var value = kb.any(subject, dependingOn)\r\n    if (value === undefined) {\r\n      box.appendChild(\r\n        error.errorMessageBlock(\r\n          dom,\r\n          \"Can't select subform as no value of: \" + dependingOn\r\n        )\r\n      )\r\n    } else {\r\n      values = {}\r\n      values[value.uri] = true\r\n    }\r\n  }\r\n  // @@ Add box.refresh() to sync fields with values\r\n  for (var i = 0; i < cases.length; i++) {\r\n    var c = cases[i]\r\n    var tests = kb.each(c, ui('for')) // There can be multiple 'for'\r\n    for (var j = 0; j < tests.length; j++) {\r\n      if (values[tests[j].uri]) {\r\n        var field = kb.the(c, ui('use'))\r\n        if (!field) {\r\n          box.appendChild(\r\n            error.errorMessageBlock(\r\n              dom,\r\n              'No \"use\" part for case in form ' + form\r\n            )\r\n          )\r\n          return box\r\n        } else {\r\n          forms.appendForm(\r\n            dom,\r\n            box,\r\n            already,\r\n            subject,\r\n            field,\r\n            store,\r\n            callbackFunction\r\n          )\r\n        }\r\n        break\r\n      }\r\n    }\r\n  }\r\n  return box\r\n}\r\n\r\n/**          Multiple field: zero or more similar subFields\r\n **\r\n ** @param {Document} dom The HTML Document object aka Document Object Model\r\n ** @param {Element?} container  If present, the created widget will be appended to this\r\n ** @param {Map} already A hash table of (form, subject) kept to prevent recursive forms looping\r\n ** @param {Node} subject The thing about which the form displays/edits data\r\n ** @param {Node} form The form or field to be rendered\r\n ** @param {Node} store The web document in which the data is\r\n ** @param {function(ok, errorMessage)} callbackFunction Called when data is changed?\r\n **\r\n ** @returns {Element} The HTML widget created\r\n */\r\nforms.field[ns.ui('Multiple').uri] = function (\r\n  dom,\r\n  container,\r\n  already,\r\n  subject,\r\n  form,\r\n  store,\r\n  callbackFunction\r\n) {\r\n  /** Diagnostic function\r\n  */\r\n  function debugString (values) {\r\n    return values.map(x => x.toString().slice(-7)).join(', ')\r\n  }\r\n\r\n  /** Add an item to the local quadstore not the UI or the web\r\n  *\r\n   * @param {Node} object The RDF object to be represented by this item.\r\n   */\r\n  async function addItem (object) {\r\n    if (!object) object = forms.newThing(store) // by default just add new nodes\r\n    if (ordered) {\r\n      createListIfNecessary() // Sets list and unsavedList\r\n      list.elements.push(object)\r\n      await saveListThenRefresh()\r\n    } else {\r\n      const toBeInserted = [$rdf.st(subject, property, object, store)]\r\n      try {\r\n        await kb.updater.update([], toBeInserted)\r\n      } catch (err) {\r\n        const msg = 'Error adding to unordered multiple: ' + err\r\n        box.appendChild(error.errorMessageBlock(dom, msg))\r\n        console.error(msg)\r\n      }\r\n      refresh() // 20191213\r\n    }\r\n  }\r\n\r\n  /** Make a dom representation for an item\r\n   * @param {Event} anyEvent if used as an event handler\r\n   * @param {Node} object The RDF object to be represented by this item.\r\n   */\r\n  function renderItem (object) {\r\n    async function deleteThisItem () {\r\n      if (ordered) {\r\n        console.log('pre delete: ' + debugString(list.elements))\r\n        for (let i = 0; i < list.elements.length; i++) {\r\n          if (list.elements[i].sameTerm(object)) {\r\n            list.elements.splice(i, 1)\r\n            await saveListThenRefresh()\r\n            return\r\n          }\r\n        }\r\n      } else {\r\n        // unordered\r\n        if (kb.holds(subject, property, object)) {\r\n          var del = [$rdf.st(subject, property, object, store)]\r\n          kb.updater.update(del, [], function (uri, ok, message) {\r\n            if (ok) {\r\n              body.removeChild(subField)\r\n            } else {\r\n              body.appendChild(\r\n                error.errorMessageBlock(\r\n                  dom,\r\n                  'Multiple: delete failed: ' + message\r\n                )\r\n              )\r\n            }\r\n          })\r\n        }\r\n      }\r\n    }\r\n\r\n    /** Move the object up or down in the ordered list\r\n     * @param {Event} anyEvent if used as an event handler\r\n     * @param {Boolean} upwards Move this up (true) or down (false).\r\n     */\r\n    async function moveThisItem (event, upwards) {\r\n      // @@ possibly, allow shift+click to do move to top or bottom?\r\n      console.log('pre move: ' + debugString(list.elements))\r\n      for (var i = 0; i < list.elements.length; i++) {\r\n        // Find object in array\r\n        if (list.elements[i].sameTerm(object)) {\r\n          break\r\n        }\r\n      }\r\n      if (i === list.elements.length) {\r\n        alert('list move: not found element for ' + object)\r\n      }\r\n      if (upwards) {\r\n        if (i === 0) {\r\n          alert('@@ boop - already at top   -temp message') // @@ make boop sound\r\n          return\r\n        }\r\n        list.elements.splice(i - 1, 2, list.elements[i], list.elements[i - 1])\r\n      } else {\r\n        // downwards\r\n        if (i === list.elements.length - 1) {\r\n          alert('@@ boop - already at bottom   -temp message') // @@ make boop sound\r\n          return\r\n        }\r\n        list.elements.splice(i, 2, list.elements[i + 1], list.elements[i])\r\n      }\r\n      await saveListThenRefresh()\r\n    }\r\n    /* A subField has been filled in\r\n    *\r\n    * One possibility is to not actually make the link to the thing until\r\n    * this callback happens to avoid widow links\r\n     */\r\n    function itemDone (uri, ok, message) {\r\n      console.log(`Item ${uri} done callback for item ${object.uri.slice(-7)}`)\r\n      if (!ok) { // when does this happen? errors typically deal with upstream\r\n        console.error('  Item done callback: Error: ' + message)\r\n      } else {\r\n        linkDone(uri, ok, message)\r\n      }\r\n      /*  Put this as a function and call it from only one place\r\n      var ins, del\r\n      // alert('Multiple: item calklback.' + uri)\r\n      if (ok) {\r\n        // @@@ Check IT hasnt alreday been written in\r\n        if (ordered) {\r\n          list = kb.any(subject, property, null, store)\r\n          if (!list) {\r\n            list = new $rdf.Collection([object])\r\n            ins = [$rdf.st(subject, property, list)] // Will this work?\r\n          } else {\r\n            const oldList = new $rdf.Collection(list.elments)\r\n            list.append(object)\r\n            del = [$rdf.st(subject, property, oldList)] // If this doesn't work, kb.saveBack(store)\r\n            ins = [$rdf.st(subject, property, list)]\r\n          }\r\n        } else {\r\n          if (!kb.holds(subject, property, object, store)) {\r\n            ins = [$rdf.st(subject, property, object, store)]\r\n          }\r\n          kb.updater.update(del, ins, linkDone)\r\n        }\r\n      } else {\r\n        box.appendChild(\r\n          error.errorMessageBlock(dom, 'Multiple: item failed: ' + body)\r\n        )\r\n        callbackFunction(ok, message)\r\n      }\r\n      */\r\n    }\r\n    var linkDone = function (uri, ok, message) {\r\n      return callbackFunction(ok, message)\r\n    }\r\n\r\n    // if (!object) object = forms.newThing(store)\r\n    UI.log.debug('Multiple: render object: ' + object)\r\n    // var tr = box.insertBefore(dom.createElement('tr'), tail)\r\n    // var ins = []\r\n    // var del = []\r\n\r\n    var fn = forms.fieldFunction(dom, element)\r\n    var subField = fn(dom, null, already, object, element, store, itemDone) // p2 was: body.  moving to not passing that\r\n    subField.subject = object // Keep a back pointer between the DOM array and the RDF objects\r\n\r\n    // delete button and move buttons\r\n    if (kb.updater.editable(store.uri)) {\r\n      buttons.deleteButtonWithCheck(dom, subField, utils.label(property),\r\n        deleteThisItem)\r\n      if (ordered) {\r\n        subField.appendChild(\r\n          buttons.button(\r\n            dom, UI.icons.iconBase + 'noun_1369237.svg', 'Move Up',\r\n            async event => moveThisItem(event, true))\r\n        )\r\n        subField.appendChild(\r\n          buttons.button(\r\n            dom, UI.icons.iconBase + 'noun_1369241.svg', 'Move Down',\r\n            async event => moveThisItem(event, false))\r\n        )\r\n      }\r\n    }\r\n    return subField // unused\r\n  } // renderItem\r\n\r\n  /// ///////// Body of form field implementation\r\n\r\n  var plusIconURI = UI.icons.iconBase + 'noun_19460_green.svg' // white plus in green circle\r\n\r\n  const kb = UI.store\r\n  kb.updater = kb.updater || new $rdf.UpdateManager(kb)\r\n  var box = dom.createElement('table')\r\n  // We don't indent multiple as it is a sort of a prefix of the next field and has contents of one.\r\n  // box.setAttribute('style', 'padding-left: 2em; border: 0.05em solid green;')  // Indent a multiple\r\n  const ui = UI.ns.ui\r\n  if (container) container.appendChild(box)\r\n\r\n  const orderedNode = kb.any(form, ui('ordered'))\r\n  const ordered = orderedNode ? $rdf.Node.toJS(orderedNode) : false\r\n\r\n  var property = kb.any(form, ui('property'))\r\n  if (!property) {\r\n    box.appendChild(\r\n      error.errorMessageBlock(dom, 'No property to multiple: ' + form)\r\n    ) // used for arcs in the data\r\n    return box\r\n  }\r\n  var min = kb.any(form, ui('min')) // This is the minimum number -- default 0\r\n  min = min ? 0 + min.value : 0\r\n  // var max = kb.any(form, ui('max')) // This is the minimum number\r\n  // max = max ? max.value : 99999999\r\n\r\n  var element = kb.any(form, ui('part')) // This is the form to use for each one\r\n  if (!element) {\r\n    box.appendChild(\r\n      error.errorMessageBlock(dom, 'No part to multiple: ' + form)\r\n    )\r\n    return box\r\n  }\r\n\r\n  var body = box.appendChild(dom.createElement('tr')) // 20191207\r\n  var list // The RDF collection which keeps the ordered version\r\n  var values // Initial values - an array.  Even when no list yet.\r\n\r\n  // var unsavedList = false // Flag that\r\n  if (ordered) {\r\n    list = kb.any(subject, property)\r\n    if (list) {\r\n      values = list.elements\r\n    } else {\r\n      // unsavedList = true\r\n      values = []\r\n    }\r\n  } else {\r\n    values = kb.each(subject, property)\r\n    list = null\r\n  }\r\n  // Add control on the bottom for adding more items\r\n  if (kb.updater.editable(store.uri)) {\r\n    var tail = box.appendChild(dom.createElement('tr'))\r\n    tail.style.padding = '0.5em'\r\n    var img = tail.appendChild(dom.createElement('img'))\r\n    img.setAttribute('src', plusIconURI) //  plus sign\r\n    img.setAttribute('style', 'margin: 0.2em; width: 1.5em; height:1.5em')\r\n    img.title = 'Click to add one or more ' + utils.label(property)\r\n    var prompt = tail.appendChild(dom.createElement('span'))\r\n    prompt.textContent =\r\n      (values.length === 0 ? 'Add one or more ' : 'Add more ') +\r\n      utils.label(property)\r\n    tail.addEventListener('click', async _eventNotUsed => {\r\n      await addItem()\r\n    }, true)\r\n  }\r\n\r\n  function createListIfNecessary () {\r\n    if (!list) {\r\n      list = new $rdf.Collection()\r\n      kb.add(subject, property, list, store)\r\n    }\r\n  }\r\n\r\n  async function saveListThenRefresh () {\r\n    console.log('save list: ' + debugString(list.elements)) // 20191214\r\n\r\n    createListIfNecessary()\r\n    try {\r\n      await kb.fetcher.putBack(store)\r\n    } catch (err) {\r\n      box.appendChild(\r\n        error.errorMessageBlock(dom, 'Error trying to put back a list: ' + err)\r\n      )\r\n      return\r\n    }\r\n    refresh()\r\n  }\r\n\r\n  function refresh () {\r\n    let vals\r\n    if (ordered) {\r\n      const li = kb.the(subject, property)\r\n      vals = li ? li.elements : []\r\n    } else {\r\n      vals = kb.each(subject, property)\r\n      vals.sort() // achieve consistency on each refresh\r\n    }\r\n    utils.syncTableToArrayReOrdered(body, vals, renderItem)\r\n  }\r\n  body.refresh = refresh // Allow live update\r\n  refresh()\r\n\r\n  async function asyncStuff () {\r\n    var extra = min - values.length\r\n    if (extra > 0) {\r\n      for (var j = 0; j < extra; j++) {\r\n        console.log('Adding extra: min ' + min)\r\n        await addItem() // Add blanks if less than minimum\r\n      }\r\n      await saveListThenRefresh()\r\n    }\r\n    // if (unsavedList) {\r\n    //     await saveListThenRefresh() // async\r\n    // }\r\n  }\r\n  asyncStuff().then(\r\n    () => { console.log(' Multiple render: async stuff ok') },\r\n    (err) => { console.error(' Multiple render: async stuff fails. #### ', err) }\r\n  ) // async\r\n\r\n  return box\r\n} // Multiple\r\n\r\n/*          Text field\r\n **\r\n */\r\n// For possible date popups see e.g. http://www.dynamicdrive.com/dynamicindex7/jasoncalendar.htm\r\n// or use HTML5: http://www.w3.org/TR/2011/WD-html-markup-20110113/input.date.html\r\n//\r\n\r\nforms.fieldParams = {}\r\n\r\nforms.fieldParams[ns.ui('ColorField').uri] = {\r\n  size: 9,\r\n  type: 'color',\r\n  dt: 'color'\r\n} // https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/color\r\nforms.fieldParams[\r\n  ns.ui('ColorField').uri\r\n].pattern = /^\\s*#[0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f]([0-9a-f][0-9a-f])?\\s*$/\r\n\r\nforms.fieldParams[ns.ui('DateField').uri] = {\r\n  size: 20,\r\n  type: 'date',\r\n  dt: 'date'\r\n}\r\nforms.fieldParams[\r\n  ns.ui('DateField').uri\r\n].pattern = /^\\s*[0-9][0-9][0-9][0-9](-[0-1]?[0-9]-[0-3]?[0-9])?Z?\\s*$/\r\n\r\nforms.fieldParams[ns.ui('DateTimeField').uri] = {\r\n  size: 20,\r\n  type: 'date',\r\n  dt: 'dateTime'\r\n}\r\nforms.fieldParams[\r\n  ns.ui('DateTimeField').uri\r\n].pattern = /^\\s*[0-9][0-9][0-9][0-9](-[0-1]?[0-9]-[0-3]?[0-9])?(T[0-2][0-9]:[0-5][0-9](:[0-5][0-9])?)?Z?\\s*$/\r\n\r\nforms.fieldParams[ns.ui('TimeField').uri] = {\r\n  size: 10,\r\n  type: 'time',\r\n  dt: 'time'\r\n}\r\nforms.fieldParams[\r\n  ns.ui('TimeField').uri\r\n].pattern = /^\\s*([0-2]?[0-9]:[0-5][0-9](:[0-5][0-9])?)\\s*$/\r\n\r\nforms.fieldParams[ns.ui('IntegerField').uri] = {\r\n  size: 12,\r\n  style: 'text-align: right',\r\n  dt: 'integer'\r\n}\r\nforms.fieldParams[ns.ui('IntegerField').uri].pattern = /^\\s*-?[0-9]+\\s*$/\r\n\r\nforms.fieldParams[ns.ui('DecimalField').uri] = {\r\n  size: 12,\r\n  style: 'text-align: right',\r\n  dt: 'decimal'\r\n}\r\nforms.fieldParams[\r\n  ns.ui('DecimalField').uri\r\n].pattern = /^\\s*-?[0-9]*(\\.[0-9]*)?\\s*$/\r\n\r\nforms.fieldParams[ns.ui('FloatField').uri] = {\r\n  size: 12,\r\n  style: 'text-align: right',\r\n  dt: 'float'\r\n}\r\nforms.fieldParams[\r\n  ns.ui('FloatField').uri\r\n].pattern = /^\\s*-?[0-9]*(\\.[0-9]*)?((e|E)-?[0-9]*)?\\s*$/\r\n\r\nforms.fieldParams[ns.ui('SingleLineTextField').uri] = {}\r\nforms.fieldParams[ns.ui('NamedNodeURIField').uri] = { namedNode: true }\r\nforms.fieldParams[ns.ui('TextField').uri] = {}\r\n\r\nforms.fieldParams[ns.ui('PhoneField').uri] = { size: 20, uriPrefix: 'tel:' }\r\nforms.fieldParams[ns.ui('PhoneField').uri].pattern = /^\\+?[\\d-]+[\\d]*$/\r\n\r\nforms.fieldParams[ns.ui('EmailField').uri] = {\r\n  size: 30,\r\n  uriPrefix: 'mailto:'\r\n}\r\nforms.fieldParams[ns.ui('EmailField').uri].pattern = /^\\s*.*@.*\\..*\\s*$/ // @@ Get the right regexp here\r\n\r\n/** Render a basic form field\r\n *\r\n ** @param {Document} dom The HTML Document object aka Document Object Model\r\n ** @param {Element?} container  If present, the created widget will be appended to this\r\n ** @param {Map} already A hash table of (form, subject) kept to prevent recursive forms looping\r\n ** @param {Node} subject The thing about which the form displays/edits data\r\n ** @param {Node} form The form or field to be rendered\r\n ** @param {Node} store The web document in which the data is\r\n ** @param {function(ok, errorMessage)} callbackFunction Called when data is changed?\r\n **\r\n ** @returns {Element} The HTML widget created\r\n **\r\n ** The same function is used for many similar one-value fields, with different\r\n ** regexps used to validate.\r\n */\r\nfunction basicField (\r\n  dom,\r\n  container,\r\n  already,\r\n  subject,\r\n  form,\r\n  store,\r\n  callbackFunction\r\n) {\r\n  const ui = UI.ns.ui\r\n  const kb = UI.store\r\n\r\n  var box = dom.createElement('tr')\r\n  if (container) container.appendChild(box)\r\n  var lhs = dom.createElement('td')\r\n  lhs.setAttribute('class', 'formFieldName')\r\n  lhs.setAttribute('style', '  vertical-align: middle;')\r\n  box.appendChild(lhs)\r\n  var rhs = dom.createElement('td')\r\n  rhs.setAttribute('class', 'formFieldValue')\r\n  box.appendChild(rhs)\r\n\r\n  var property = kb.any(form, ui('property'))\r\n  if (!property) {\r\n    box.appendChild(\r\n      dom.createTextNode('Error: No property given for text field: ' + form)\r\n    )\r\n    return box\r\n  }\r\n  lhs.appendChild(forms.fieldLabel(dom, property, form))\r\n  var uri = forms.mostSpecificClassURI(form)\r\n  var params = forms.fieldParams[uri]\r\n  if (params === undefined) params = {} // non-bottom field types can do this\r\n  var style = params.style || UI.style.textInputStyle || 'font-size: 100%; margin: 0.1em; padding: 0.1em;'\r\n  // box.appendChild(dom.createTextNode(' uri='+uri+', pattern='+ params.pattern))\r\n  var field = dom.createElement('input')\r\n  field.style = UI.style.textInputStyle // Do we have to override length etc?\r\n  rhs.appendChild(field)\r\n  field.setAttribute('type', params.type ? params.type : 'text')\r\n\r\n  var size = kb.any(form, ui('size')) // Form has precedence\r\n  field.setAttribute(\r\n    'size',\r\n    size ? '' + size : params.size ? '' + params.size : '20'\r\n  )\r\n  var maxLength = kb.any(form, ui('maxLength'))\r\n  field.setAttribute('maxLength', maxLength ? '' + maxLength : '4096')\r\n\r\n  store = store || forms.fieldStore(subject, property, store)\r\n\r\n  var obj = kb.any(subject, property, undefined, store)\r\n  if (!obj) {\r\n    obj = kb.any(form, ui('default'))\r\n  }\r\n  if (obj && obj.uri && params.uriPrefix) {\r\n    // eg tel: or mailto:\r\n    field.value = decodeURIComponent(obj.uri.replace(params.uriPrefix, '')) // should have no spaces but in case\r\n      .replace(/ /g, '')\r\n  } else if (obj) {\r\n    field.value = obj.value || obj.uri || ''\r\n  }\r\n  field.setAttribute('style', style)\r\n\r\n  if (!kb.updater.editable(store.uri)) {\r\n    field.readonly = true // was: disabled. readonly is better\r\n    return box\r\n  }\r\n\r\n  // read-write:\r\n  field.addEventListener(\r\n    'keyup',\r\n    function (_e) {\r\n      if (params.pattern) {\r\n        field.setAttribute(\r\n          'style',\r\n          style +\r\n            (field.value.match(params.pattern)\r\n              ? 'color: green;'\r\n              : 'color: red;')\r\n        )\r\n      }\r\n    },\r\n    true\r\n  )\r\n  field.addEventListener(\r\n    'change',\r\n    function (_e) {\r\n      // i.e. lose focus with changed data\r\n      if (params.pattern && !field.value.match(params.pattern)) return\r\n      field.disabled = true // See if this stops getting two dates from fumbling e.g the chrome datepicker.\r\n      field.setAttribute('style', style + 'color: gray;') // pending\r\n      var ds = kb.statementsMatching(subject, property) // remove any multiple values\r\n      var result\r\n      if (params.namedNode) {\r\n        result = kb.sym(field.value)\r\n      } else if (params.uriPrefix) {\r\n        result = encodeURIComponent(field.value.replace(/ /g, ''))\r\n        result = kb.sym(params.uriPrefix + field.value)\r\n      } else {\r\n        if (params.dt) {\r\n          result = new $rdf.Literal(\r\n            field.value.trim(),\r\n            undefined,\r\n            ns.xsd(params.dt)\r\n          )\r\n        } else {\r\n          result = new $rdf.Literal(field.value)\r\n        }\r\n      }\r\n      var is = ds.map(st => $rdf.st(st.subject, st.predicate, result, st.why)) // can include >1 doc\r\n      if (is.length === 0) {\r\n        // or none\r\n        is = [$rdf.st(subject, property, result, store)]\r\n      }\r\n\r\n      function updateMany (ds, is, callback) {\r\n        var docs = []\r\n        is.forEach(st => {\r\n          if (!docs.includes(st.why.uri)) docs.push(st.why.uri)\r\n        })\r\n        ds.forEach(st => {\r\n          if (!docs.includes(st.why.uri)) docs.push(st.why.uri)\r\n        })\r\n        if (docs.length === 0) {\r\n          throw new Error('updateMany has no docs to patch')\r\n        }\r\n        if (docs.length === 1) {\r\n          return kb.updater.update(ds, is, callback)\r\n        }\r\n        // return kb.updater.update(ds, is, callback)\r\n\r\n        const doc = docs.pop()\r\n        const is1 = is.filter(st => st.why.uri === doc)\r\n        const is2 = is.filter(st => st.why.uri !== doc)\r\n        const ds1 = ds.filter(st => st.why.uri === doc)\r\n        const ds2 = ds.filter(st => st.why.uri !== doc)\r\n        kb.updater.update(ds1, is1, function (uri, ok, body) {\r\n          if (ok) {\r\n            updateMany(ds2, is2, callback)\r\n          } else {\r\n            console.log('Update many failed on: ' + doc)\r\n            callback(uri, ok, body)\r\n          }\r\n        })\r\n      }\r\n\r\n      updateMany(ds, is, function (uri, ok, body) {\r\n        // kb.updater.update(ds, is, function (uri, ok, body) {\r\n        if (ok) {\r\n          field.disabled = false\r\n          field.setAttribute('style', style)\r\n        } else {\r\n          box.appendChild(error.errorMessageBlock(dom, body))\r\n        }\r\n        callbackFunction(ok, body)\r\n      })\r\n    },\r\n    true\r\n  )\r\n  return box\r\n}\r\n\r\nforms.field[ns.ui('PhoneField').uri] = basicField\r\nforms.field[ns.ui('EmailField').uri] = basicField\r\nforms.field[ns.ui('ColorField').uri] = basicField\r\nforms.field[ns.ui('DateField').uri] = basicField\r\nforms.field[ns.ui('DateTimeField').uri] = basicField\r\nforms.field[ns.ui('TimeField').uri] = basicField\r\nforms.field[ns.ui('NumericField').uri] = basicField\r\nforms.field[ns.ui('IntegerField').uri] = basicField\r\nforms.field[ns.ui('DecimalField').uri] = basicField\r\nforms.field[ns.ui('FloatField').uri] = basicField\r\nforms.field[ns.ui('TextField').uri] = basicField\r\nforms.field[ns.ui('SingleLineTextField').uri] = basicField\r\nforms.field[ns.ui('NamedNodeURIField').uri] = basicField\r\n\r\n/*          Multiline Text field\r\n **\r\n */\r\n\r\nforms.field[ns.ui('MultiLineTextField').uri] = function (\r\n  dom,\r\n  container,\r\n  already,\r\n  subject,\r\n  form,\r\n  store,\r\n  callbackFunction\r\n) {\r\n  const ui = UI.ns.ui\r\n  const kb = UI.store\r\n  var property = kb.any(form, ui('property'))\r\n  if (!property) {\r\n    return error.errorMessageBlock(dom, 'No property to text field: ' + form)\r\n  }\r\n  const box = dom.createElement('div')\r\n  box.appendChild(forms.fieldLabel(dom, property, form))\r\n  store = forms.fieldStore(subject, property, store)\r\n  var field = forms.makeDescription(\r\n    dom,\r\n    kb,\r\n    subject,\r\n    property,\r\n    store,\r\n    callbackFunction\r\n  )\r\n  // box.appendChild(dom.createTextNode('<-@@ subj:'+subject+', prop:'+property))\r\n  box.appendChild(field)\r\n  if (container) container.appendChild(box)\r\n  return box\r\n}\r\n\r\n/*          Boolean field  and Tri-state version (true/false/null)\r\n **\r\n ** @@ todo: remove tristate param\r\n */\r\nfunction booleanField (\r\n  dom,\r\n  container,\r\n  already,\r\n  subject,\r\n  form,\r\n  store,\r\n  callbackFunction,\r\n  tristate\r\n) {\r\n  const ui = UI.ns.ui\r\n  const kb = UI.store\r\n  var property = kb.any(form, ui('property'))\r\n  if (!property) {\r\n    const errorBlock = error.errorMessageBlock(\r\n      dom,\r\n      'No property to boolean field: ' + form\r\n    )\r\n    if (container) container.appendChild(errorBlock)\r\n    return errorBlock\r\n  }\r\n  var lab = kb.any(form, ui('label'))\r\n  if (!lab) lab = utils.label(property, true) // Init capital\r\n  store = forms.fieldStore(subject, property, store)\r\n  var state = kb.any(subject, property)\r\n  if (state === undefined) {\r\n    state = false\r\n  } // @@ sure we want that -- or three-state?\r\n  // UI.log.debug('store is '+store)\r\n  var ins = $rdf.st(subject, property, true, store)\r\n  var del = $rdf.st(subject, property, false, store)\r\n  var box = buildCheckboxForm(dom, kb, lab, del, ins, form, store, tristate)\r\n  if (container) container.appendChild(box)\r\n  return box\r\n}\r\nforms.field[ns.ui('BooleanField').uri] = function (\r\n  dom,\r\n  container,\r\n  already,\r\n  subject,\r\n  form,\r\n  store,\r\n  callbackFunction\r\n) {\r\n  return booleanField(\r\n    dom,\r\n    container,\r\n    already,\r\n    subject,\r\n    form,\r\n    store,\r\n    callbackFunction,\r\n    false\r\n  )\r\n}\r\n\r\nforms.field[ns.ui('TristateField').uri] = function (\r\n  dom,\r\n  container,\r\n  already,\r\n  subject,\r\n  form,\r\n  store,\r\n  callbackFunction\r\n) {\r\n  return booleanField(\r\n    dom,\r\n    container,\r\n    already,\r\n    subject,\r\n    form,\r\n    store,\r\n    callbackFunction,\r\n    true\r\n  )\r\n}\r\n\r\n/*          Classifier field\r\n **\r\n **  Nested categories\r\n **\r\n ** @@ To do: If a classification changes, then change any dependent Options fields.\r\n */\r\n\r\nforms.field[ns.ui('Classifier').uri] = function (\r\n  dom,\r\n  container,\r\n  already,\r\n  subject,\r\n  form,\r\n  store,\r\n  callbackFunction\r\n) {\r\n  const kb = UI.store\r\n  const ui = UI.ns.ui\r\n  var category = kb.any(form, ui('category'))\r\n  if (!category) {\r\n    return error.errorMessageBlock(dom, 'No category for classifier: ' + form)\r\n  }\r\n  UI.log.debug('Classifier: store=' + store)\r\n  var checkOptions = function (ok, body) {\r\n    if (!ok) return callbackFunction(ok, body)\r\n\r\n    /*\r\n    var parent = kb.any(undefined, ui('part'), form)\r\n    if (!parent) return callbackFunction(ok, body)\r\n    var kids = kb.each(parent, ui('part')); // @@@@@@@@@ Garbage\r\n    kids = kids.filter(function(k){return kb.any(k, ns.rdf('type'), ui('Options'))})\r\n    if (kids.length) UI.log.debug('Yes, found related options: '+kids[0])\r\n    */\r\n    return callbackFunction(ok, body)\r\n  }\r\n  var box = forms.makeSelectForNestedCategory(\r\n    dom,\r\n    kb,\r\n    subject,\r\n    category,\r\n    store,\r\n    checkOptions\r\n  )\r\n  if (container) container.appendChild(box)\r\n  return box\r\n}\r\n\r\n/**         Choice field\r\n **\r\n **  Not nested.  Generates a link to something from a given class.\r\n **  Optional subform for the thing selected.\r\n **  Alternative implementatons caould be:\r\n ** -- pop-up menu (as here)\r\n ** -- radio buttons\r\n ** -- auto-complete typing\r\n **\r\n ** Todo: Deal with multiple.  Maybe merge with multiple code.\r\n */\r\n\r\nforms.field[ns.ui('Choice').uri] = function (\r\n  dom,\r\n  container,\r\n  already,\r\n  subject,\r\n  form,\r\n  store,\r\n  callbackFunction\r\n) {\r\n  var ns = UI.ns\r\n  const ui = UI.ns.ui\r\n  const kb = UI.store\r\n  var multiple = false\r\n  var p\r\n  var box = dom.createElement('tr')\r\n  if (container) container.appendChild(box)\r\n  var lhs = dom.createElement('td')\r\n  box.appendChild(lhs)\r\n  var rhs = dom.createElement('td')\r\n  box.appendChild(rhs)\r\n  var property = kb.any(form, ui('property'))\r\n  if (!property) {\r\n    return error.errorMessageBlock(dom, 'No property for Choice: ' + form)\r\n  }\r\n  lhs.appendChild(forms.fieldLabel(dom, property, form))\r\n  var from = kb.any(form, ui('from'))\r\n  if (!from) {\r\n    return error.errorMessageBlock(dom, \"No 'from' for Choice: \" + form)\r\n  }\r\n  var subForm = kb.any(form, ui('use')) // Optional\r\n  var possible = []\r\n  var possibleProperties\r\n  var np = '--' + utils.label(property) + '-?'\r\n  var opts = { multiple: multiple, nullLabel: np, disambiguate: false }\r\n  possible = kb.each(undefined, ns.rdf('type'), from)\r\n  for (var x in kb.findMembersNT(from)) {\r\n    possible.push(kb.fromNT(x))\r\n    // box.appendChild(dom.createTextNode(\"RDFS: adding \"+x))\r\n  } // Use rdfs\r\n  // UI.log.debug(\"%%% Choice field: possible.length 1 = \"+possible.length)\r\n  if (from.sameTerm(ns.rdfs('Class'))) {\r\n    for (p in buttons.allClassURIs()) possible.push(kb.sym(p))\r\n    // UI.log.debug(\"%%% Choice field: possible.length 2 = \"+possible.length)\r\n  } else if (from.sameTerm(ns.rdf('Property'))) {\r\n    possibleProperties = buttons.propertyTriage(kb)\r\n    for (p in possibleProperties.op) possible.push(kb.fromNT(p))\r\n    for (p in possibleProperties.dp) possible.push(kb.fromNT(p))\r\n    opts.disambiguate = true // This is a big class, and the labels won't be enough.\r\n  } else if (from.sameTerm(ns.owl('ObjectProperty'))) {\r\n    possibleProperties = buttons.propertyTriage(kb)\r\n    for (p in possibleProperties.op) possible.push(kb.fromNT(p))\r\n    opts.disambiguate = true\r\n  } else if (from.sameTerm(ns.owl('DatatypeProperty'))) {\r\n    possibleProperties = buttons.propertyTriage(kb)\r\n    for (p in possibleProperties.dp) possible.push(kb.fromNT(p))\r\n    opts.disambiguate = true\r\n  }\r\n  var object = kb.any(subject, property)\r\n  function addSubForm () {\r\n    object = kb.any(subject, property)\r\n    forms.fieldFunction(dom, subForm)(\r\n      dom,\r\n      rhs,\r\n      already,\r\n      object,\r\n      subForm,\r\n      store,\r\n      callbackFunction\r\n    )\r\n  }\r\n  // box.appendChild(dom.createTextNode('Choice: subForm='+subForm))\r\n  var possible2 = forms.sortByLabel(possible)\r\n  if (kb.any(form, ui('canMintNew'))) {\r\n    opts.mint = '* New *' // @@ could be better\r\n    opts.subForm = subForm\r\n  }\r\n  var selector = forms.makeSelectForOptions(\r\n    dom,\r\n    kb,\r\n    subject,\r\n    property,\r\n    possible2,\r\n    opts,\r\n    store,\r\n    callbackFunction\r\n  )\r\n  rhs.appendChild(selector)\r\n  if (object && subForm) addSubForm()\r\n  return box\r\n}\r\n\r\n//          Documentation - non-interactive fields\r\n//\r\n\r\nforms.fieldParams[ns.ui('Comment').uri] = {\r\n  element: 'p',\r\n  style: `padding: 0.1em 1.5em; color: ${UI.style.formHeadingColor}; white-space: pre-wrap;`\r\n}\r\nforms.fieldParams[ns.ui('Heading').uri] = {\r\n  element: 'h3',\r\n  style: `font-size: 110%; color: ${UI.style.formHeadingColor};`\r\n}\r\n\r\nforms.field[ns.ui('Comment').uri] = forms.field[\r\n  ns.ui('Heading').uri\r\n] = function (\r\n  dom,\r\n  container,\r\n  already,\r\n  subject,\r\n  form,\r\n  _store,\r\n  _callbackFunction\r\n) {\r\n  const ui = UI.ns.ui\r\n  const kb = UI.store\r\n  var contents = kb.any(form, ui('contents'))\r\n  if (!contents) contents = 'Error: No contents in comment field.'\r\n\r\n  var uri = forms.mostSpecificClassURI(form)\r\n  var params = forms.fieldParams[uri]\r\n  if (params === undefined) {\r\n    params = {}\r\n  } // non-bottom field types can do this\r\n\r\n  var box = dom.createElement('div')\r\n  if (container) container.appendChild(box)\r\n  var p = box.appendChild(dom.createElement(params.element))\r\n  p.textContent = contents\r\n\r\n  var style = kb.any(form, ui('style'))\r\n  if (style === undefined) {\r\n    style = params.style ? params.style : ''\r\n  }\r\n  if (style) p.setAttribute('style', style)\r\n\r\n  return box\r\n}\r\n\r\n/// ////////////// Form-related functions\r\n\r\n/** Which class of field is this?\r\n * @param x a field\r\n * @returns the URI of the most specific class\r\n */\r\n\r\nforms.mostSpecificClassURI = function (x) {\r\n  const kb = UI.store\r\n  var ft = kb.findTypeURIs(x)\r\n  var bot = kb.bottomTypeURIs(ft) // most specific\r\n  var bots = []\r\n  for (var b in bot) bots.push(b)\r\n  // if (bots.length > 1) throw \"Didn't expect \"+x+\" to have multiple bottom types: \"+bots\r\n  return bots[0]\r\n}\r\n\r\nforms.fieldFunction = function (dom, field) {\r\n  const uri = forms.mostSpecificClassURI(field) // What type\r\n  // const uri = field.uri\r\n  var fun = forms.field[uri]\r\n  UI.log.debug(\r\n    'paneUtils: Going to implement field ' + field + ' of type ' + uri\r\n  )\r\n  if (!fun) {\r\n    return function () {\r\n      return error.errorMessageBlock(\r\n        dom,\r\n        'No handler for field ' + field + ' of type ' + uri\r\n      )\r\n    }\r\n  }\r\n  return fun\r\n}\r\n\r\n// A button for editing a form (in place, at the moment)\r\n//\r\n//  When editing forms, make it yellow, when editing thr form form, pink\r\n// Help people understand how many levels down they are.\r\n//\r\nforms.editFormButton = function (\r\n  dom,\r\n  container,\r\n  form,\r\n  store,\r\n  callbackFunction\r\n) {\r\n  var b = dom.createElement('button')\r\n  b.setAttribute('type', 'button')\r\n  b.innerHTML = 'Edit ' + utils.label(ns.ui('Form'))\r\n  b.addEventListener(\r\n    'click',\r\n    function (_e) {\r\n      var ff = forms.appendForm(\r\n        dom,\r\n        container,\r\n        {},\r\n        form,\r\n        ns.ui('FormForm'),\r\n        store,\r\n        callbackFunction\r\n      )\r\n      ff.setAttribute(\r\n        'style',\r\n        ns.ui('FormForm').sameTerm(form)\r\n          ? 'background-color: #fee;'\r\n          : 'background-color: #ffffe7;'\r\n      )\r\n      b.parentNode.removeChild(b)\r\n    },\r\n    true\r\n  )\r\n  return b\r\n}\r\n\r\nforms.appendForm = function (\r\n  dom,\r\n  container,\r\n  already,\r\n  subject,\r\n  form,\r\n  store,\r\n  itemDone\r\n) {\r\n  return forms.fieldFunction(dom, form)(\r\n    dom,\r\n    container,\r\n    already,\r\n    subject,\r\n    form,\r\n    store,\r\n    itemDone\r\n  )\r\n}\r\n\r\n/**          Find list of properties for class\r\n//\r\n// Three possible sources: Those mentioned in schemas, which exludes many\r\n// those which occur in the data we already have, and those predicates we\r\n// have come across anywhere and which are not explicitly excluded from\r\n// being used with this class.\r\n*/\r\n\r\nforms.propertiesForClass = function (kb, c) {\r\n  var ns = UI.ns\r\n  var explicit = kb.each(undefined, ns.rdf('range'), c)\r\n  ;[\r\n    ns.rdfs('comment'),\r\n    ns.dc('title'), // Generic things\r\n    ns.foaf('name'),\r\n    ns.foaf('homepage')\r\n  ].map(function (x) {\r\n    explicit.push(x)\r\n  })\r\n  var members = kb.each(undefined, ns.rdf('type'), c)\r\n  if (members.length > 60) members = members.slice(0, 60) // Array supports slice?\r\n  var used = {}\r\n  for (var i = 0; i < (members.length > 60 ? 60 : members.length); i++) {\r\n    kb.statementsMatching(members[i], undefined, undefined).map(function (st) {\r\n      used[st.predicate.uri] = true\r\n    })\r\n  }\r\n  explicit.map(function (p) {\r\n    used[p.uri] = true\r\n  })\r\n  var result = []\r\n  for (var uri in used) {\r\n    result.push(kb.sym(uri))\r\n  }\r\n  return result\r\n}\r\n\r\n/** Find the closest class\r\n* @param kb The store\r\n* @param cla - the URI of the class\r\n* @param prop\r\n*/\r\nforms.findClosest = function findClosest (kb, cla, prop) {\r\n  var agenda = [kb.sym(cla)] // ordered - this is breadth first search\r\n  while (agenda.length > 0) {\r\n    var c = agenda.shift() // first\r\n    // if (c.uri && (c.uri == ns.owl('Thing').uri || c.uri == ns.rdf('Resource').uri )) continue\r\n    var lists = kb.each(c, prop)\r\n    UI.log.debug('Lists for ' + c + ', ' + prop + ': ' + lists.length)\r\n    if (lists.length !== 0) return lists\r\n    var supers = kb.each(c, ns.rdfs('subClassOf'))\r\n    for (var i = 0; i < supers.length; i++) {\r\n      agenda.push(supers[i])\r\n      UI.log.debug('findClosest: add super: ' + supers[i])\r\n    }\r\n  }\r\n  return []\r\n}\r\n\r\n// Which forms apply to a given existing subject?\r\n\r\nforms.formsFor = function (subject) {\r\n  var ns = UI.ns\r\n  const kb = UI.store\r\n\r\n  UI.log.debug('formsFor: subject=' + subject)\r\n  var t = kb.findTypeURIs(subject)\r\n  var t1\r\n  for (t1 in t) {\r\n    UI.log.debug('   type: ' + t1)\r\n  }\r\n  var bottom = kb.bottomTypeURIs(t) // most specific\r\n  var candidates = []\r\n  for (var b in bottom) {\r\n    // Find the most specific\r\n    UI.log.debug('candidatesFor: trying bottom type =' + b)\r\n    candidates = candidates.concat(\r\n      forms.findClosest(kb, b, ns.ui('creationForm'))\r\n    )\r\n    candidates = candidates.concat(\r\n      forms.findClosest(kb, b, ns.ui('annotationForm'))\r\n    )\r\n  }\r\n  return candidates\r\n}\r\n\r\nforms.sortBySequence = function (list) {\r\n  var p2 = list.map(function (p) {\r\n    var k = UI.store.any(p, ns.ui('sequence'))\r\n    return [k || 9999, p]\r\n  })\r\n  p2.sort(function (a, b) {\r\n    return a[0] - b[0]\r\n  })\r\n  return p2.map(function (pair) {\r\n    return pair[1]\r\n  })\r\n}\r\n\r\nforms.sortByLabel = function (list) {\r\n  var p2 = list.map(function (p) {\r\n    return [utils.label(p).toLowerCase(), p]\r\n  })\r\n  p2.sort()\r\n  return p2.map(function (pair) {\r\n    return pair[1]\r\n  })\r\n}\r\n\r\n/** Button to add a new whatever using a form\r\n//\r\n// @param form - optional form , else will look for one\r\n// @param store - optional store else will prompt for one (unimplemented)\r\n*/\r\nforms.newButton = function (\r\n  dom,\r\n  kb,\r\n  subject,\r\n  predicate,\r\n  theClass,\r\n  form,\r\n  store,\r\n  callbackFunction\r\n) {\r\n  var b = dom.createElement('button')\r\n  b.setAttribute('type', 'button')\r\n  b.innerHTML = 'New ' + utils.label(theClass)\r\n  b.addEventListener(\r\n    'click',\r\n    function (_e) {\r\n      b.parentNode.appendChild(\r\n        forms.promptForNew(\r\n          dom,\r\n          kb,\r\n          subject,\r\n          predicate,\r\n          theClass,\r\n          form,\r\n          store,\r\n          callbackFunction\r\n        )\r\n      )\r\n    },\r\n    false\r\n  )\r\n  return b\r\n}\r\n\r\n/**      Prompt for new object of a given class\r\n//\r\n// @param dom - the document DOM for the user interface\r\n// @param kb - the graph which is the knowledge base we are working with\r\n// @param subject - a term, Thing this should be linked to when made. Optional.\r\n// @param predicate - a term, the relationship for the subject link. Optional.\r\n// @param theClass - an RDFS class containng the object about which the new information is.\r\n// @param form  - the form to be used when a new one. null means please find one.\r\n// @param store - The web document being edited\r\n// @param callbackFunction - takes (boolean ok, string errorBody)\r\n// @returns a dom object with the form DOM\r\n*/\r\nforms.promptForNew = function (\r\n  dom,\r\n  kb,\r\n  subject,\r\n  predicate,\r\n  theClass,\r\n  form,\r\n  store,\r\n  callbackFunction\r\n) {\r\n  var ns = UI.ns\r\n  var box = dom.createElement('form')\r\n\r\n  if (!form) {\r\n    var lists = forms.findClosest(kb, theClass.uri, UI.ns.ui('creationForm'))\r\n    if (lists.length === 0) {\r\n      var p = box.appendChild(dom.createElement('p'))\r\n      p.textContent =\r\n        'I am sorry, you need to provide information about a ' +\r\n        utils.label(theClass) +\r\n        \" but I don't know enough information about those to ask you.\"\r\n      var b = box.appendChild(dom.createElement('button'))\r\n      b.setAttribute('type', 'button')\r\n      b.setAttribute('style', 'float: right;')\r\n      b.innerHTML = 'Goto ' + utils.label(theClass)\r\n      b.addEventListener(\r\n        'click',\r\n        function (_e) {\r\n          dom.outlineManager.GotoSubject(\r\n            theClass,\r\n            true,\r\n            undefined,\r\n            true,\r\n            undefined\r\n          )\r\n        },\r\n        false\r\n      )\r\n      return box\r\n    }\r\n    UI.log.debug('lists[0] is ' + lists[0])\r\n    form = lists[0] // Pick any one\r\n  }\r\n  UI.log.debug('form is ' + form)\r\n  box.setAttribute('style', `border: 0.05em solid ${UI.style.formBorderColor}; color: ${UI.style.formBorderColor}`) // @@color?\r\n  box.innerHTML = '<h3>New ' + utils.label(theClass) + '</h3>'\r\n\r\n  var formFunction = forms.fieldFunction(dom, form)\r\n  var object = forms.newThing(store)\r\n  var gotButton = false\r\n  var itemDone = function (ok, body) {\r\n    if (!ok) return callbackFunction(ok, body)\r\n    var insertMe = []\r\n    if (subject && !kb.holds(subject, predicate, object, store)) {\r\n      insertMe.push($rdf.st(subject, predicate, object, store))\r\n    }\r\n    if (subject && !kb.holds(object, ns.rdf('type'), theClass, store)) {\r\n      insertMe.push($rdf.st(object, ns.rdf('type'), theClass, store))\r\n    }\r\n    if (insertMe.length) {\r\n      UI.store.updater.update([], insertMe, linkDone)\r\n    } else {\r\n      callbackFunction(true, body)\r\n    }\r\n    if (!gotButton) {\r\n      gotButton = box.appendChild(forms.linkButton(dom, object))\r\n    }\r\n    // tabulator.outline.GotoSubject(object, true, undefined, true, undefined)\r\n  }\r\n  function linkDone (uri, ok, body) {\r\n    return callbackFunction(ok, body)\r\n  }\r\n  UI.log.info('paneUtils Object is ' + object)\r\n  var f = formFunction(dom, box, {}, object, form, store, itemDone)\r\n  var rb = forms.removeButton(dom, f)\r\n  rb.setAttribute('style', 'float: right;')\r\n  box.AJAR_subject = object\r\n  return box\r\n}\r\n\r\nforms.makeDescription = function (\r\n  dom,\r\n  kb,\r\n  subject,\r\n  predicate,\r\n  store,\r\n  callbackFunction\r\n) {\r\n  var group = dom.createElement('div')\r\n\r\n  var sts = kb.statementsMatching(subject, predicate, null, store) // Only one please\r\n  if (sts.length > 1) {\r\n    return error.errorMessageBlock(\r\n      dom,\r\n      'Should not be ' + sts.length + ' i.e. >1 ' + predicate + ' of ' + subject\r\n    )\r\n  }\r\n  var desc = sts.length ? sts[0].object.value : undefined\r\n\r\n  var field = dom.createElement('textarea')\r\n  group.appendChild(field)\r\n  field.rows = desc ? desc.split('\\n').length + 2 : 2\r\n  field.cols = 80\r\n  var style = UI.style.multilineTextInputStyle ||\r\n    'font-size:100%; white-space: pre-wrap; background-color: white;' +\r\n    ' border: 0.07em solid gray; padding: 1em 0.5em; margin: 1em 1em;'\r\n  field.setAttribute('style', style)\r\n  if (sts.length) {\r\n    field.value = desc\r\n  } else {\r\n    // Unless you can make the predicate label disappear with the first click then this is over-cute\r\n    // field.value = utils.label(predicate); // Was\"enter a description here\"\r\n    field.select() // Select it ready for user input -- doesn't work\r\n  }\r\n\r\n  group.refresh = function () {\r\n    var v = kb.any(subject, predicate, null, store)\r\n    if (v && v.value !== field.value) {\r\n      field.value = v.value // don't touch widget if no change\r\n      // @@ this is the place to color the field from the user who chanaged it\r\n    }\r\n  }\r\n  function saveChange (_e) {\r\n    submit.disabled = true\r\n    submit.setAttribute('style', 'visibility: hidden; float: right;') // Keep UI clean\r\n    field.disabled = true\r\n    field.setAttribute('style', style + 'color: gray;') // pending\r\n    var ds = kb.statementsMatching(subject, predicate, null, store)\r\n    var is = $rdf.st(subject, predicate, field.value, store)\r\n    UI.store.updater.update(ds, is, function (uri, ok, body) {\r\n      if (ok) {\r\n        field.setAttribute('style', style + 'color: black;')\r\n        field.disabled = false\r\n      } else {\r\n        group.appendChild(\r\n          error.errorMessageBlock(\r\n            dom,\r\n            'Error (while saving change to ' + store.uri + '): ' + body\r\n          )\r\n        )\r\n      }\r\n      if (callbackFunction) {\r\n        callbackFunction(ok, body)\r\n      }\r\n    })\r\n  }\r\n\r\n  var br = dom.createElement('br')\r\n  group.appendChild(br)\r\n\r\n  var editable = UI.store.updater.editable(store.uri)\r\n  if (editable) {\r\n    var submit = dom.createElement('input')\r\n    submit.setAttribute('type', 'submit')\r\n    submit.disabled = true // until the filled has been modified\r\n    submit.setAttribute('style', 'visibility: hidden; float: right;') // Keep UI clean\r\n    submit.value = 'Save ' + utils.label(predicate) // @@ I18n\r\n    group.appendChild(submit)\r\n\r\n    field.addEventListener(\r\n      'keyup',\r\n      function (_e) {\r\n        // Green means has been changed, not saved yet\r\n        field.setAttribute('style', style + 'color: green;')\r\n        if (submit) {\r\n          submit.disabled = false\r\n          submit.setAttribute('style', 'float: right;') // Remove visibility: hidden\r\n        }\r\n      },\r\n      true\r\n    )\r\n    field.addEventListener('change', saveChange, true)\r\n    submit.addEventListener('click', saveChange, false)\r\n  } else {\r\n    field.disabled = true\r\n  }\r\n  return group\r\n}\r\n\r\n/** Make SELECT element to select options\r\n//\r\n// @param subject - a term, the subject of the statement(s) being edited.\r\n// @param predicate - a term, the predicate of the statement(s) being edited\r\n// @param possible - a list of terms, the possible value the object can take\r\n// @param options.multiple - Boolean - Whether more than one at a time is allowed\r\n// @param options.nullLabel - a string to be displayed as the\r\n//                        option for none selected (for non multiple)\r\n// @param options.mint - User may create thing if this sent to the prompt string eg \"New foo\"\r\n// @param options.subForm - If mint, then the form to be used for minting the new thing\r\n// @param store - The web document being edited\r\n// @param callbackFunction - takes (boolean ok, string errorBody)\r\n*/\r\nforms.makeSelectForOptions = function (\r\n  dom,\r\n  kb,\r\n  subject,\r\n  predicate,\r\n  possible,\r\n  options,\r\n  store,\r\n  callbackFunction\r\n) {\r\n  UI.log.debug('Select list length now ' + possible.length)\r\n  var n = 0\r\n  var uris = {} // Count them\r\n  var editable = UI.store.updater.editable(store.uri)\r\n\r\n  for (var i = 0; i < possible.length; i++) {\r\n    var sub = possible[i] // @@ Maybe; make this so it works with blank nodes too\r\n    if (!sub.uri) console.warn(`makeSelectForOptions: option does not have an uri: ${sub}, with predicate: ${predicate}`)\r\n    if (!sub.uri || sub.uri in uris) continue\r\n    uris[sub.uri] = true\r\n    n++\r\n  } // uris is now the set of possible options\r\n  if (n === 0 && !options.mint) {\r\n    return error.errorMessageBlock(\r\n      dom,\r\n      \"Can't do selector with no options, subject= \" +\r\n        subject +\r\n        ' property = ' +\r\n        predicate +\r\n        '.'\r\n    )\r\n  }\r\n  UI.log.debug('makeSelectForOptions: store=' + store)\r\n\r\n  var getActual = function () {\r\n    actual = {}\r\n    if (predicate.sameTerm(ns.rdf('type'))) {\r\n      actual = kb.findTypeURIs(subject)\r\n    } else {\r\n      kb.each(subject, predicate, null, store).map(function (x) {\r\n        actual[x.uri] = true\r\n      })\r\n    }\r\n    return actual\r\n  }\r\n  var actual = getActual()\r\n\r\n  // var newObject = null\r\n\r\n  var onChange = function (_e) {\r\n    select.disabled = true // until data written back - gives user feedback too\r\n    var ds = []\r\n    var is = []\r\n    var removeValue = function (t) {\r\n      if (kb.holds(subject, predicate, t, store)) {\r\n        ds.push($rdf.st(subject, predicate, t, store))\r\n      }\r\n    }\r\n    for (var i = 0; i < select.options.length; i++) {\r\n      var opt = select.options[i]\r\n      if (opt.selected && opt.AJAR_mint) {\r\n        var newObject\r\n        if (options.mintClass) {\r\n          var thisForm = forms.promptForNew(\r\n            dom,\r\n            kb,\r\n            subject,\r\n            predicate,\r\n            options.mintClass,\r\n            null,\r\n            store,\r\n            function (ok, body) {\r\n              if (!ok) {\r\n                callbackFunction(ok, body) // @@ if ok, need some form of refresh of the select for the new thing\r\n              }\r\n            }\r\n          )\r\n          select.parentNode.appendChild(thisForm)\r\n          newObject = thisForm.AJAR_subject\r\n        } else {\r\n          newObject = forms.newThing(store)\r\n        }\r\n        is.push($rdf.st(subject, predicate, newObject, store))\r\n        if (options.mintStatementsFun) {\r\n          is = is.concat(options.mintStatementsFun(newObject))\r\n        }\r\n      }\r\n      if (!opt.AJAR_uri) continue // a prompt or mint\r\n      if (opt.selected && !(opt.AJAR_uri in actual)) {\r\n        // new class\r\n        is.push($rdf.st(subject, predicate, kb.sym(opt.AJAR_uri), store))\r\n      }\r\n      if (!opt.selected && opt.AJAR_uri in actual) {\r\n        // old class\r\n        removeValue(kb.sym(opt.AJAR_uri))\r\n        // ds.push($rdf.st(subject, predicate, kb.sym(opt.AJAR_uri), store ))\r\n      }\r\n      if (opt.selected) select.currentURI = opt.AJAR_uri\r\n    }\r\n    var sel = select.subSelect // All subclasses must also go\r\n    while (sel && sel.currentURI) {\r\n      removeValue(kb.sym(sel.currentURI))\r\n      sel = sel.subSelect\r\n    }\r\n    sel = select.superSelect // All superclasses are redundant\r\n    while (sel && sel.currentURI) {\r\n      removeValue(kb.sym(sel.currentURI))\r\n      sel = sel.superSelect\r\n    }\r\n    function doneNew (ok, body) {\r\n      callbackFunction(ok, body)\r\n    }\r\n    UI.log.info('selectForOptions: stote = ' + store)\r\n    UI.store.updater.update(ds, is, function (uri, ok, body) {\r\n      actual = getActual() // refresh\r\n      // kb.each(subject, predicate, null, store).map(function(x){actual[x.uri] = true})\r\n      if (ok) {\r\n        select.disabled = false // data written back\r\n        if (newObject) {\r\n          var fn = forms.fieldFunction(dom, options.subForm)\r\n          fn(\r\n            dom,\r\n            select.parentNode,\r\n            {},\r\n            newObject,\r\n            options.subForm,\r\n            store,\r\n            doneNew\r\n          )\r\n        }\r\n      }\r\n      if (callbackFunction) callbackFunction(ok, body)\r\n    })\r\n  }\r\n\r\n  var select = dom.createElement('select')\r\n  select.setAttribute('style', 'margin: 0.6em 1.5em;')\r\n  if (options.multiple) select.setAttribute('multiple', 'true')\r\n  select.currentURI = null\r\n\r\n  select.refresh = function () {\r\n    actual = getActual() // refresh\r\n    for (var i = 0; i < select.children.length; i++) {\r\n      var option = select.children[i]\r\n      if (option.AJAR_uri) {\r\n        option.selected = option.AJAR_uri in actual\r\n      }\r\n    }\r\n    select.disabled = false // unlocked any conflict we had got into\r\n  }\r\n\r\n  for (var uri in uris) {\r\n    var c = kb.sym(uri)\r\n    var option = dom.createElement('option')\r\n    if (options.disambiguate) {\r\n      option.appendChild(dom.createTextNode(utils.labelWithOntology(c, true))) // Init. cap\r\n    } else {\r\n      option.appendChild(dom.createTextNode(utils.label(c, true))) // Init.\r\n    }\r\n    var backgroundColor = kb.any(\r\n      c,\r\n      kb.sym('http://www.w3.org/ns/ui#backgroundColor')\r\n    )\r\n    if (backgroundColor) {\r\n      option.setAttribute(\r\n        'style',\r\n        'background-color: ' + backgroundColor.value + '; '\r\n      )\r\n    }\r\n    option.AJAR_uri = uri\r\n    if (uri in actual) {\r\n      option.setAttribute('selected', 'true')\r\n      select.currentURI = uri\r\n      // dump(\"Already in class: \"+ uri+\"\\n\")\r\n    }\r\n    select.appendChild(option)\r\n  }\r\n  if (editable && options.mint) {\r\n    var mint = dom.createElement('option')\r\n    mint.appendChild(dom.createTextNode(options.mint))\r\n    mint.AJAR_mint = true // Flag it\r\n    select.insertBefore(mint, select.firstChild)\r\n  }\r\n  if (select.currentURI == null && !options.multiple) {\r\n    var prompt = dom.createElement('option')\r\n    prompt.appendChild(dom.createTextNode(options.nullLabel))\r\n    select.insertBefore(prompt, select.firstChild)\r\n    prompt.selected = true\r\n  }\r\n  if (editable) {\r\n    select.addEventListener('change', onChange, false)\r\n  }\r\n  return select\r\n} // makeSelectForOptions\r\n\r\n// Make SELECT element to select subclasses\r\n//\r\n// If there is any disjoint union it will so a mutually exclusive dropdown\r\n// Failing that it will do a multiple selection of subclasses.\r\n// Callback takes (boolean ok, string errorBody)\r\n\r\nforms.makeSelectForCategory = function (\r\n  dom,\r\n  kb,\r\n  subject,\r\n  category,\r\n  store,\r\n  callbackFunction\r\n) {\r\n  var log = UI.log\r\n  var du = kb.any(category, ns.owl('disjointUnionOf'))\r\n  var subs\r\n  var multiple = false\r\n  if (!du) {\r\n    subs = kb.each(undefined, ns.rdfs('subClassOf'), category)\r\n    multiple = true\r\n  } else {\r\n    subs = du.elements\r\n  }\r\n  log.debug('Select list length ' + subs.length)\r\n  if (subs.length === 0) {\r\n    return error.errorMessageBlock(\r\n      dom,\r\n      \"Can't do \" +\r\n        (multiple ? 'multiple ' : '') +\r\n        'selector with no subclasses of category: ' +\r\n        category\r\n    )\r\n  }\r\n  if (subs.length === 1) {\r\n    return error.errorMessageBlock(\r\n      dom,\r\n      \"Can't do \" +\r\n        (multiple ? 'multiple ' : '') +\r\n        'selector with only 1 subclass of category: ' +\r\n        category +\r\n        ':' +\r\n        subs[1]\r\n    )\r\n  }\r\n  return forms.makeSelectForOptions(\r\n    dom,\r\n    kb,\r\n    subject,\r\n    ns.rdf('type'),\r\n    subs,\r\n    { multiple: multiple, nullPrompt: '--classify--' },\r\n    store,\r\n    callbackFunction\r\n  )\r\n}\r\n\r\n/** Make SELECT element to select subclasses recurively\r\n//\r\n// It will so a mutually exclusive dropdown, with another if there are nested\r\n// disjoint unions.\r\n//\r\n// @param  callbackFunction takes (boolean ok, string errorBody)\r\n*/\r\nforms.makeSelectForNestedCategory = function (\r\n  dom,\r\n  kb,\r\n  subject,\r\n  category,\r\n  store,\r\n  callbackFunction\r\n) {\r\n  var container = dom.createElement('span') // Container\r\n  var child = null\r\n  var select\r\n  var onChange = function (ok, body) {\r\n    if (ok) update()\r\n    callbackFunction(ok, body)\r\n  }\r\n  select = forms.makeSelectForCategory(\r\n    dom,\r\n    kb,\r\n    subject,\r\n    category,\r\n    store,\r\n    onChange\r\n  )\r\n  container.appendChild(select)\r\n  var update = function () {\r\n    // UI.log.info(\"Selected is now: \"+select.currentURI)\r\n    if (child) {\r\n      container.removeChild(child)\r\n      child = null\r\n    }\r\n    if (\r\n      select.currentURI &&\r\n      kb.any(kb.sym(select.currentURI), ns.owl('disjointUnionOf'))\r\n    ) {\r\n      child = forms.makeSelectForNestedCategory(\r\n        dom,\r\n        kb,\r\n        subject,\r\n        kb.sym(select.currentURI),\r\n        store,\r\n        callbackFunction\r\n      )\r\n      select.subSelect = child.firstChild\r\n      select.subSelect.superSelect = select\r\n      container.appendChild(child)\r\n    }\r\n  }\r\n  update()\r\n  return container\r\n}\r\n\r\n/*  Build a checkbox from a given statement(s)\r\n **\r\n **  If the source document is editable, make the checkbox editable\r\n **\r\n **  ins and sel are either statements *or arrays of statements* which should be\r\n **  made if the checkbox is checed and unchecked respectively.\r\n **  tristate: Allow ins, or del, or neither\r\n */\r\nfunction buildCheckboxForm (dom, kb, lab, del, ins, form, store, tristate) {\r\n  // 20190115\r\n  var box = dom.createElement('div')\r\n  var tx = dom.createTextNode(lab)\r\n  var editable = UI.store.updater.editable(store.uri)\r\n  tx.style =\r\n    'colour: black; font-size: 100%; padding-left: 0.5 em; padding-right: 0.5 em;'\r\n  box.appendChild(tx)\r\n  var input\r\n  input = dom.createElement('button')\r\n\r\n  input.setAttribute(\r\n    'style',\r\n    'font-size: 150%; height: 1.2em; width: 1.2em; background-color: #eef; margin: 0.1em'\r\n  )\r\n  box.appendChild(input)\r\n\r\n  function fix (x) {\r\n    if (!x) return [] // no statements\r\n    if (x.object) {\r\n      if (!x.why) {\r\n        x.why = store // be back-compaitible  with old code\r\n      }\r\n      return [x] // one statements\r\n    }\r\n    if (x instanceof Array) return x\r\n    throw new Error('buildCheckboxForm: bad param ' + x)\r\n  }\r\n  ins = fix(ins)\r\n  del = fix(del)\r\n\r\n  function holdsAll (a) {\r\n    const missing = a.filter(\r\n      st => !kb.holds(st.subject, st.predicate, st.object, st.why)\r\n    )\r\n    return missing.length === 0\r\n  }\r\n  function refresh () {\r\n    var state = holdsAll(ins)\r\n    var displayState = state\r\n    if (del.length) {\r\n      var negation = holdsAll(del)\r\n      if (state && negation) {\r\n        box.appendChild(\r\n          UI.widgets.errorMessageBlock(\r\n            dom,\r\n            'Inconsistent data in store!\\n' + ins + ' and\\n' + del\r\n          )\r\n        )\r\n        return box\r\n      }\r\n      if (!state && !negation) {\r\n        state = null\r\n        const defa = kb.any(form, ns.ui('default'))\r\n        displayState = defa ? defa.value === '1' : tristate ? null : false\r\n      }\r\n    }\r\n    input.state = state\r\n    input.textContent = {\r\n      true: checkMarkCharacter,\r\n      false: cancelCharacter,\r\n      null: dashCharacter\r\n    }[displayState]\r\n  }\r\n\r\n  refresh()\r\n  if (!editable) return box\r\n\r\n  var boxHandler = function (_e) {\r\n    tx.style = 'color: #bbb;' // grey -- not saved yet\r\n    var toDelete = input.state === true ? ins : input.state === false ? del : []\r\n    input.newState =\r\n      input.state === null\r\n        ? true\r\n        : input.state === true\r\n          ? false\r\n          : tristate\r\n            ? null\r\n            : true\r\n\r\n    var toInsert =\r\n      input.newState === true ? ins : input.newState === false ? del : []\r\n    console.log(`  Deleting  ${toDelete}`)\r\n    console.log(`  Inserting ${toInsert}`)\r\n    UI.store.updater.update(toDelete, toInsert, function (\r\n      uri,\r\n      success,\r\n      errorBody\r\n    ) {\r\n      if (!success) {\r\n        if (toDelete.why) {\r\n          var hmmm = kb.holds(\r\n            toDelete.subject,\r\n            toDelete.predicate,\r\n            toDelete.object,\r\n            toDelete.why\r\n          )\r\n          if (hmmm) {\r\n            console.log(' @@@@@ weird if 409 - does hold statement')\r\n          }\r\n        }\r\n        tx.style = 'color: #black; background-color: #fee;'\r\n        box.appendChild(\r\n          error.errorMessageBlock(\r\n            dom,\r\n            `Checkbox: Error updating store from ${input.state} to ${\r\n              input.newState\r\n            }:\\n\\n${errorBody}`\r\n          )\r\n        )\r\n      } else {\r\n        tx.style = 'color: #black;'\r\n        input.state = input.newState\r\n        input.textContent = {\r\n          true: checkMarkCharacter,\r\n          false: cancelCharacter,\r\n          null: dashCharacter\r\n        }[input.state] // @@\r\n      }\r\n    })\r\n  }\r\n  input.addEventListener('click', boxHandler, false)\r\n  return box\r\n}\r\nforms.buildCheckboxForm = buildCheckboxForm\r\n\r\nforms.fieldLabel = function (dom, property, form) {\r\n  var lab = UI.store.any(form, ns.ui('label'))\r\n  if (!lab) lab = utils.label(property, true) // Init capital\r\n  if (property === undefined) {\r\n    return dom.createTextNode('@@Internal error: undefined property')\r\n  }\r\n  var anchor = dom.createElement('a')\r\n  if (property.uri) anchor.setAttribute('href', property.uri)\r\n  anchor.setAttribute('style', 'color: #3B5998; text-decoration: none;') // Not too blue and no underline\r\n  anchor.textContent = lab\r\n  return anchor\r\n}\r\n\r\nforms.fieldStore = function (subject, predicate, def) {\r\n  var sts = UI.store.statementsMatching(subject, predicate)\r\n  if (sts.length === 0) return def // can used default as no data yet\r\n  if (\r\n    sts.length > 0 &&\r\n    sts[0].why.uri &&\r\n    UI.store.updater.editable(sts[0].why.uri, UI.store)\r\n  ) {\r\n    return UI.store.sym(sts[0].why.uri)\r\n  }\r\n  return def\r\n}\r\n\r\n/** Mint local ID using timestamp\r\n * @param {NamedNode} doc - the document in which the ID is to be generated\r\n */\r\nforms.newThing = function (doc) {\r\n  var now = new Date()\r\n  return $rdf.sym(doc.uri + '#' + 'id' + ('' + now.getTime()))\r\n}\r\n\r\nmodule.exports = forms\r\n"],"file":"forms.js"}