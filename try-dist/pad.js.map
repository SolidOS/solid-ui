{"version":3,"sources":["../src/pad.js"],"names":["$rdf","require","padModule","module","exports","UI","authn","icons","log","ns","pad","rdf","store","widgets","kb","PAD","Namespace","utils","lightColorHash","author","hash","x","split","reduce","a","b","charCodeAt","uri","toString","renderPartipants","dom","table","padDoc","subject","me","options","setAttribute","newRowForParticpation","parp","person","any","wf","tr","createElement","textContent","bg","anyValue","ui","block","personTR","appendChild","td","insertBefore","firstChild","syncTable","parps","each","map","cal","sort","participations","p","syncTableToArray","refresh","participationObject","Promise","resolve","reject","Error","filter","pn","holds","length","participation","newThing","ins","st","Date","updater","update","ok","errorMessage","recordParticipation","refreshable","currentUser","manageParticipation","container","e","errorMessageBlock","getChunks","chunks","chunk","the","sameTerm","push","xmlEncode","str","replace","notepadToHTML","html","title","dct","level","increaseLevel","indent","decreaseLevel","forEach","anyJS","rawContent","sioc","content","h","notepad","exists","upstreamStatus","downstreamStatus","statusArea","t","complain","message","upstream","console","clearStatus","_upsteam","innerHTML","setPartStyle","part","colors","pending","baseStyle","headingCore","headingStyle","dc","bgcolor","value","style","removePart","prev","undefined","next","del","statementsMatching","concat","label","slice","response","row","parentNode","before","previousSibling","removeChild","focus","status","state","beep","setTimeout","reloadAndSync","res","changeIndent","delta","current","Number","object","newIndent","errorBody","requestDownstreamAction","addListeners","addEventListener","event","queueProperty","queue","keyCode","shiftKey","newChunk","preventDefault","nextSibling","updateStore","old","newOne","lastSent","xhr","inputChangeListener","_event","newPartAfter","tr1","text","ele","here","tagName","toLowerCase","_xhr","newPart","newLinesBefore","consistencyCheck","found","failed","complain2","msg","k","sts","sync","statusAra","manif","i","children","refreshTree","root","reloading","checkAndSync","retryTimeout","tryReload","reload","insertables"],"mappings":"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","sourcesContent":["/** **************\r\n *   Notepad Widget\r\n */\r\n\r\n/** @module UI.pad\r\n */\r\n\r\nconst $rdf = require('rdflib')\r\nvar padModule = (module.exports = {})\r\nvar UI = {\r\n  authn: require('./authn/authn'),\r\n  icons: require('./iconBase'),\r\n  log: require('./log'),\r\n  ns: require('./ns'),\r\n  pad: padModule,\r\n  rdf: $rdf,\r\n  store: require('./store'),\r\n  widgets: require('./widgets')\r\n}\r\nconst kb = UI.store\r\nconst ns = UI.ns\r\nconst PAD = $rdf.Namespace('http://www.w3.org/ns/pim/pad#')\r\n\r\nconst utils = require('./utils')\r\n\r\n/** Figure out a random color from my webid\r\n *\r\n * @param {NamedNode} author - The author of text being displayed\r\n * @returns {String} The CSS color generated, constrained to be light for a background color\r\n */\r\nUI.pad.lightColorHash = function (author) {\r\n  var hash = function (x) {\r\n    return x.split('').reduce(function (a, b) {\r\n      a = (a << 5) - a + b.charCodeAt(0)\r\n      return a & a\r\n    }, 0)\r\n  }\r\n  return author && author.uri\r\n    ? '#' + ((hash(author.uri) & 0xffffff) | 0xc0c0c0).toString(16)\r\n    : '#ffffff' // c0c0c0  forces pale\r\n} // no id -> white\r\n\r\n// Manage participation in this session\r\n//\r\n//  This is more general tham the pad.\r\n//\r\nUI.pad.renderPartipants = function (dom, table, padDoc, subject, me, options) {\r\n  table.setAttribute('style', 'margin: 0.8em;')\r\n\r\n  var newRowForParticpation = function (parp) {\r\n    var person = kb.any(parp, ns.wf('participant'))\r\n    var tr\r\n    if (!person) {\r\n      tr = dom.createElement('tr')\r\n      tr.textContent = '???' // Don't crash - invalid part'n entry\r\n      return tr\r\n    }\r\n    var bg = kb.anyValue(parp, ns.ui('backgroundColor')) || 'white'\r\n\r\n    var block = dom.createElement('div')\r\n    block.setAttribute(\r\n      'style',\r\n      'height: 1.5em; width: 1.5em; margin: 0.3em; border 0.01em solid #888; background-color: ' +\r\n        bg\r\n    )\r\n    tr = UI.widgets.personTR(dom, null, person, options)\r\n    table.appendChild(tr)\r\n    var td = dom.createElement('td')\r\n    td.setAttribute('style', 'vertical-align: middle;')\r\n    td.appendChild(block)\r\n    tr.insertBefore(td, tr.firstChild)\r\n    return tr\r\n  }\r\n\r\n  var syncTable = function () {\r\n    var parps = kb.each(subject, ns.wf('participation')).map(function (parp) {\r\n      return [kb.anyValue(parp, UI.ns.cal('dtstart')) || '9999-12-31', parp]\r\n    })\r\n    parps.sort() // List in order of joining\r\n    var participations = parps.map(function (p) {\r\n      return p[1]\r\n    })\r\n    utils.syncTableToArray(table, participations, newRowForParticpation)\r\n  }\r\n  table.refresh = syncTable\r\n  syncTable()\r\n  return table\r\n}\r\n\r\n/** Record, or find old, Particpation object\r\n *\r\n * A particpaption object is a place to record things specifically about\r\n * subject and the user, such as preferences, start of membership, etc\r\n * @param {Node} subject - The thing in which the participation is happening\r\n * @param {NamedNode} document -  Where to record the data\r\n * @param {NamedNode} me - The logged in user\r\n *\r\n */\r\nUI.pad.participationObject = function (subject, padDoc, me) {\r\n  return new Promise(function (resolve, reject) {\r\n    if (!me) {\r\n      throw new Error('Not user id')\r\n    }\r\n\r\n    var parps = kb.each(subject, ns.wf('participation')).filter(function (pn) {\r\n      return kb.holds(pn, ns.wf('participant'), me)\r\n    })\r\n    if (parps.length > 1) {\r\n      throw new Error('Multiple records of your participation')\r\n    }\r\n    if (parps.length) {\r\n      // If I am not already recorded\r\n      resolve(parps[0]) // returns the particpation object\r\n    } else {\r\n      var participation = UI.widgets.newThing(padDoc)\r\n      var ins = [\r\n        UI.rdf.st(subject, ns.wf('participation'), participation, padDoc),\r\n\r\n        UI.rdf.st(participation, ns.wf('participant'), me, padDoc),\r\n        UI.rdf.st(participation, ns.cal('dtstart'), new Date(), padDoc),\r\n        UI.rdf.st(\r\n          participation,\r\n          ns.ui('backgroundColor'),\r\n          UI.pad.lightColorHash(me),\r\n          padDoc\r\n        )\r\n      ]\r\n      kb.updater.update([], ins, function (uri, ok, errorMessage) {\r\n        if (!ok) {\r\n          reject(new Error('Error recording your partipation: ' + errorMessage))\r\n        } else {\r\n          resolve(participation)\r\n        }\r\n      })\r\n      resolve(participation)\r\n    }\r\n  })\r\n}\r\n\r\n/** Record my participation and display participants\r\n *\r\n * @param {NamedNode} subject - the thing in which participation is happening\r\n * @param {NamedNode} padDoc - The document into which the particpation should be recorded\r\n * @param {DOMNode} refreshable - A DOM element whose refresh() is to be called if the change works\r\n *\r\n */\r\nUI.pad.recordParticipation = function (subject, padDoc, refreshable) {\r\n  var me = UI.authn.currentUser()\r\n  if (!me) return // Not logged in\r\n\r\n  var parps = kb.each(subject, ns.wf('participation')).filter(function (pn) {\r\n    return kb.holds(pn, ns.wf('participant'), me)\r\n  })\r\n  if (parps.length > 1) {\r\n    throw new Error('Multiple records of your participation')\r\n  }\r\n  if (parps.length) {\r\n    // If I am not already recorded\r\n    return parps[0] // returns the particpation object\r\n  } else {\r\n    var participation = UI.widgets.newThing(padDoc)\r\n    var ins = [\r\n      UI.rdf.st(subject, ns.wf('participation'), participation, padDoc),\r\n\r\n      UI.rdf.st(participation, ns.wf('participant'), me, padDoc),\r\n      UI.rdf.st(participation, UI.ns.cal('dtstart'), new Date(), padDoc),\r\n      UI.rdf.st(\r\n        participation,\r\n        ns.ui('backgroundColor'),\r\n        UI.pad.lightColorHash(me),\r\n        padDoc\r\n      )\r\n    ]\r\n    kb.updater.update([], ins, function (uri, ok, errorMessage) {\r\n      if (!ok) {\r\n        throw new Error('Error recording your partipation: ' + errorMessage)\r\n      }\r\n      if (refreshable && refreshable.refresh) {\r\n        refreshable.refresh()\r\n      }\r\n      // UI.pad.renderPartipants(dom, table, padDoc, subject, me, options)\r\n    })\r\n    return participation\r\n  }\r\n}\r\n\r\n// Record my participation and display participants\r\n//\r\nUI.pad.manageParticipation = function (\r\n  dom,\r\n  container,\r\n  padDoc,\r\n  subject,\r\n  me,\r\n  options\r\n) {\r\n  var table = dom.createElement('table')\r\n  container.appendChild(table)\r\n  UI.pad.renderPartipants(dom, table, padDoc, subject, me, options)\r\n  try {\r\n    UI.pad.recordParticipation(subject, padDoc, table)\r\n  } catch (e) {\r\n    container.appendChild(\r\n      UI.widgets.errorMessageBlock(\r\n        dom,\r\n        'Error recording your partipation: ' + e\r\n      )\r\n    ) // Clean up?\r\n  }\r\n  return table\r\n}\r\n\r\n/**\r\n * Get the chunks of the notepad\r\n * They are stored in a RDF linked list\r\n */\r\nfunction getChunks (subject, kb) {\r\n  var chunks = []\r\n  for (\r\n    let chunk = kb.the(subject, PAD('next'));\r\n    !chunk.sameTerm(subject);\r\n    chunk = kb.the(chunk, PAD('next'))\r\n  ) {\r\n    chunks.push(chunk)\r\n  }\r\n  return chunks\r\n}\r\n\r\n/**\r\n *  Encode content to be put in XML or HTML elements\r\n */\r\nfunction xmlEncode (str) {\r\n  return str.replace('&', '&amp;').replace('<', '&lt;').replace('>', '&gt;')\r\n}\r\n\r\n/**\r\n * Convert a notepad to HTML\r\n */\r\nUI.pad.notepadToHTML = function (pad, kb) {\r\n  const chunks = getChunks(pad, kb)\r\n  var html = '<html>\\n  <head>\\n'\r\n  const title = kb.anyValue(pad, ns.dct('title'))\r\n  if (title) {\r\n    html += `    <title>${xmlEncode(title)}</title>\\n`\r\n  }\r\n  html += '  </head>\\n  <body>\\n'\r\n  var level = 0\r\n  function increaseLevel (indent) {\r\n    for (; level < indent; level++) {\r\n      html += '<ul>\\n'\r\n    }\r\n  }\r\n  function decreaseLevel (indent) {\r\n    for (; level > indent; level--) {\r\n      html += '</ul>\\n'\r\n    }\r\n  }\r\n  chunks.forEach(chunk => {\r\n    const indent = kb.anyJS(chunk, PAD('indent'))\r\n    const rawContent = kb.anyJS(chunk, ns.sioc('content'))\r\n    if (!rawContent) return // seed chunk is dummy\r\n    const content = xmlEncode(rawContent)\r\n    if (indent < 0) { // negative indent levels represent heading levels\r\n      decreaseLevel(0)\r\n      const h = indent >= -3 ? 4 + indent : 1 // -1 -> h4, -2 -> h3\r\n      html += `\\n<h${h}>${content}</h${h}>\\n`\r\n    } else { // >= 0\r\n      if (indent > 0) { // Lists\r\n        decreaseLevel(indent)\r\n        increaseLevel(indent)\r\n        html += `<li>${content}</li>\\n`\r\n      } else { // indent 0\r\n        decreaseLevel(indent)\r\n        html += `<p>${content}</p>\\n`\r\n      }\r\n    }\r\n  }) // foreach chunk\r\n  // At the end decreaseLevel any open ULs\r\n  decreaseLevel(0)\r\n  html += '  </body>\\n</html>\\n'\r\n  return html\r\n}\r\n\r\nUI.pad.notepad = function (dom, padDoc, subject, me, options) {\r\n  options = options || {}\r\n  var exists = options.exists\r\n  var table = dom.createElement('table')\r\n  var kb = UI.store\r\n  var ns = UI.ns\r\n\r\n  if (me && !me.uri) throw new Error('UI.pad.notepad:  Invalid userid')\r\n\r\n  var updater = UI.store.updater\r\n\r\n  var PAD = $rdf.Namespace('http://www.w3.org/ns/pim/pad#')\r\n\r\n  table.setAttribute(\r\n    'style',\r\n    'padding: 1em; overflow: auto; resize: horizontal; min-width: 40em;'\r\n  )\r\n\r\n  var upstreamStatus = null\r\n  var downstreamStatus = null\r\n\r\n  if (options.statusArea) {\r\n    var t = options.statusArea.appendChild(dom.createElement('table'))\r\n    var tr = t.appendChild(dom.createElement('tr'))\r\n    upstreamStatus = tr.appendChild(dom.createElement('td'))\r\n    downstreamStatus = tr.appendChild(dom.createElement('td'))\r\n    upstreamStatus.setAttribute('style', 'width:50%')\r\n    downstreamStatus.setAttribute('style', 'width:50%')\r\n  }\r\n\r\n  var complain = function (message, upstream) {\r\n    console.log(message)\r\n    if (options.statusArea) {\r\n      ;(upstream ? upstreamStatus : downstreamStatus).appendChild(\r\n        UI.widgets.errorMessageBlock(dom, message, 'pink')\r\n      )\r\n    }\r\n  }\r\n\r\n  var clearStatus = function (_upsteam) {\r\n    if (options.statusArea) {\r\n      options.statusArea.innerHTML = ''\r\n    }\r\n  }\r\n\r\n  var setPartStyle = function (part, colors, pending) {\r\n    var chunk = part.subject\r\n    colors = colors || ''\r\n    var baseStyle =\r\n      'font-size: 100%; font-family: monospace; width: 100%; border: none; white-space: pre-wrap;'\r\n    var headingCore =\r\n      'font-family: sans-serif; font-weight: bold;  border: none;'\r\n    var headingStyle = [\r\n      'font-size: 110%;  padding-top: 0.5em; padding-bottom: 0.5em; width: 100%;',\r\n      'font-size: 120%; padding-top: 1em; padding-bottom: 1em; width: 100%;',\r\n      'font-size: 150%; padding-top: 1em; padding-bottom: 1em; width: 100%;'\r\n    ]\r\n\r\n    var author = kb.any(chunk, ns.dc('author'))\r\n    if (!colors && author) {\r\n      // Hash the user webid for now -- later allow user selection!\r\n      var bgcolor = UI.pad.lightColorHash(author)\r\n      colors =\r\n        'color: ' +\r\n        (pending ? '#888' : 'black') +\r\n        '; background-color: ' +\r\n        bgcolor +\r\n        ';'\r\n    }\r\n\r\n    var indent = kb.any(chunk, PAD('indent'))\r\n\r\n    indent = indent ? indent.value : 0\r\n    var style =\r\n      indent >= 0\r\n        ? baseStyle + 'text-indent: ' + indent * 3 + 'em;'\r\n        : headingCore + headingStyle[-1 - indent]\r\n    // ? baseStyle + 'padding-left: ' + (indent * 3) + 'em;'\r\n    part.setAttribute('style', style + colors)\r\n  }\r\n\r\n  var removePart = function (part) {\r\n    var chunk = part.subject\r\n    if (!chunk) throw new Error('No chunk for line to be deleted!') // just in case\r\n    var prev = kb.any(undefined, PAD('next'), chunk)\r\n    var next = kb.any(chunk, PAD('next'))\r\n    if (prev.sameTerm(subject) && next.sameTerm(subject)) {\r\n      // Last one\r\n      console.log(\"You can't delete the only line.\")\r\n      return\r\n    }\r\n\r\n    var del = kb\r\n      .statementsMatching(chunk, undefined, undefined, padDoc)\r\n      .concat(kb.statementsMatching(undefined, undefined, chunk, padDoc))\r\n    var ins = [$rdf.st(prev, PAD('next'), next, padDoc)]\r\n    var label = chunk.uri.slice(-4)\r\n    console.log('Deleting line ' + label)\r\n\r\n    updater.update(del, ins, function (uri, ok, errorMessage, response) {\r\n      if (ok) {\r\n        var row = part.parentNode\r\n        var before = row.previousSibling\r\n        row.parentNode.removeChild(row)\r\n        console.log('    deleted line ' + label + ' ok ' + part.value)\r\n        if (before && before.firstChild) {\r\n          before.firstChild.focus()\r\n        }\r\n      } else if (response && response.status === 409) {\r\n        // Conflict\r\n        setPartStyle(part, 'color: black;  background-color: #ffd;') // yellow\r\n        part.state = 0 // Needs downstream refresh\r\n        utils.beep(0.5, 512) // Ooops clash with other person\r\n        setTimeout(function () {\r\n          // Ideally, beep! @@\r\n          reloadAndSync() // Throw away our changes and\r\n          // updater.requestDownstreamAction(padDoc, reloadAndSync)\r\n        }, 1000)\r\n      } else {\r\n        console.log('    removePart FAILED ' + chunk + ': ' + errorMessage)\r\n        console.log(\"    removePart was deleteing :'\" + del)\r\n        setPartStyle(part, 'color: black;  background-color: #fdd;') // failed\r\n        const res = response ? response.status : ' [no response field] '\r\n        complain('Error ' + res + ' saving changes: ' + errorMessage.true) // upstream,\r\n        // updater.requestDownstreamAction(padDoc, reloadAndSync);\r\n      }\r\n    })\r\n  } // removePart\r\n\r\n  var changeIndent = function (part, chunk, delta) {\r\n    var del = kb.statementsMatching(chunk, PAD('indent'))\r\n    var current = del.length ? Number(del[0].object.value) : 0\r\n    if (current + delta < -3) return //  limit negative indent\r\n    var newIndent = current + delta\r\n    var ins = $rdf.st(chunk, PAD('indent'), newIndent, padDoc)\r\n    updater.update(del, ins, function (uri, ok, errorBody) {\r\n      if (!ok) {\r\n        console.log(\r\n          \"Indent change FAILED '\" +\r\n            newIndent +\r\n            \"' for \" +\r\n            padDoc +\r\n            ': ' +\r\n            errorBody\r\n        )\r\n        setPartStyle(part, 'color: black;  background-color: #fdd;') // failed\r\n        updater.requestDownstreamAction(padDoc, reloadAndSync)\r\n      } else {\r\n        setPartStyle(part) // Implement the indent\r\n      }\r\n    })\r\n  }\r\n\r\n  // Use this sort of code to split the line when return pressed in the middle @@\r\n  /*\r\n  function doGetCaretPosition doGetCaretPosition (oField) {\r\n    var iCaretPos = 0\r\n        // IE Support\r\n    if (document.selection) {\r\n            // Set focus on the element to avoid IE bug\r\n      oField.focus()\r\n\r\n            // To get cursor position, get empty selection range\r\n      var oSel = document.selection.createRange()\r\n\r\n            // Move selection start to 0 position\r\n      oSel.moveStart('character', -oField.value.length)\r\n\r\n            // The caret position is selection length\r\n      iCaretPos = oSel.text.length\r\n\r\n        // Firefox suppor\r\n    } else if (oField.selectionStart || oField.selectionStart === '0') {\r\n      iCaretPos = oField.selectionStart\r\n    }\r\n        // Return results\r\n    return (iCaretPos)\r\n  }\r\n*/\r\n  var addListeners = function (part, chunk) {\r\n    part.addEventListener('keydown', function (event) {\r\n      var queueProperty, queue\r\n      //  up 38; down 40; left 37; right 39     tab 9; shift 16; escape 27\r\n      switch (event.keyCode) {\r\n        case 13: // Return\r\n          var before = event.shiftKey\r\n          console.log('enter') // Shift-return inserts before -- only way to add to top of pad.\r\n          if (before) {\r\n            queue = kb.any(undefined, PAD('next'), chunk)\r\n            queueProperty = 'newlinesAfter'\r\n          } else {\r\n            queue = kb.any(chunk, PAD('next'))\r\n            queueProperty = 'newlinesBefore'\r\n          }\r\n          queue[queueProperty] = queue[queueProperty] || 0\r\n          queue[queueProperty] += 1\r\n          if (queue[queueProperty] > 1) {\r\n            console.log('    queueing newline queue = ' + queue[queueProperty])\r\n            return\r\n          }\r\n          console.log('    go ahead line before ' + queue[queueProperty])\r\n          newChunk(part, before) // was document.activeElement\r\n          break\r\n\r\n        case 8: // Delete\r\n          if (part.value.length === 0) {\r\n            console.log(\r\n              'Delete key line ' + chunk.uri.slice(-4) + ' state ' + part.state\r\n            )\r\n\r\n            switch (part.state) {\r\n              case 1: // contents being sent\r\n              case 2: // contents need to be sent again\r\n                part.state = 4 // delete me\r\n                return\r\n              case 3: // being deleted already\r\n              case 4: // already deleme state\r\n                return\r\n              case undefined:\r\n              case 0:\r\n                part.state = 3 // being deleted\r\n                removePart(part)\r\n                event.preventDefault()\r\n                break // continue\r\n              default:\r\n                throw new Error('pad: Unexpected state ' + part)\r\n            }\r\n          }\r\n          break\r\n        case 9: // Tab\r\n          var delta = event.shiftKey ? -1 : 1\r\n          changeIndent(part, chunk, delta)\r\n          event.preventDefault() // default is to highlight next field\r\n          break\r\n        case 27: // ESC\r\n          console.log('escape')\r\n          updater.requestDownstreamAction(padDoc, reloadAndSync)\r\n          event.preventDefault()\r\n          break\r\n\r\n        case 38: // Up\r\n          if (part.parentNode.previousSibling) {\r\n            part.parentNode.previousSibling.firstChild.focus()\r\n            event.preventDefault()\r\n          }\r\n          break\r\n\r\n        case 40: // Down\r\n          if (part.parentNode.nextSibling) {\r\n            part.parentNode.nextSibling.firstChild.focus()\r\n            event.preventDefault()\r\n          }\r\n          break\r\n\r\n        default:\r\n      }\r\n    })\r\n\r\n    var updateStore = function (part) {\r\n      var chunk = part.subject\r\n      setPartStyle(part, undefined, true)\r\n      var old = kb.any(chunk, ns.sioc('content')).value\r\n      var del = [$rdf.st(chunk, ns.sioc('content'), old, padDoc)]\r\n      var ins = [$rdf.st(chunk, ns.sioc('content'), part.value, padDoc)]\r\n      var newOne = part.value\r\n\r\n      // DEBUGGING ONLY\r\n      if (part.lastSent) {\r\n        if (old !== part.lastSent) {\r\n          throw new Error(\r\n            \"Out of order, last sent expected '\" +\r\n              old +\r\n              \"' but found '\" +\r\n              part.lastSent +\r\n              \"'\"\r\n          )\r\n        }\r\n      }\r\n      part.lastSent = newOne\r\n\r\n      console.log(\r\n        ' Patch proposed to ' +\r\n          chunk.uri.slice(-4) +\r\n          \" '\" +\r\n          old +\r\n          \"' -> '\" +\r\n          newOne +\r\n          \"' \"\r\n      )\r\n      updater.update(del, ins, function (uri, ok, errorBody, xhr) {\r\n        if (!ok) {\r\n          // alert(\"clash \" + errorBody);\r\n          console.log(\r\n            '    patch FAILED ' +\r\n              xhr.status +\r\n              \" for '\" +\r\n              old +\r\n              \"' -> '\" +\r\n              newOne +\r\n              \"': \" +\r\n              errorBody\r\n          )\r\n          if (xhr.status === 409) {\r\n            // Conflict -  @@ we assume someone else\r\n            setPartStyle(part, 'color: black;  background-color: #fdd;')\r\n            part.state = 0 // Needs downstream refresh\r\n            utils.beep(0.5, 512) // Ooops clash with other person\r\n            setTimeout(function () {\r\n              updater.requestDownstreamAction(padDoc, reloadAndSync)\r\n            }, 1000)\r\n          } else {\r\n            setPartStyle(part, 'color: black;  background-color: #fdd;') // failed pink\r\n            part.state = 0\r\n            complain(\r\n              '    Error ' + xhr.status + ' sending data: ' + errorBody,\r\n              true\r\n            )\r\n            utils.beep(1.0, 128) // Other\r\n            // @@@   Do soemthing more serious with other errors eg auth, etc\r\n          }\r\n        } else {\r\n          clearStatus(true) // upstream\r\n          setPartStyle(part) // synced\r\n          console.log(\"    Patch ok '\" + old + \"' -> '\" + newOne + \"' \")\r\n\r\n          if (part.state === 4) {\r\n            //  delete me\r\n            part.state = 3\r\n            removePart(part)\r\n          } else if (part.state === 3) {\r\n            // being deleted\r\n            // pass\r\n          } else if (part.state === 2) {\r\n            part.state = 1 // pending: lock\r\n            updateStore(part)\r\n          } else {\r\n            part.state = 0 // clear lock\r\n          }\r\n        }\r\n      })\r\n    }\r\n\r\n    part.addEventListener('input', function inputChangeListener (_event) {\r\n      // console.log(\"input changed \"+part.value);\r\n      setPartStyle(part, undefined, true) // grey out - not synced\r\n      console.log(\r\n        'Input event state ' + part.state + \" value '\" + part.value + \"'\"\r\n      )\r\n      switch (part.state) {\r\n        case 3: // being deleted\r\n          return\r\n        case 4: // needs to be deleted\r\n          return\r\n        case 2: // needs content updating, we know\r\n          return\r\n        case 1:\r\n          part.state = 2 // lag we need another patch\r\n          return\r\n        case 0:\r\n        case undefined:\r\n          part.state = 1 // being upadted\r\n          updateStore(part)\r\n      }\r\n    }) // listener\r\n  } // addlisteners\r\n\r\n  var newPartAfter = function (tr1, chunk, before) {\r\n    // @@ take chunk and add listeners\r\n    var text = kb.any(chunk, ns.sioc('content'))\r\n    text = text ? text.value : ''\r\n    var tr = dom.createElement('tr')\r\n    if (before) {\r\n      table.insertBefore(tr, tr1)\r\n    } else {\r\n      // after\r\n      if (tr1 && tr1.nextSibling) {\r\n        table.insertBefore(tr, tr1.nextSibling)\r\n      } else {\r\n        table.appendChild(tr)\r\n      }\r\n    }\r\n    var part = tr.appendChild(dom.createElement('input'))\r\n    part.subject = chunk\r\n    part.setAttribute('type', 'text')\r\n    part.value = text\r\n    if (me) {\r\n      setPartStyle(part, '')\r\n      addListeners(part, chunk)\r\n    } else {\r\n      setPartStyle(part, 'color: #222; background-color: #fff')\r\n      console.log(\"Note can't add listeners - not logged in\")\r\n    }\r\n    return part\r\n  }\r\n\r\n  var newChunk = function (ele, before) {\r\n    // element of chunk being split\r\n    var kb = UI.store\r\n    var indent = 0\r\n    var queueProperty = null\r\n    var here, prev, next, queue, tr1\r\n\r\n    if (ele) {\r\n      if (ele.tagName.toLowerCase() !== 'input') {\r\n        console.log('return pressed when current document is: ' + ele.tagName)\r\n      }\r\n      here = ele.subject\r\n      indent = kb.any(here, PAD('indent'))\r\n      indent = indent ? Number(indent.value) : 0\r\n      if (before) {\r\n        prev = kb.any(undefined, PAD('next'), here)\r\n        next = here\r\n        queue = prev\r\n        queueProperty = 'newlinesAfter'\r\n      } else {\r\n        prev = here\r\n        next = kb.any(here, PAD('next'))\r\n        queue = next\r\n        queueProperty = 'newlinesBefore'\r\n      }\r\n      tr1 = ele.parentNode\r\n    } else {\r\n      prev = subject\r\n      next = subject\r\n      tr1 = undefined\r\n    }\r\n\r\n    var chunk = UI.widgets.newThing(padDoc)\r\n    var label = chunk.uri.slice(-4)\r\n\r\n    var del = [$rdf.st(prev, PAD('next'), next, padDoc)]\r\n    var ins = [\r\n      $rdf.st(prev, PAD('next'), chunk, padDoc),\r\n      $rdf.st(chunk, PAD('next'), next, padDoc),\r\n      $rdf.st(chunk, ns.dc('author'), me, padDoc),\r\n      $rdf.st(chunk, ns.sioc('content'), '', padDoc)\r\n    ]\r\n    if (indent > 0) {\r\n      // Do not inherit\r\n      ins.push($rdf.st(chunk, PAD('indent'), indent, padDoc))\r\n    }\r\n\r\n    console.log('    Fresh chunk ' + label + ' proposed')\r\n    updater.update(del, ins, function (uri, ok, errorBody, _xhr) {\r\n      if (!ok) {\r\n        // alert(\"Error writing new line \" + label + \": \" + errorBody);\r\n        console.log('    ERROR writing new line ' + label + ': ' + errorBody)\r\n      } else {\r\n        var newPart = newPartAfter(tr1, chunk, before)\r\n        setPartStyle(newPart)\r\n        newPart.focus() // Note this is delayed\r\n        if (queueProperty) {\r\n          console.log(\r\n            '    Fresh chunk ' +\r\n              label +\r\n              ' updated, queue = ' +\r\n              queue[queueProperty]\r\n          )\r\n          queue[queueProperty] -= 1\r\n          if (queue[queueProperty] > 0) {\r\n            console.log(\r\n              '    Implementing queued newlines = ' + next.newLinesBefore\r\n            )\r\n            newChunk(newPart, before)\r\n          }\r\n        }\r\n      }\r\n    })\r\n  }\r\n\r\n  var consistencyCheck = function () {\r\n    var found = []\r\n    var failed = 0\r\n    function complain2 (msg) {\r\n      complain(msg)\r\n      failed++\r\n    }\r\n\r\n    if (!kb.the(subject, PAD('next'))) {\r\n      complain2('No initial next pointer')\r\n      return false // can't do linked list\r\n    }\r\n    // var chunk = kb.the(subject, PAD('next'))\r\n    var prev = subject\r\n    var chunk\r\n    for (;;) {\r\n      chunk = kb.the(prev, PAD('next'))\r\n      if (!chunk) {\r\n        complain2('No next pointer from ' + prev)\r\n      }\r\n      if (chunk.sameTerm(subject)) {\r\n        break\r\n      }\r\n      prev = chunk\r\n      var label = chunk.uri.split('#')[1]\r\n      if (found[chunk.uri]) {\r\n        complain2('Loop!')\r\n        return false\r\n      }\r\n\r\n      found[chunk.uri] = true\r\n      var k = kb.each(chunk, PAD('next')).length\r\n      if (k !== 1) {\r\n        complain2('Should be 1 not ' + k + ' next pointer for ' + label)\r\n      }\r\n\r\n      k = kb.each(chunk, PAD('indent')).length\r\n      if (k > 1) {\r\n        complain2('Should be 0 or 1 not ' + k + ' indent for ' + label)\r\n      }\r\n\r\n      k = kb.each(chunk, ns.sioc('content')).length\r\n      if (k !== 1) {\r\n        complain2('Should be 1 not ' + k + ' contents for ' + label)\r\n      }\r\n\r\n      k = kb.each(chunk, ns.dc('author')).length\r\n      if (k !== 1) {\r\n        complain2('Should be 1 not ' + k + ' author for ' + label)\r\n      }\r\n\r\n      var sts = kb.statementsMatching(undefined, ns.sioc('contents'))\r\n      sts.map(function (st) {\r\n        if (!found[st.subject.uri]) {\r\n          complain2('Loose chunk! ' + st.subject.uri)\r\n        }\r\n      })\r\n    }\r\n    return !failed\r\n  }\r\n\r\n  // Ensure that the display matches the current state of the\r\n  var sync = function () {\r\n    // var first = kb.the(subject, PAD('next'))\r\n    if (kb.each(subject, PAD('next')).length !== 1) {\r\n      var msg =\r\n        'Pad: Inconsistent data - NEXT pointers: ' +\r\n        kb.each(subject, PAD('next')).length\r\n      console.log(msg)\r\n      if (options.statusAra) {\r\n        options.statusArea.textContent += msg\r\n      }\r\n      return\r\n    }\r\n    // var last = kb.the(undefined, PAD('previous'), subject)\r\n    // var chunk = first //  = kb.the(subject, PAD('next'));\r\n    var row\r\n\r\n    // First see which of the logical chunks have existing physical manifestations\r\n    var manif = []\r\n    // Find which lines correspond to existing chunks\r\n\r\n    for (\r\n      let chunk = kb.the(subject, PAD('next'));\r\n      !chunk.sameTerm(subject);\r\n      chunk = kb.the(chunk, PAD('next'))\r\n    ) {\r\n      for (let i = 0; i < table.children.length; i++) {\r\n        var tr = table.children[i]\r\n        if (tr.firstChild.subject.sameTerm(chunk)) {\r\n          manif[chunk.uri] = tr.firstChild\r\n        }\r\n      }\r\n    }\r\n\r\n    // Remove any deleted lines\r\n    for (let i = table.children.length - 1; i >= 0; i--) {\r\n      row = table.children[i]\r\n      if (!manif[row.firstChild.subject.uri]) {\r\n        table.removeChild(row)\r\n      }\r\n    }\r\n    // Insert any new lines and update old ones\r\n    row = table.firstChild // might be null\r\n    for (\r\n      let chunk = kb.the(subject, PAD('next'));\r\n      !chunk.sameTerm(subject);\r\n      chunk = kb.the(chunk, PAD('next'))\r\n    ) {\r\n      var text = kb.any(chunk, ns.sioc('content')).value\r\n      // superstitious -- don't mess with unchanged input fields\r\n      // which may be selected by the user\r\n      if (row && manif[chunk.uri]) {\r\n        var part = row.firstChild\r\n        if (text !== part.value) {\r\n          part.value = text\r\n        }\r\n        setPartStyle(part)\r\n        part.state = 0 // Clear the state machine\r\n        delete part.lastSent // DEBUG ONLY\r\n        row = row.nextSibling\r\n      } else {\r\n        newPartAfter(row, chunk, true) // actually before\r\n      }\r\n    }\r\n  }\r\n\r\n  // Refresh the DOM tree\r\n\r\n  var refreshTree = function (root) {\r\n    if (root.refresh) {\r\n      root.refresh()\r\n      return\r\n    }\r\n    for (var i = 0; i < root.children.length; i++) {\r\n      refreshTree(root.children[i])\r\n    }\r\n  }\r\n\r\n  var reloading = false\r\n\r\n  var checkAndSync = function () {\r\n    console.log('    reloaded OK')\r\n    clearStatus()\r\n    if (!consistencyCheck()) {\r\n      complain('CONSITENCY CHECK FAILED')\r\n    } else {\r\n      refreshTree(table)\r\n    }\r\n  }\r\n\r\n  var reloadAndSync = function () {\r\n    if (reloading) {\r\n      console.log('   Already reloading - stop')\r\n      return // once only needed\r\n    }\r\n    reloading = true\r\n    var retryTimeout = 1000 // ms\r\n    var tryReload = function () {\r\n      console.log('try reload - timeout = ' + retryTimeout)\r\n      updater.reload(updater.store, padDoc, function (ok, message, xhr) {\r\n        reloading = false\r\n        if (ok) {\r\n          checkAndSync()\r\n        } else {\r\n          if (xhr.status === 0) {\r\n            complain(\r\n              'Network error refreshing the pad. Retrying in ' +\r\n                retryTimeout / 1000\r\n            )\r\n            reloading = true\r\n            retryTimeout = retryTimeout * 2\r\n            setTimeout(tryReload, retryTimeout)\r\n          } else {\r\n            complain(\r\n              'Error ' +\r\n                xhr.status +\r\n                'refreshing the pad:' +\r\n                message +\r\n                '. Stopped. ' +\r\n                padDoc\r\n            )\r\n          }\r\n        }\r\n      })\r\n    }\r\n    tryReload()\r\n  }\r\n\r\n  table.refresh = sync // Catch downward propagating refresh events\r\n  table.reloadAndSync = reloadAndSync\r\n\r\n  if (!me) console.log('Warning: must be logged in for pad to be edited')\r\n\r\n  if (exists) {\r\n    console.log('Existing pad.')\r\n    if (consistencyCheck()) {\r\n      sync()\r\n      if (kb.holds(subject, PAD('next'), subject)) {\r\n        // Empty list untenable\r\n        newChunk() // require at least one line\r\n      }\r\n    } else {\r\n      console.log((table.textContent = 'Inconsistent data. Abort'))\r\n    }\r\n  } else {\r\n    // Make new pad\r\n    console.log('No pad exists - making new one.')\r\n    var insertables = [\r\n      $rdf.st(subject, ns.rdf('type'), PAD('Notepad'), padDoc),\r\n      $rdf.st(subject, ns.dc('author'), me, padDoc),\r\n      $rdf.st(subject, ns.dc('created'), new Date(), padDoc),\r\n      $rdf.st(subject, PAD('next'), subject, padDoc)\r\n    ]\r\n\r\n    updater.update([], insertables, function (uri, ok, errorBody) {\r\n      if (!ok) {\r\n        complain(errorBody)\r\n      } else {\r\n        console.log('Initial pad created')\r\n        newChunk() // Add a first chunck\r\n        // getResults();\r\n      }\r\n    })\r\n  }\r\n  return table\r\n}\r\n"],"file":"pad.js"}