{"version":3,"sources":["../src/table.js"],"names":["UI","icons","log","ns","store","utils","widgets","renderTableViewPane","doc","options","sourceDocument","tableClass","givenQuery","query","RDFS_LITERAL","kb","rowsLookup","FORBIDDEN_COLUMNS","XSD_NUMBER_TYPES","XSD_DATE_TYPES","IMAGE_TYPES","keyVariable","subjectIdCounter","allType","types","typeSelectorDiv","addColumnDiv","lastQuery","mostCommonType","resultDiv","createElement","className","appendChild","generateControlBar","tableDiv","refresh","runQuery","table","logicalRows","columns","renderTableForQuery","s","calculateTable","generateTypeSelector","getMostCommonType","buildFilteredTable","result","setAttribute","tr","addSelectToQuery","type","selectedColumns","getColumns","i","length","variable","vars","push","setVariable","addWhereToQuery","rowVar","queryType","pat","add","rdf","addColumnsToQuery","column","formula","predicate","getVariable","optional","generateQuery","Query","slice","clearElement","generateColumnAddDropdown","updateTable","running","htmlTable","element","childNodes","removeChild","SubjectType","allColumns","useCount","getAllColumns","getUnusedColumns","indexOf","addColumn","removeColumn","filter","x","getLabel","label","addUse","Column","checkedAnyValues","possiblyLiteral","possiblyNumber","constraints","checkValue","term","termType","literalValue","value","match","getKey","toString","getHints","hints","toNT","sameTerm","superClass","setPredicate","inverse","other","concat","each","rdfs","alternatives","undefined","getConstraints","filterFunction","sortKey","toLowerCase","isImageColumn","uri","objectToArray","obj","property","optionElement","createTextNode","dropdown","addEventListener","typeSelectorChanged","selectedType","unusedColumns","sort","a","b","aLabel","bLabel","columnIndex","Number","getColumnForVariable","variableNT","predicateUri","Error","getColumnForPredicate","getTypeForObject","subjectType","discoverTypes","subjectList","statementsMatching","subjects","object","typeObj","subject","getSubjectProperties","properties","j","identifyColumnsForType","allColumnsList","sortColumns","typeUrl","sortFunction","renderColumnDeleteButton","button","renderTableHeader","linkTd","th","applyColumnSort","rows","reverse","columnKey","row1","row2","row1Value","row2Value","values","parentTable","_htmlRow","parentNode","applyColumnFiltersToRow","row","rowDisplayed","c","columnValue","htmlRow","style","display","applyColumnFilters","r","literalSort","literalToString","colValue","literalCompare","value1","value2","strValue1","strValue2","renderLiteralSelector","textBox","width","sort1","sort2","substring","renderEnumSelector","list","doMultiple","searchValue","initialSelection","ele","selected","opt","option","index","renderNumberSelector","minSelector","maxSelector","min","max","eventListener","fallbackRenderTableSelector","renderTableSelector","cs","range","choices","owl","elements","renderTableSelectors","td","selector","linkTo","linkText","linkFunction","openHrefInOutlineMode","e","preventDefault","stopPropagation","target","getTarget","getAttribute","debug","linkToObject","renderImage","height","renderValue","cellFormat","shortDate","datatype","span","textContent","forEach","lastChild","renderTableRowInto","_downstream","_subject","orig","objects","different","originalValues","background","valueInList","key","updateRow","needUpdate","getSubjectId","_subject_id","startTime","Date","now","progressMessage","original","onResult","rowKey","rowKeyId","onDone","elapsedTimeMS","splice","sortBy","sortReverse","inferColumnsFromFormula","statements","statement","inferColumns","queryVar","bestCount","best","typeUri"],"mappings":"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","sourcesContent":["// Table Widget: Format an array of RDF statements as an HTML table.\n//\n// This can operate in one of three modes: when the class of object is given\n// or when the source document from whuch data is taken is given,\n// or if a prepared query object is given.\n// (In principle it could operate with neither class nor document\n// given but typically\n// there would be too much data.)\n// When the tableClass is not given, it looks for common  classes in the data,\n// and gives the user the option.\n//\n// 2008 Written, Ilaria Liccardi  as the tableViewPane.js\n// 2014 Core table widget moved into common/table.js - timbl\n//\n\nimport { authn } from './authn/index'\nimport * as debug from './debug'\nimport { icons } from './iconBase'\nimport { store } from './logic'\nimport * as log from './log'\nimport * as ns from './ns'\nimport * as rdf from 'rdflib' // pull in first avoid cross-refs\nimport * as style from './style'\nimport * as utils from './utils'\nimport * as widgets from './widgets'\n\nconst UI = { icons, log, ns, store, utils, widgets }\n\n// UI.widgets.renderTableViewPane\nexport function renderTableViewPane (doc, options) {\n  const sourceDocument = options.sourceDocument\n  const tableClass = options.tableClass\n  const givenQuery = options.query\n\n  const RDFS_LITERAL = 'http://www.w3.org/2000/01/rdf-schema#Literal'\n  const ns = UI.ns\n  const kb = UI.store\n  const rowsLookup = {} //  Persistent mapping of subject URI to dom TR\n\n  // Predicates that are never made into columns:\n\n  const FORBIDDEN_COLUMNS = {\n    'http://www.w3.org/2002/07/owl#sameAs': true,\n    'http://www.w3.org/1999/02/22-rdf-syntax-ns#type': true\n  }\n\n  // Number types defined in the XML schema:\n\n  const XSD_NUMBER_TYPES = {\n    'http://www.w3.org/2001/XMLSchema#decimal': true,\n    'http://www.w3.org/2001/XMLSchema#float': true,\n    'http://www.w3.org/2001/XMLSchema#double': true,\n    'http://www.w3.org/2001/XMLSchema#integer': true,\n    'http://www.w3.org/2001/XMLSchema#nonNegativeInteger': true,\n    'http://www.w3.org/2001/XMLSchema#positiveInteger': true,\n    'http://www.w3.org/2001/XMLSchema#nonPositiveInteger': true,\n    'http://www.w3.org/2001/XMLSchema#negativeInteger': true,\n    'http://www.w3.org/2001/XMLSchema#long': true,\n    'http://www.w3.org/2001/XMLSchema#int': true,\n    'http://www.w3.org/2001/XMLSchema#short': true,\n    'http://www.w3.org/2001/XMLSchema#byte': true,\n    'http://www.w3.org/2001/XMLSchema#unsignedLong': true,\n    'http://www.w3.org/2001/XMLSchema#unsignedInt': true,\n    'http://www.w3.org/2001/XMLSchema#unsignedShort': true,\n    'http://www.w3.org/2001/XMLSchema#unsignedByte': true\n  }\n\n  const XSD_DATE_TYPES = {\n    'http://www.w3.org/2001/XMLSchema#dateTime': true,\n    'http://www.w3.org/2001/XMLSchema#date': true\n  }\n\n  // Classes that indicate an image:\n\n  const IMAGE_TYPES = {\n    'http://xmlns.com/foaf/0.1/Image': true,\n    'http://purl.org/dc/terms/Image': true\n  }\n\n  // Name of the column used as a \"key\" value to look up the row.\n  // This is necessary because in the normal view, the columns are\n  // all \"optional\" values, meaning that we will get a result set\n  // for every individual value that is found.  The row key acts\n  // as an anchor that can be used to combine this information\n  // back into the same row.\n\n  const keyVariable = options.keyVariable || '?_row'\n\n  let subjectIdCounter = 0\n  let allType, types\n  let typeSelectorDiv, addColumnDiv\n\n  // The last SPARQL query used:\n  let lastQuery = null\n  let mostCommonType = null\n\n  const resultDiv = doc.createElement('div')\n  resultDiv.className = 'tableViewPane'\n\n  resultDiv.appendChild(generateControlBar()) // sets typeSelectorDiv\n\n  const tableDiv = doc.createElement('div')\n  resultDiv.appendChild(tableDiv)\n\n  // Save a refresh function for use by caller\n  resultDiv.refresh = function () {\n    runQuery(table.query, table.logicalRows, table.columns, table)\n    // updateTable(givenQuery, mostCommonType) // This could be a lot more incremental and efficient\n  }\n\n  // A specifically asked-for query\n  if (givenQuery) {\n    var table = renderTableForQuery(givenQuery)\n    // lastQuery = givenQuery\n    tableDiv.appendChild(table)\n  } else {\n    // Find the most common type and select it by default\n\n    const s = calculateTable()\n    allType = s[0]\n    types = s[1]\n    if (!tableClass) {\n      typeSelectorDiv.appendChild(generateTypeSelector(allType, types))\n    }\n\n    mostCommonType = getMostCommonType(types)\n\n    if (mostCommonType) {\n      buildFilteredTable(mostCommonType)\n    } else {\n      buildFilteredTable(allType)\n    }\n  }\n  return resultDiv\n\n  // /////////////////////////////////////////////////////////////////\n  /*\n  function closeDialog (dialog) {\n    dialog.parentNode.removeChild(dialog)\n  }\n\n  function createActionButton (label, callback) {\n    var button = doc.createElement('input')\n    button.setAttribute('type', 'submit')\n    button.setAttribute('value', label)\n    button.addEventListener('click', callback, false)\n    return button\n  }\n// @@ Tdo:  put these  buttonsback in,\n// to allow user to see and edit and save the sparql query for the table they are looking at\n//\n\n  function createSparqlWindow () {\n    var dialog = doc.createElement('div')\n\n    dialog.setAttribute('class', 'sparqlDialog')\n\n    var title = doc.createElement('h3')\n    title.appendChild(doc.createTextNode('Edit SPARQL query'))\n\n    var inputbox = doc.createElement('textarea')\n    inputbox.value = rdf.queryToSPARQL(lastQuery)\n\n    dialog.appendChild(title)\n    dialog.appendChild(inputbox)\n\n    dialog.appendChild(createActionButton('Query', function () {\n      var query = rdf.SPARQLToQuery(inputbox.value)\n      updateTable(query)\n      closeDialog(dialog)\n    }))\n\n    dialog.appendChild(createActionButton('Close', function () {\n      closeDialog(dialog)\n    }))\n\n    return dialog\n  }\n\n  function sparqlButtonPressed () {\n    var dialog = createSparqlWindow()\n\n    resultDiv.appendChild(dialog)\n  }\n\n  function generateSparqlButton () {\n    var image = doc.createElement('img')\n    image.setAttribute('class', 'sparqlButton')\n    image.setAttribute('src', UI.iconBase + 'icons/1pt5a.gif')\n    image.setAttribute('alt', 'Edit SPARQL query')\n\n    image.addEventListener('click', sparqlButtonPressed, false)\n\n    return image\n  }\n*/\n  // Generate the control bar displayed at the top of the screen.\n\n  function generateControlBar () {\n    const result = doc.createElement('table')\n    result.setAttribute('class', 'toolbar')\n\n    const tr = doc.createElement('tr')\n\n    /*             @@    Add in later -- not debugged yet\n            var sparqlButtonDiv = doc.createElement(\"td\")\n            sparqlButtonDiv.appendChild(generateSparqlButton())\n            tr.appendChild(sparqlButtonDiv)\n    */\n    typeSelectorDiv = doc.createElement('td')\n    tr.appendChild(typeSelectorDiv)\n\n    addColumnDiv = doc.createElement('td')\n    tr.appendChild(addColumnDiv)\n\n    result.appendChild(tr)\n\n    return result\n  }\n\n  // Add the SELECT details to the query being built.\n\n  function addSelectToQuery (query, type) {\n    const selectedColumns = type.getColumns()\n\n    for (let i = 0; i < selectedColumns.length; ++i) {\n      // TODO: autogenerate nicer names for variables\n      // variables have to be unambiguous\n\n      const variable = kb.variable('_col' + i)\n\n      query.vars.push(variable)\n      selectedColumns[i].setVariable(variable)\n    }\n  }\n\n  // Add WHERE details to the query being built.\n\n  function addWhereToQuery (query, rowVar, type) {\n    let queryType = type.type\n\n    if (!queryType) {\n      queryType = kb.variable('_any')\n    }\n\n    // _row a type\n    query.pat.add(rowVar, UI.ns.rdf('type'), queryType)\n  }\n\n  // Generate OPTIONAL column selectors.\n\n  function addColumnsToQuery (query, rowVar, type) {\n    const selectedColumns = type.getColumns()\n\n    for (let i = 0; i < selectedColumns.length; ++i) {\n      const column = selectedColumns[i]\n\n      const formula = kb.formula()\n\n      formula.add(rowVar, column.predicate, column.getVariable())\n\n      query.pat.optional.push(formula)\n    }\n  }\n\n  // Generate a query object from the currently-selected type\n  // object.\n\n  function generateQuery (type) {\n    const query = new rdf.Query()\n    const rowVar = kb.variable(keyVariable.slice(1)) // don't pass '?'\n\n    addSelectToQuery(query, type)\n    addWhereToQuery(query, rowVar, type)\n    addColumnsToQuery(query, rowVar, type)\n\n    return query\n  }\n\n  // Build the contents of the tableDiv element, filtered according\n  // to the specified type.\n\n  function buildFilteredTable (type) {\n    // Generate \"add column\" cell.\n\n    clearElement(addColumnDiv)\n    addColumnDiv.appendChild(generateColumnAddDropdown(type))\n\n    const query = generateQuery(type)\n\n    updateTable(query, type)\n  }\n\n  function updateTable (query, type) {\n    // Stop the previous query from doing any updates.\n\n    if (lastQuery) {\n      lastQuery.running = false\n    }\n\n    // Render the HTML table.\n\n    const htmlTable = renderTableForQuery(query, type)\n\n    // Clear the tableDiv element, and replace with the new table.\n\n    clearElement(tableDiv)\n    tableDiv.appendChild(htmlTable)\n\n    // Save the query for the edit dialog.\n\n    lastQuery = query\n  }\n\n  // Remove all subelements of the specified element.\n\n  function clearElement (element) {\n    while (element.childNodes.length > 0) {\n      element.removeChild(element.childNodes[0])\n    }\n  }\n\n  // A SubjectType is created for each rdf:type discovered.\n\n  function SubjectType (type) {\n    this.type = type\n    this.columns = null\n    this.allColumns = []\n    this.useCount = 0\n\n    // Get a list of all columns used by this type.\n\n    this.getAllColumns = function () {\n      return this.allColumns\n    }\n\n    // Get a list of the current columns used by this type\n    // (subset of allColumns)\n\n    this.getColumns = function () {\n      // The first time through, get a list of all the columns\n      // and select only the six most popular columns.\n\n      if (!this.columns) {\n        const allColumns = this.getAllColumns()\n        this.columns = allColumns.slice(0, 7)\n      }\n\n      return this.columns\n    }\n\n    // Get a list of unused columns\n\n    this.getUnusedColumns = function () {\n      const allColumns = this.getAllColumns()\n      const columns = this.getColumns()\n\n      const result = []\n\n      for (let i = 0; i < allColumns.length; ++i) {\n        if (columns.indexOf(allColumns[i]) === -1) {\n          result.push(allColumns[i])\n        }\n      }\n\n      return result\n    }\n\n    this.addColumn = function (column) {\n      this.columns.push(column)\n    }\n\n    this.removeColumn = function (column) {\n      this.columns = this.columns.filter(function (x) {\n        return x !== column\n      })\n    }\n\n    this.getLabel = function () {\n      return utils.label(this.type)\n    }\n\n    this.addUse = function () {\n      this.useCount += 1\n    }\n  }\n\n  // Class representing a column in the table.\n\n  function Column () {\n    this.useCount = 0\n\n    // Have we checked any values for this column yet?\n\n    this.checkedAnyValues = false\n\n    // If the range is unknown, but we just get literals in this\n    // column, then we can generate a literal selector.\n\n    this.possiblyLiteral = true\n\n    // If the range is unknown, but we just get literals and they\n    // match the regular expression for numbers, we can generate\n    // a number selector.\n\n    this.possiblyNumber = true\n\n    // We accumulate classes which things in the column must be a member of\n\n    this.constraints = []\n\n    // Check values as they are read.  If we don't know what the\n    // range is, we might be able to infer that it is a literal\n    // if all of the values are literals.  Similarly, we might\n    // be able to determine if the literal values are actually\n    // numbers (using regexps).\n\n    this.checkValue = function (term) {\n      const termType = term.termType\n      if (\n        this.possiblyLiteral &&\n        termType !== 'Literal' &&\n        termType !== 'NamedNode'\n      ) {\n        this.possiblyNumber = false\n        this.possiblyLiteral = false\n      } else if (this.possiblyNumber) {\n        if (termType !== 'Literal') {\n          this.possiblyNumber = false\n        } else {\n          const literalValue = term.value\n\n          if (!literalValue.match(/^-?\\d+(\\.\\d*)?$/)) {\n            this.possiblyNumber = false\n          }\n        }\n      }\n\n      this.checkedAnyValues = true\n    }\n\n    this.getVariable = function () {\n      return this.variable\n    }\n\n    this.setVariable = function (variable) {\n      this.variable = variable\n    }\n\n    this.getKey = function () {\n      return this.variable.toString()\n    }\n\n    this.addUse = function () {\n      this.useCount += 1\n    }\n\n    this.getHints = function () {\n      if (\n        options &&\n        options.hints &&\n        this.variable &&\n        options.hints[this.variable.toNT()]\n      ) {\n        return options.hints[this.variable.toNT()]\n      }\n      return {}\n    }\n\n    this.getLabel = function () {\n      if (this.getHints().label) {\n        return this.getHints().label\n      }\n      if (this.predicate) {\n        if (this.predicate.sameTerm(ns.rdf('type')) && this.superClass) {\n          return utils.label(this.superClass, true) // do initial cap\n        }\n        return utils.label(this.predicate)\n      } else if (this.variable) {\n        return this.variable.toString()\n      } else {\n        return 'unlabeled column?'\n      }\n    }\n\n    this.setPredicate = function (predicate, inverse, other) {\n      if (inverse) {\n        // variable is in the subject pos\n        this.inverse = predicate\n        this.constraints = this.constraints.concat(\n          kb.each(predicate, UI.ns.rdfs('domain'))\n        )\n        if (\n          predicate.sameTerm(ns.rdfs('subClassOf')) &&\n          other.termType === 'NamedNode'\n        ) {\n          this.superClass = other\n          this.alternatives = kb.each(undefined, ns.rdfs('subClassOf'), other)\n        }\n      } else {\n        // variable is the object\n        this.predicate = predicate\n        this.constraints = this.constraints.concat(\n          kb.each(predicate, UI.ns.rdfs('range'))\n        )\n      }\n    }\n\n    this.getConstraints = function () {\n      return this.constraints\n    }\n\n    this.filterFunction = function () {\n      return true\n    }\n\n    this.sortKey = function () {\n      return this.getLabel().toLowerCase()\n    }\n\n    this.isImageColumn = function () {\n      for (let i = 0; i < this.constraints.length; i++) {\n        if (this.constraints[i].uri in IMAGE_TYPES) return true\n      }\n      return false\n    }\n  }\n\n  // Convert an object to an array.\n\n  function objectToArray (obj, filter) {\n    const result = []\n\n    for (const property in obj) {\n      // @@@ have to guard against methods\n      const value = obj[property]\n\n      if (!filter || filter(property, value)) {\n        result.push(value)\n      }\n    }\n\n    return result\n  }\n\n  // Generate an <option> in a drop-down list.\n\n  function optionElement (label, value) {\n    const result = doc.createElement('option')\n\n    result.setAttribute('value', value)\n    result.appendChild(doc.createTextNode(label))\n\n    return result\n  }\n\n  // Generate drop-down list box for choosing type of data displayed\n\n  function generateTypeSelector (allType, types) {\n    const resultDiv = doc.createElement('div')\n\n    resultDiv.appendChild(doc.createTextNode('Select type: '))\n\n    const dropdown = doc.createElement('select')\n\n    dropdown.appendChild(optionElement('All types', 'null'))\n\n    for (const uri in types) {\n      dropdown.appendChild(optionElement(types[uri].getLabel(), uri))\n    }\n\n    dropdown.addEventListener(\n      'click',\n      function () {\n        let type\n\n        if (dropdown.value === 'null') {\n          type = allType\n        } else {\n          type = types[dropdown.value]\n        }\n\n        typeSelectorChanged(type)\n      },\n      false\n    )\n\n    resultDiv.appendChild(dropdown)\n\n    return resultDiv\n  }\n\n  // Callback invoked when the type selector drop-down list is changed.\n\n  function typeSelectorChanged (selectedType) {\n    buildFilteredTable(selectedType)\n  }\n\n  // Build drop-down list to add a new column\n\n  function generateColumnAddDropdown (type) {\n    const resultDiv = doc.createElement('div')\n\n    const unusedColumns = type.getUnusedColumns()\n\n    unusedColumns.sort(function (a, b) {\n      const aLabel = a.sortKey()\n      const bLabel = b.sortKey()\n      return (aLabel > bLabel) - (aLabel < bLabel)\n    })\n\n    // If there are no unused columns, the div is empty.\n\n    if (unusedColumns.length > 0) {\n      resultDiv.appendChild(doc.createTextNode('Add column: '))\n\n      // Build dropdown list of unused columns.\n\n      const dropdown = doc.createElement('select')\n\n      dropdown.appendChild(optionElement('', '-1'))\n\n      for (let i = 0; i < unusedColumns.length; ++i) {\n        const column = unusedColumns[i]\n        dropdown.appendChild(optionElement(column.getLabel(), '' + i))\n      }\n\n      resultDiv.appendChild(dropdown)\n\n      // Invoke callback when the dropdown is changed, to add\n      // the column and reload the table.\n\n      dropdown.addEventListener(\n        'click',\n        function () {\n          const columnIndex = Number(dropdown.value)\n\n          if (columnIndex >= 0) {\n            type.addColumn(unusedColumns[columnIndex])\n            buildFilteredTable(type)\n          }\n        },\n        false\n      )\n    }\n\n    return resultDiv\n  }\n\n  // Find the column for a given variable\n\n  function getColumnForVariable (columns, variableNT) {\n    for (const predicateUri in columns) {\n      const column = columns[predicateUri]\n      if (column.variable.toNT() === variableNT) {\n        return column\n      }\n    }\n    throw new Error(`getColumnForVariable: no column for variable ${variableNT}`)\n    // return null\n  }\n\n  // Find the column for a given predicate, creating a new column object\n  // if necessary.\n\n  function getColumnForPredicate (columns, predicate) {\n    let column\n\n    if (predicate.uri in columns) {\n      column = columns[predicate.uri]\n    } else {\n      column = new Column()\n      column.setPredicate(predicate)\n      columns[predicate.uri] = column\n    }\n\n    return column\n  }\n\n  // Find a type by its URI, creating a new SubjectType object if\n  // necessary.\n\n  function getTypeForObject (types, type) {\n    let subjectType\n\n    if (type.uri in types) {\n      subjectType = types[type.uri]\n    } else {\n      subjectType = new SubjectType(type)\n      types[type.uri] = subjectType\n    }\n\n    return subjectType\n  }\n\n  // Discover types and subjects for search.\n\n  function discoverTypes () {\n    // rdf:type properties of subjects, indexed by URI for the type.\n\n    const types = {}\n\n    // Get a list of statements that match:  ? rdfs:type ?\n    // From this we can get a list of subjects and types.\n\n    const subjectList = kb.statementsMatching(\n      undefined,\n      UI.ns.rdf('type'),\n      tableClass, // can be undefined OR\n      sourceDocument\n    ) // can be undefined\n\n    // Subjects for later lookup.  This is a mapping of type URIs to\n    // lists of subjects (it is necessary to record the type of\n    // a subject).\n\n    const subjects = {}\n\n    for (let i = 0; i < subjectList.length; ++i) {\n      const type = subjectList[i].object\n\n      if (type.termType !== 'NamedNode') {\n        // @@ no bnodes?\n        continue\n      }\n\n      const typeObj = getTypeForObject(types, type)\n\n      if (!(type.uri in subjects)) {\n        subjects[type.uri] = []\n      }\n\n      subjects[type.uri].push(subjectList[i].subject)\n      typeObj.addUse()\n    }\n\n    return [subjects, types]\n  }\n\n  // Get columns for the given subject.\n\n  function getSubjectProperties (subject, columns) {\n    // Get a list of properties of this subject.\n\n    const properties = kb.statementsMatching(\n      subject,\n      undefined,\n      undefined,\n      sourceDocument\n    )\n\n    const result = {}\n\n    for (let j = 0; j < properties.length; ++j) {\n      const predicate = properties[j].predicate\n\n      if (predicate.uri in FORBIDDEN_COLUMNS) {\n        continue\n      }\n\n      // Find/create a column for this predicate.\n\n      const column = getColumnForPredicate(columns, predicate)\n      column.checkValue(properties[j].object)\n\n      result[predicate.uri] = column\n    }\n\n    return result\n  }\n\n  // Identify the columns associated with a type.\n\n  function identifyColumnsForType (type, subjects) {\n    const allColumns = {}\n\n    // Process each subject of this type to build up the\n    // column list.\n\n    for (let i = 0; i < subjects.length; ++i) {\n      const columns = getSubjectProperties(subjects[i], allColumns)\n\n      for (const predicateUri in columns) {\n        const column = columns[predicateUri]\n\n        column.addUse()\n      }\n    }\n\n    // Generate the columns list\n\n    const allColumnsList = objectToArray(allColumns)\n    sortColumns(allColumnsList)\n    type.allColumns = allColumnsList\n  }\n\n  // Build table information from parsing RDF statements.\n\n  function calculateTable () {\n    // Find the types that we will display in the dropdown\n    // list box, and associated objects of those types.\n\n    let subjects, types\n\n    const s = discoverTypes()\n    // eslint-disable-next-line prefer-const\n    subjects = s[0]\n    // eslint-disable-next-line prefer-const\n    types = s[1] // no [ ] on LHS\n\n    for (const typeUrl in subjects) {\n      const subjectList = subjects[typeUrl]\n      const type = types[typeUrl]\n\n      identifyColumnsForType(type, subjectList)\n    }\n\n    // TODO: Special type that captures all rows.\n    // Combine columns from all types\n\n    const allType = new SubjectType(null)\n\n    return [allType, objectToArray(types)]\n  }\n\n  // Sort the list of columns by the most common columns.\n\n  function sortColumns (columns) {\n    function sortFunction (a, b) {\n      return (a.useCount < b.useCount) - (a.useCount > b.useCount)\n    }\n\n    columns.sort(sortFunction)\n  }\n\n  // Create the delete button for a column.\n\n  function renderColumnDeleteButton (type, column) {\n    const button = doc.createElement('a')\n\n    button.appendChild(doc.createTextNode('[x]'))\n\n    button.addEventListener(\n      'click',\n      function () {\n        type.removeColumn(column)\n        buildFilteredTable(type)\n      },\n      false\n    )\n\n    return button\n  }\n\n  // Render the table header for the HTML table.\n\n  function renderTableHeader (columns, type) {\n    const tr = doc.createElement('tr')\n\n    /* Empty header for link column */\n    const linkTd = doc.createElement('th')\n    tr.appendChild(linkTd)\n\n    for (let i = 0; i < columns.length; ++i) {\n      const th = doc.createElement('th')\n      const column = columns[i]\n\n      th.appendChild(doc.createTextNode(column.getLabel()))\n\n      // We can only add a delete button if we are using the\n      // proper interface and have a type to delete from:\n      if (type) {\n        th.appendChild(renderColumnDeleteButton(type, column))\n      }\n\n      tr.appendChild(th)\n    }\n\n    return tr\n  }\n\n  // Sort the rows in the rendered table by data from a specific\n  // column, using the provided sort function to compare values.\n\n  function applyColumnSort (rows, column, sortFunction, reverse) {\n    const columnKey = column.getKey()\n\n    // Sort the rows array.\n    rows.sort(function (row1, row2) {\n      let row1Value = null\n      let row2Value = null\n\n      if (columnKey in row1.values) {\n        row1Value = row1.values[columnKey][0]\n      }\n      if (columnKey in row2.values) {\n        row2Value = row2.values[columnKey][0]\n      }\n\n      const result = sortFunction(row1Value, row2Value)\n\n      if (reverse) {\n        return -result\n      } else {\n        return result\n      }\n    })\n\n    // Remove all rows from the table:\n\n    if (rows.length) {\n      const parentTable = rows[0]._htmlRow.parentNode\n\n      for (let i = 0; i < rows.length; ++i) {\n        parentTable.removeChild(rows[i]._htmlRow)\n      }\n\n      // Add back the rows in the new sorted order:\n\n      for (let i = 0; i < rows.length; ++i) {\n        parentTable.appendChild(rows[i]._htmlRow)\n      }\n    }\n  }\n\n  // Filter the list of rows based on the selectors for the\n  // columns.\n\n  function applyColumnFiltersToRow (row, columns) {\n    let rowDisplayed = true\n\n    // Check the filter functions for every column.\n    // The row should only be displayed if the filter functions\n    // for all of the columns return true.\n\n    for (let c = 0; c < columns.length; ++c) {\n      const column = columns[c]\n      const columnKey = column.getKey()\n\n      let columnValue = null\n\n      if (columnKey in row.values) {\n        columnValue = row.values[columnKey][0]\n      }\n\n      if (!column.filterFunction(columnValue)) {\n        rowDisplayed = false\n        break\n      }\n    }\n\n    // Show or hide the HTML row according to the result\n    // from the filter function.\n\n    const htmlRow = row._htmlRow\n\n    if (rowDisplayed) {\n      htmlRow.style.display = ''\n    } else {\n      htmlRow.style.display = 'none'\n    }\n  }\n\n  // Filter the list of rows based on the selectors for the\n  // columns.\n\n  function applyColumnFilters (rows, columns) {\n    // Apply filterFunction to each row.\n\n    for (let r = 0; r < rows.length; ++r) {\n      const row = rows[r]\n      applyColumnFiltersToRow(row, columns)\n    }\n  }\n\n  // /////////////////////////////////// Literal column handling\n\n  // Sort by literal value\n\n  function literalSort (rows, column, reverse) {\n    function literalToString (colValue) {\n      if (colValue) {\n        if (colValue.termType === 'Literal') {\n          return colValue.value.toLowerCase()\n        } else if (colValue.termType === 'NamedNode') {\n          return utils.label(colValue).toLowerCase()\n        }\n        return colValue.value.toLowerCase()\n      } else {\n        return ''\n      }\n    }\n\n    function literalCompare (value1, value2) {\n      const strValue1 = literalToString(value1)\n      const strValue2 = literalToString(value2)\n\n      if (strValue1 < strValue2) {\n        return -1\n      } else if (strValue1 > strValue2) {\n        return 1\n      } else {\n        return 0\n      }\n    }\n\n    applyColumnSort(rows, column, literalCompare, reverse)\n  }\n\n  // Generates a selector for an RDF literal column.\n\n  function renderLiteralSelector (rows, columns, column) {\n    const result = doc.createElement('div')\n\n    const textBox = doc.createElement('input')\n    textBox.setAttribute('type', 'text')\n    textBox.style.width = '70%'\n\n    result.appendChild(textBox)\n\n    const sort1 = doc.createElement('span')\n    sort1.appendChild(doc.createTextNode('\\u25BC'))\n    sort1.addEventListener(\n      'click',\n      function () {\n        literalSort(rows, column, false)\n      },\n      false\n    )\n    result.appendChild(sort1)\n\n    const sort2 = doc.createElement('span')\n    sort2.appendChild(doc.createTextNode('\\u25B2'))\n    sort2.addEventListener(\n      'click',\n      function () {\n        literalSort(rows, column, true)\n      },\n      false\n    )\n    result.appendChild(sort2)\n\n    let substring = null\n\n    // Filter the table to show only rows that have a particular\n    // substring in the specified column.\n\n    column.filterFunction = function (colValue) {\n      if (!substring) {\n        return true\n      } else if (!colValue) {\n        return false\n      } else {\n        let literalValue\n\n        if (colValue.termType === 'Literal') {\n          literalValue = colValue.value\n        } else if (colValue.termType === 'NamedNode') {\n          literalValue = utils.label(colValue)\n        } else {\n          literalValue = ''\n        }\n\n        return literalValue.toLowerCase().indexOf(substring) >= 0\n      }\n    }\n\n    textBox.addEventListener(\n      'keyup',\n      function () {\n        if (textBox.value !== '') {\n          substring = textBox.value.toLowerCase()\n        } else {\n          substring = null\n        }\n\n        applyColumnFilters(rows, columns)\n      },\n      false\n    )\n\n    return result\n  }\n\n  // ///////////////////////////////////  Enumeration\n\n  // Generates a dropdown selector for enumeration types include\n  //\n  //  @param rows,\n  //  @param columns, the mapping of predictae URIs to columns\n  //  @param column,\n  //  @param list,    List of alternative terms\n  //\n  function renderEnumSelector (rows, columns, column, list) {\n    const doMultiple = true\n    const result = doc.createElement('div')\n    const dropdown = doc.createElement('select')\n\n    let searchValue = {} // Defualt to all enabled\n    for (let i = 0; i < list.length; ++i) {\n      const value = list[i]\n      searchValue[value.uri] = true\n    }\n\n    const initialSelection = getHints(column).initialSelection\n    if (initialSelection) searchValue = initialSelection\n\n    if (doMultiple) dropdown.setAttribute('multiple', 'true')\n    else dropdown.appendChild(optionElement('(All)', '-1'))\n\n    for (let i = 0; i < list.length; ++i) {\n      const value = list[i]\n      const ele = optionElement(utils.label(value), i)\n      if (searchValue[value.uri]) ele.selected = true\n      dropdown.appendChild(ele)\n    }\n    result.appendChild(dropdown)\n\n    // Select based on an enum value.\n\n    column.filterFunction = function (colValue) {\n      return !searchValue || (colValue && searchValue[colValue.uri])\n    }\n\n    dropdown.addEventListener(\n      'click',\n      function () {\n        if (doMultiple) {\n          searchValue = {}\n          const opt = dropdown.options\n          for (let i = 0; i < opt.length; i++) {\n            const option = opt[i]\n            const index = Number(option.value)\n            if (opt[i].selected) searchValue[list[index].uri] = true\n          }\n        } else {\n          const index = Number(dropdown.value) // adjusted in Standard tweaks 2018-01\n          if (index < 0) {\n            searchValue = null\n          } else {\n            searchValue = {}\n            searchValue[list[index].uri] = true\n          }\n        }\n        applyColumnFilters(rows, columns)\n      },\n      true\n    )\n\n    return result\n  }\n\n  // //////////////////////////////////// Numeric\n  //\n  // Selector for XSD number types.\n\n  function renderNumberSelector (rows, columns, column) {\n    const result = doc.createElement('div')\n\n    const minSelector = doc.createElement('input')\n    minSelector.setAttribute('type', 'text')\n    minSelector.style.width = '40px'\n    result.appendChild(minSelector)\n\n    const maxSelector = doc.createElement('input')\n    maxSelector.setAttribute('type', 'text')\n    maxSelector.style.width = '40px'\n    result.appendChild(maxSelector)\n\n    // Select based on minimum/maximum limits.\n\n    let min = null\n    let max = null\n\n    column.filterFunction = function (colValue) {\n      if (colValue) {\n        colValue = Number(colValue)\n      }\n\n      if (min && (!colValue || colValue < min)) {\n        return false\n      }\n      if (max && (!colValue || colValue > max)) {\n        return false\n      }\n\n      return true\n    }\n\n    // When the values in the boxes are changed, update the\n    // displayed columns.\n\n    function eventListener () {\n      if (minSelector.value === '') {\n        min = null\n      } else {\n        min = Number(minSelector.value)\n      }\n\n      if (maxSelector.value === '') {\n        max = null\n      } else {\n        max = Number(maxSelector.value)\n      }\n\n      applyColumnFilters(rows, columns)\n    }\n\n    minSelector.addEventListener('keyup', eventListener, false)\n    maxSelector.addEventListener('keyup', eventListener, false)\n\n    return result\n  }\n\n  // /////////////////////////////////////////////////////////////////\n\n  // Fallback attempts at generating a selector if other attempts fail.\n\n  function fallbackRenderTableSelector (rows, columns, column) {\n    // Have all values matched as numbers?\n\n    if (column.checkedAnyValues && column.possiblyNumber) {\n      return renderNumberSelector(rows, columns, column)\n    }\n\n    // Have all values been literals?\n\n    if (column.possiblyLiteral) {\n      return renderLiteralSelector(rows, columns, column)\n    }\n\n    return null\n  }\n\n  // Render a selector for a given row.\n\n  function renderTableSelector (rows, columns, column) {\n    // What type of data is in this column?  Check the constraints for\n    // this predicate.\n\n    // If this is a class which can be one of various sibling classes?\n    if (column.superClass && column.alternatives.length > 0) {\n      return renderEnumSelector(rows, columns, column, column.alternatives)\n    }\n\n    const cs = column.getConstraints()\n    let range\n    for (let i = 0; i < cs.length; i++) {\n      range = cs[i]\n\n      // Is this a number type?\n      // Alternatively, is this an rdf:Literal type where all of\n      // the values match as numbers?\n\n      if (\n        (column.checkedAnyValues && column.possiblyNumber) ||\n        range.uri in XSD_NUMBER_TYPES\n      ) {\n        return renderNumberSelector(rows, columns, column)\n      }\n\n      // rdf:Literal?  Assume a string at this point\n\n      if (range.uri === RDFS_LITERAL) {\n        return renderLiteralSelector(rows, columns, column)\n      }\n\n      // Is this an enumeration type?\n\n      // Also  ToDo: @@@ Handle membership of classes whcih are disjointUnions\n\n      const choices = kb.each(range, UI.ns.owl('oneOf'))\n      if (choices.length > 0) {\n        return renderEnumSelector(rows, columns, column, choices.elements)\n      }\n    }\n    return fallbackRenderTableSelector(rows, columns, column)\n  }\n\n  // Generate the search selectors for the table columns.\n\n  function renderTableSelectors (rows, columns) {\n    const tr = doc.createElement('tr')\n    tr.className = 'selectors'\n\n    // Empty link column\n\n    tr.appendChild(doc.createElement('td'))\n\n    // Generate selectors.\n\n    for (let i = 0; i < columns.length; ++i) {\n      const td = doc.createElement('td')\n\n      const selector = renderTableSelector(rows, columns, columns[i])\n\n      if (selector) {\n        td.appendChild(selector)\n      }\n      /*\n                  // Useful debug: display URI of predicate in column header\n                  if (columns[i].predicate.uri) {\n                      td.appendChild(document.createTextNode(columns[i].predicate.uri))\n                  }\n      */\n      tr.appendChild(td)\n    }\n\n    return tr\n  }\n\n  function linkTo (uri, linkText, hints) {\n    hints = hints || {}\n    const result = doc.createElement('a')\n    const linkFunction = hints.linkFunction\n    result.setAttribute('href', uri)\n    result.appendChild(doc.createTextNode(linkText))\n    if (!linkFunction) {\n      result.addEventListener('click', UI.widgets.openHrefInOutlineMode, true)\n    } else {\n      result.addEventListener(\n        'click',\n        function (e) {\n          e.preventDefault()\n          e.stopPropagation()\n          const target = utils.getTarget(e)\n          const uri = target.getAttribute('href')\n          if (!uri) debug.log('No href found \\n')\n          linkFunction(uri)\n        },\n        true\n      )\n    }\n    return result\n  }\n\n  function linkToObject (obj, hints) {\n    let match = false\n\n    if (obj.uri) {\n      match = obj.uri.match(/^mailto:(.*)/)\n    }\n\n    if (match) {\n      return linkTo(obj.uri, match[1], hints)\n    } else {\n      return linkTo(obj.uri, utils.label(obj), hints)\n    }\n  }\n\n  // Render an image\n\n  function renderImage (obj) {\n    const result = doc.createElement('img')\n    result.setAttribute('src', obj.uri)\n\n    // Set the height, so it appears as a thumbnail.\n    result.style.height = '40px'\n    return result\n  }\n\n  // Render an individual RDF object to an HTML object displayed\n  // in a table cell.\n\n  function getHints (column) {\n    if (\n      options &&\n      options.hints &&\n      column.variable &&\n      options.hints[column.variable.toNT()]\n    ) {\n      return options.hints[column.variable.toNT()]\n    }\n    return {}\n  }\n\n  function renderValue (obj, column) {\n    // hint\n    const hints = getHints(column)\n    const cellFormat = hints.cellFormat\n    if (cellFormat) {\n      switch (cellFormat) {\n        case 'shortDate':\n          return doc.createTextNode(UI.widgets.shortDate(obj.value))\n        // break\n        default:\n        // drop through\n      }\n    } else {\n      if (obj.termType === 'Literal') {\n        if (obj.datatype) {\n          if (XSD_DATE_TYPES[obj.datatype.uri]) {\n            return doc.createTextNode(UI.widgets.shortDate(obj.value))\n          } else if (XSD_NUMBER_TYPES[obj.datatype.uri]) {\n            const span = doc.createElement('span')\n            span.textContent = obj.value\n            span.setAttribute('style', 'text-align: right')\n            return span\n          }\n        }\n        return doc.createTextNode(obj.value)\n      } else if (obj.termType === 'NamedNode' && column.isImageColumn()) {\n        return renderImage(obj)\n      } else if (obj.termType === 'NamedNode' || obj.termType === 'BlankNode') {\n        return linkToObject(obj, hints)\n      } else if (obj.termType === 'Collection') {\n        const span = doc.createElement('span')\n        span.appendChild(doc.createTextNode('['))\n        obj.elements.forEach(function (x) {\n          span.appendChild(renderValue(x, column))\n          span.appendChild(doc.createTextNode(', '))\n        })\n        span.removeChild(span.lastChild)\n        span.appendChild(doc.createTextNode(']'))\n        return span\n      } else {\n        return doc.createTextNode(\"unknown termtype '\" + obj.termType + \"'!\")\n      }\n    }\n  }\n\n  // Render a row of the HTML table, from the given row structure.\n  // Note that unlike other functions, this renders into a provided\n  // row (<tr>) element.\n\n  function renderTableRowInto (tr, row, columns, _downstream) {\n    /* Link column, for linking to this subject. */\n\n    const linkTd = doc.createElement('td')\n\n    if (row._subject && 'uri' in row._subject) {\n      linkTd.appendChild(linkTo(row._subject.uri, '\\u2192'))\n    }\n\n    tr.appendChild(linkTd)\n\n    // Create a <td> for each column (whether the row has data for that\n    // column or not).\n\n    for (let i = 0; i < columns.length; ++i) {\n      const column = columns[i]\n      const td = doc.createElement('td')\n      var orig\n\n      const columnKey = column.getKey()\n\n      if (columnKey in row.values) {\n        const objects = row.values[columnKey]\n        let different = false\n        if (row.originalValues && row.originalValues[columnKey]) {\n          if (objects.length !== row.originalValues[columnKey].length) {\n            different = true\n          }\n        }\n        for (let j = 0; j < objects.length; ++j) {\n          const obj = objects[j]\n          if (\n            row.originalValues &&\n            row.originalValues[columnKey] &&\n            row.originalValues[columnKey].length > j\n          ) {\n            orig = row.originalValues[columnKey][j]\n            if (obj.toString() !== orig.toString()) {\n              different = true\n            }\n          }\n          td.appendChild(renderValue(obj, column))\n\n          if (j !== objects.length - 1) {\n            td.appendChild(doc.createTextNode(',\\n'))\n          }\n          if (different) {\n            td.style.background = '#efe' // green = new changed\n          }\n        }\n      }\n\n      tr.appendChild(td)\n    }\n\n    // Save a reference to the HTML row in the row object.\n\n    row._htmlRow = tr\n\n    return tr\n  }\n\n  // Check if a value is already stored in the list of values for\n  // a cell (the query can sometimes find it multiple times)\n\n  function valueInList (value, list) {\n    let key = null\n\n    if (value.termType === 'Literal') {\n      key = 'value'\n    } else if (value.termType === 'NamedNode') {\n      key = 'uri'\n    } else {\n      return list.indexOf(value) >= 0\n    }\n\n    // Check the list and compare keys:\n\n    let i\n\n    for (i = 0; i < list.length; ++i) {\n      if (list[i].termType === value.termType && list[i][key] === value[key]) {\n        return true\n      }\n    }\n\n    // Not found?\n\n    return false\n  }\n\n  // Update a row, add new values, and regenerate the HTML element\n  // containing the values.\n\n  function updateRow (row, columns, values) {\n    let key\n    let needUpdate = false\n\n    for (key in values) {\n      const value = values[key]\n\n      // If this key is not already in the row, create a new entry\n      // for it:\n\n      if (!(key in row.values)) {\n        row.values[key] = []\n      }\n\n      // Possibly add this new value to the list, but don't\n      // add it if we have already added it:\n\n      if (!valueInList(value, row.values[key])) {\n        row.values[key].push(value)\n        needUpdate = true\n      }\n    }\n\n    // Regenerate the HTML row?\n\n    if (needUpdate) {\n      clearElement(row._htmlRow)\n      renderTableRowInto(row._htmlRow, row, columns)\n    }\n    applyColumnFiltersToRow(row, columns) // Hide immediately if nec\n  }\n\n  // Get a unique ID for the given subject.  This is normally the\n  // URI; if the subject has no URI, a unique ID is assigned.\n\n  function getSubjectId (subject) {\n    if ('uri' in subject) {\n      return subject.uri\n    } else if ('_subject_id' in subject) {\n      return subject._subject_id\n    } else {\n      const result = '' + subjectIdCounter\n      subject._subject_id = result\n      ++subjectIdCounter\n      return result\n    }\n  }\n\n  // Run a query and populate the table.\n  // Populates also an array of logical rows.  This will be empty when the function\n  // first returns (as the query is performed in the background)\n\n  function runQuery (query, rows, columns, table) {\n    query.running = true\n    const startTime = Date.now()\n\n    let progressMessage = doc.createElement('tr')\n    table.appendChild(progressMessage)\n    progressMessage.textContent = 'Loading ...'\n\n    for (let i = 0; i < rows.length; i++) {\n      rows[i].original = true\n      if (!rows[i].originalValues) {\n        // remember first set\n        rows[i].originalValues = rows[i].values\n      }\n      rows[i].values = {}\n      // oldStyle = rows[i]._htmlRow.getAttribute('style') || ''\n      // rows[i]._htmlRow.style.background = '#ffe'; //setAttribute('style', ' background-color: #ffe;')// yellow\n    }\n\n    const onResult = function (values) {\n      if (!query.running) {\n        return\n      }\n\n      progressMessage.textContent += '.' // give a progress bar\n\n      let row = null\n      let rowKey = null\n      let rowKeyId\n\n      // If the query has a row key, use it to look up the row.\n\n      if (keyVariable in values) {\n        rowKey = values[keyVariable]\n        rowKeyId = getSubjectId(rowKey)\n\n        // Do we have a row for this already?\n        // If so, reuse it; otherwise, we must create a new row.\n\n        if (rowKeyId in rowsLookup) {\n          row = rowsLookup[rowKeyId]\n        }\n      }\n\n      // Create a new row?\n\n      if (!row) {\n        const tr = doc.createElement('tr')\n        table.appendChild(tr)\n\n        row = {\n          _htmlRow: tr,\n          _subject: rowKey,\n          values: {}\n        }\n        rows.push(row)\n\n        if (rowKey) {\n          rowsLookup[rowKeyId] = row\n        }\n      }\n\n      // Add the new values to this row.\n      delete row.original // This is included in the new data\n      updateRow(row, columns, values)\n    }\n\n    const onDone = function () {\n      if (\n        progressMessage &&\n        progressMessage.parentNode &&\n        progressMessage.parentNode.removeChild\n      ) {\n        progressMessage.parentNode.removeChild(progressMessage)\n        progressMessage = null\n      }\n\n      const elapsedTimeMS = Date.now() - startTime\n      debug.log(\n        'Query done: ' + rows.length + ' rows, ' + elapsedTimeMS + 'ms'\n      )\n      // Delete rows which were from old values not new\n      for (let i = rows.length - 1; i >= 0; i--) {\n        // backwards\n        if (rows[i].original) {\n          debug.log('   deleting row ' + rows[i]._subject)\n          const tr = rows[i]._htmlRow\n          tr.parentNode.removeChild(tr)\n          delete rowsLookup[getSubjectId(rows[i]._subject)]\n          rows.splice(i, 1)\n        }\n      }\n\n      if (options.sortBy) { // @@ for each column check needs sorting\n        const column = getColumnForVariable(columns, options.sortBy)\n        literalSort(rows, column, options.sortReverse)\n      }\n\n      if (options.onDone) options.onDone(resultDiv) // return div makes testing easier\n    }\n    kb.query(query, onResult, undefined, onDone)\n  }\n\n  // Given the formula object which is the query pattern,\n  // deduce from where the variable occurs constraints on\n  // what values it can take.\n\n  function inferColumnsFromFormula (columns, formula) {\n    UI.log.debug('>> processing formula')\n\n    for (let i = 0; i < formula.statements.length; ++i) {\n      const statement = formula.statements[i]\n      // UI.log.debug(\"processing statement \" + i)\n\n      // Does it match this?:\n      // <something> <predicate> ?var\n      // If so, we can use the predicate as the predicate for the\n      // column used for the specified variable.\n\n      if (\n        statement.predicate.termType === 'NamedNode' &&\n        statement.object.termType === 'Variable'\n      ) {\n        const variable = statement.object.toString()\n        if (variable in columns) {\n          const column = columns[variable]\n          column.setPredicate(statement.predicate, false, statement.subject)\n        }\n      }\n      if (\n        statement.predicate.termType === 'NamedNode' &&\n        statement.subject.termType === 'Variable'\n      ) {\n        const variable = statement.subject.toString()\n        if (variable in columns) {\n          const column = columns[variable]\n          column.setPredicate(statement.predicate, true, statement.object)\n        }\n      }\n    }\n\n    // Apply to OPTIONAL formulas:\n\n    for (let i = 0; i < formula.optional.length; ++i) {\n      UI.log.debug('recurse to optional subformula ' + i)\n      inferColumnsFromFormula(columns, formula.optional[i])\n    }\n\n    UI.log.debug('<< finished processing formula')\n  }\n\n  // Generate a list of column structures and infer details about the\n  // predicates based on the contents of the query\n\n  function inferColumns (query) {\n    // Generate the columns list:\n\n    const result = []\n    const columns = {}\n\n    for (let i = 0; i < query.vars.length; ++i) {\n      const column = new Column()\n      const queryVar = query.vars[i]\n      UI.log.debug('column ' + i + ' : ' + queryVar)\n\n      column.setVariable(queryVar)\n      columns[queryVar] = column\n      result.push(column)\n    }\n\n    inferColumnsFromFormula(columns, query.pat)\n\n    return result\n  }\n\n  // Generate a table from a query.\n\n  function renderTableForQuery (query, type) {\n    // infer columns from query, to allow generic queries\n    let columns\n    if (!givenQuery) {\n      columns = type.getColumns()\n    } else {\n      columns = inferColumns(query)\n    }\n\n    // Start with an empty list of rows; this will be populated\n    // by the query.\n\n    const rows = []\n\n    // Create table element and header.\n\n    const table = doc.createElement('table')\n\n    table.appendChild(renderTableHeader(columns, type))\n    table.appendChild(renderTableSelectors(rows, columns))\n\n    // Run query.  Note that this is perform asynchronously; the\n    // query runs in the background and this call does not block.\n\n    table.logicalRows = rows // Save for refresh\n    table.columns = columns\n    table.query = query\n\n    runQuery(query, rows, columns, table)\n\n    return table\n  }\n\n  // Find the most common type of row\n\n  function getMostCommonType (types) {\n    let bestCount = -1\n    let best = null\n\n    let typeUri\n    for (typeUri in types) {\n      const type = types[typeUri]\n\n      if (type.useCount > bestCount) {\n        best = type\n        bestCount = type.useCount\n      }\n    }\n\n    return best\n  }\n\n  // Filter list of columns to only those columns used in the\n  // specified rows.\n  /*\n  function filterColumns (columns, rows) {\n    var filteredColumns = {}\n\n    // Copy columns from \"columns\" -> \"filteredColumns\", but only\n    // those columns that are used in the list of rows specified.\n\n    for (let columnUri in columns) {\n      for (let i = 0; i < rows.length; ++i) {\n        if (columnUri in rows[i]) {\n          filteredColumns[columnUri] = columns[columnUri]\n          break\n        }\n      }\n    }\n    return filteredColumns\n  }\n  */\n}\n// ///////////////////////////////////////////////////////////////////\n\n// ENDS\n"],"file":"table.js"}