{"version":3,"file":"language.js","names":["debug","_interopRequireWildcard","require","_solidLogic","ns","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","_typeof","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","languageCodeURIBase","exports","defaultPreferredLanguages","addDefaults","array","concat","filter","code","includes","getPreferredLanguagesFor","_x","_getPreferredLanguagesFor","apply","arguments","_asyncToGenerator2","_regenerator","mark","_callee","person","_store$fetcher","doc","list","languageCodeArray","wrap","_callee$","_context","prev","next","store","fetcher","load","any","schema","abrupt","elements","forEach","item","lang","solid","console","warn","value","startsWith","error","slice","length","push","log","join","stop","getPreferredLanguages","_getPreferredLanguages","_callee2","me","solidLanguagePrefs","_callee2$","_context2","authn","currentUser","sent","navigator","languages","map","longForm","split","language","filterByLanguage","bindings","languagePrefs","uris","binding","uri","subject","languagePrefs2","reverse","slimmed","sortMe","name","index","indexOf","pair","sort"],"sources":["../../../../src/widgets/forms/autocomplete/language.ts"],"sourcesContent":["/* Logic to access public data stores\n*\n* including filtering resut by natural language etc\n* See https://solidos.solidcommunity.net/public/2021/01%20Building%20Solid%20Apps%20which%20use%20Public%20Data.html\n*/\n/* eslint-disable no-console */\nimport * as debug from '../../../debug'\n// import * as logic from '../index'\n// import { authn } from '../../../authn/index'\nimport { authn, store } from 'solid-logic'\nimport * as ns from '../../../ns'\nimport { Collection, NamedNode, Node } from 'rdflib'\n// import { Binding } from '../widgets/forms/autocomplete/publicData'\n// import { nativeNameForLanguageCode, englishNameForLanguageCode } from './nativeNameForLanguageCode'\n\n// const { currentUser } = logic.authn\n\nexport interface Binding {\n  subject: Node;\n  name?: Node\n  location?: Node\n  coordinates?: Node\n}\n\nexport const languageCodeURIBase = 'https://www.w3.org/ns/iana/language-code/' /// @@ unsupported on the web (2021)\n\nexport const defaultPreferredLanguages = ['en', 'fr', 'de', 'it', 'ar']\n\nexport function addDefaults (array) {\n  if (!array) array = []\n  return array.concat(defaultPreferredLanguages.filter(code => !array.includes(code)))\n}\n\nexport async function getPreferredLanguagesFor (person: NamedNode) {\n  const doc = person.doc()\n  await store.fetcher?.load(doc)\n  const list = store.any(person, ns.schema('knowsLanguage'), null, doc) as Collection | undefined\n  if (!list) {\n    // console.log(`User ${person} has not set their languages in their profile.`)\n    return defaultPreferredLanguages\n  }\n  const languageCodeArray: string[] = []\n  list.elements.forEach(item => {\n    // console.log('@@ item ' + item)\n    const lang = store.any(item as any, ns.solid('publicId'), null, doc)\n    if (!lang) {\n      console.warn('getPreferredLanguages: No publiID of language.')\n      return\n    }\n    if (!lang.value.startsWith(languageCodeURIBase)) {\n      console.error(`What should be a language code ${lang.value} does not start with ${languageCodeURIBase}`)\n      return\n    }\n    const code = lang.value.slice(languageCodeURIBase.length)\n    languageCodeArray.push(code)\n  })\n\n  if (languageCodeArray.length > 0) {\n    console.log(`     User knows languages with codes: \"${languageCodeArray.join(',')}\"`)\n    return addDefaults(languageCodeArray)\n  }\n  return null\n}\n/* Get the preferred langauges for the user\n *\n *  Either from solid preferences or browser preferences or default\n */\nexport async function getPreferredLanguages () {\n  // In future:  cache in the login session for speed, but get from profile and private prefs\n  // We append the defaults so if someone's first choice is not available they don't get something very obscure\n  // See https://github.com/solidos/solidos/issues/42\n  const me = await authn.currentUser() as NamedNode\n  if (me) { // If logged in\n    const solidLanguagePrefs = await getPreferredLanguagesFor(me)\n    if (solidLanguagePrefs) return solidLanguagePrefs\n  }\n  if (typeof navigator !== 'undefined') { // use browser settings\n    if (navigator.languages) {\n      return addDefaults(navigator.languages.map(longForm => longForm.split('-')[0]))\n    }\n    if (navigator.language) {\n      return addDefaults([navigator.language.split('-')[0]])\n    }\n  }\n  return defaultPreferredLanguages\n}\n\n/* From an array of bindings with a names for each row,\n * remove dupliacte names for the same thing, leaving the user's\n * preferred language version\n*/\n\nexport function filterByLanguage (bindings, languagePrefs) {\n  const uris = {}\n  bindings.forEach(binding => { // Organize names by their subject\n    const uri = binding.subject.value\n    uris[uri] = uris[uri] || []\n    uris[uri].push(binding)\n  })\n\n  const languagePrefs2 = languagePrefs || defaultPreferredLanguages\n  languagePrefs2.reverse() // Preferred last\n\n  const slimmed = ([] as Array<Binding>)\n  // console.log(` @@ {languagePrefs2 ${languagePrefs2}`)\n  for (const u in uris) { // needs hasOwnProperty ?\n    const bindings = uris[u]\n    const sortMe = bindings.map(binding => {\n      const lang = binding.name['xml:lang']\n      const index = languagePrefs2.indexOf(lang)\n      const pair = [index, binding]\n      // console.log(`   @@ lang: ${lang}, index: ${index}`)\n      return pair\n    })\n    sortMe.sort() // best at th ebottom\n    sortMe.reverse() // best at the top\n    // console.debug('@@ sortMe:', sortMe)\n    slimmed.push((sortMe[0][1] as any))\n  } // map u\n  debug.log(` Filter by language: ${bindings.length} -> ${slimmed.length}`)\n  return slimmed\n}\n"],"mappings":"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","ignoreList":[]}