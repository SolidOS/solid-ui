{"version":3,"sources":["../../src/chat/message.js"],"names":["UI","authn","icons","ns","media","pad","rdf","store","style","utils","widgets","dom","window","document","messageBodyStyle","label","elementForImageURI","imageUri","options","img","createElement","height","inlineImageHeightEms","trim","setAttribute","anchor","appendChild","makeDraggable","$rdf","sym","text","term","a","uri","addEventListener","openHrefInOutlineMode","textContent","nick","person","s","any","foaf","value","creatorAndDate","td1","creator","date","message","nickAnchor","fetcher","nowOrWhenFetched","doc","undefined","_ok","_body","creatorAndDateHorizontal","dateBit","fontSize","marginLeft","renderMessage","messageTable","bindings","fresh","userContext","colorizeByAuthor","content","dateString","messageRow","AJAR_date","AJAR_subject","selectedMessage","sameTerm","backgroundColor","selectedElement","done","ele","firstChild","nextSibling","newestFirst","newestfirst","insertBefore","authorAboveContent","setImage","shortDate","td2","isURI","test","para","isImage","expandImagesInline","anc","href","bgcolor","lightColorHash","getBgColor","strip","children","length","td3","toolsButton","button","iconBase","_event","toolTR","parentNode","removeChild","toolsTR","tools","parentElement","toolsTD"],"mappings":"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","sourcesContent":["/**\n * Contains the [[renderMessage]] function,\n * along with [[elementForImageURI]],\n * [[creatorAndDate]], and [[creatorAndDateHorizontal]]\n * @packageDocumentation\n */\n\n/* global $rdf */\n\nimport { messageToolbar, sentimentStripLinked } from './messageTools'\n\nimport { authn } from '../authn/index'\nimport { icons } from '../iconBase'\nimport { store } from '../logic'\nimport { media } from '../media/index'\nimport * as ns from '../ns'\nimport * as pad from '../pad'\nimport * as rdf from 'rdflib' // pull in first avoid cross-refs\nimport * as style from '../style'\nimport * as utils from '../utils'\nimport * as widgets from '../widgets'\n\nconst UI = { authn, icons, ns, media, pad, rdf, store, style, utils, widgets }\n\nconst dom = UI.dom || window.document\n// const kb = UI.store\n\nconst messageBodyStyle = UI.style.messageBodyStyle\n\nconst label = UI.utils.label\n\n/**\n * HTML component for an image\n */\nexport function elementForImageURI (imageUri, options) {\n  const img = dom.createElement('img')\n  let height = '10'\n  if (options.inlineImageHeightEms) {\n    height = ('' + options.inlineImageHeightEms).trim()\n  }\n  img.setAttribute(\n    'style',\n    'max-height: ' + height + 'em; border-radius: 1em; margin: 0.7em;'\n  )\n  // UI.widgets.makeDropTarget(img, handleURIsDroppedOnMugshot, droppedFileHandler)\n  if (imageUri) img.setAttribute('src', imageUri)\n  const anchor = dom.createElement('a')\n  anchor.setAttribute('href', imageUri)\n  anchor.setAttribute('target', 'images')\n  anchor.appendChild(img)\n  UI.widgets.makeDraggable(img, $rdf.sym(imageUri))\n  return anchor\n}\n\nconst anchor = function (text, term) {\n  // If there is no link return an element anyway\n  const a = dom.createElement('a')\n  if (term && term.uri) {\n    a.setAttribute('href', term.uri)\n    a.addEventListener('click', UI.widgets.openHrefInOutlineMode, true)\n    a.setAttribute('style', 'color: #3B5998; text-decoration: none; ') // font-weight: bold\n  }\n  a.textContent = text\n  return a\n}\n\nfunction nick (person) {\n  const s = UI.store.any(person, UI.ns.foaf('nick'))\n  if (s) return '' + s.value\n  return '' + label(person)\n}\n\n/**\n * Displays creator and date for a chat message\n * inside the `td1` element\n */\nexport function creatorAndDate (td1, creator, date, message) {\n  const nickAnchor = td1.appendChild(anchor(nick(creator), creator))\n  if (creator.uri) {\n    UI.store.fetcher.nowOrWhenFetched(creator.doc(), undefined, function (\n      _ok,\n      _body\n    ) {\n      nickAnchor.textContent = nick(creator)\n    })\n  }\n  td1.appendChild(dom.createElement('br'))\n  td1.appendChild(anchor(date, message))\n}\n\n/**\n * Horizontally displays creator and date for a chat message\n * inside the `td1` element\n */\nexport function creatorAndDateHorizontal (td1, creator, date, message) {\n  const nickAnchor = td1.appendChild(anchor(label(creator), creator))\n  if (creator.uri) {\n    UI.store.fetcher.nowOrWhenFetched(creator.doc(), undefined, function (\n      _ok,\n      _body\n    ) {\n      nickAnchor.textContent = nick(creator)\n    })\n  }\n  const dateBit = td1.appendChild(anchor(date, message))\n  dateBit.style.fontSize = '80%'\n  dateBit.style.marginLeft = '1em'\n  td1.appendChild(dom.createElement('br'))\n}\n\n/**\n * Renders a chat message inside a `messageTable`\n */\nexport function renderMessage (\n  messageTable,\n  bindings,\n  fresh,\n  options,\n  userContext\n) {\n  const colorizeByAuthor =\n    options.colorizeByAuthor === '1' || options.colorizeByAuthor === true\n\n  const creator = bindings['?creator']\n  const message = bindings['?msg']\n  const date = bindings['?date']\n  const content = bindings['?content']\n\n  const dateString = date.value\n  const messageRow = dom.createElement('tr')\n  messageRow.AJAR_date = dateString\n  messageRow.AJAR_subject = message\n\n  if (options.selectedMessage && options.selectedMessage.sameTerm(message)) {\n    messageRow.style.backgroundColor = 'yellow'\n    options.selectedElement = messageRow\n    messageTable.selectedElement = messageRow\n  }\n\n  let done = false\n  for (let ele = messageTable.firstChild; ; ele = ele.nextSibling) {\n    if (!ele) {\n      // empty\n      break\n    }\n    const newestFirst = options.newestfirst === true\n    if (\n      (dateString > ele.AJAR_date && newestFirst) ||\n      (dateString < ele.AJAR_date && !newestFirst)\n    ) {\n      messageTable.insertBefore(messageRow, ele)\n      done = true\n      break\n    }\n  }\n  if (!done) {\n    messageTable.appendChild(messageRow)\n  }\n\n  const td1 = dom.createElement('td')\n  messageRow.appendChild(td1)\n  if (options.authorAboveContent) {\n    const img = dom.createElement('img')\n    img.setAttribute(\n      'style',\n      'max-height: 2.5em; max-width: 2.5em; border-radius: 0.5em; margin: auto;'\n    )\n    UI.widgets.setImage(img, creator)\n    td1.appendChild(img)\n  } else {\n    creatorAndDate(td1, creator, UI.widgets.shortDate(dateString), message)\n  }\n\n  // Render the content ot the message itself\n  const td2 = messageRow.appendChild(dom.createElement('td'))\n\n  if (options.authorAboveContent) {\n    creatorAndDateHorizontal(\n      td2,\n      creator,\n      UI.widgets.shortDate(dateString),\n      message\n    )\n  }\n  const text = content.value.trim()\n  const isURI = /^https?:\\/[^ <>]*$/i.test(text)\n  let para = null\n  if (isURI) {\n    const isImage = /\\.(gif|jpg|jpeg|tiff|png|svg)$/i.test(text) // @@ Should use content-type not URI\n    if (isImage && options.expandImagesInline) {\n      const img = elementForImageURI(text, options)\n      td2.appendChild(img)\n    } else {\n      // Link but not Image\n      const anc = td2.appendChild(dom.createElement('a'))\n      para = anc.appendChild(dom.createElement('p'))\n      anc.href = text\n      para.textContent = text\n      td2.appendChild(anc)\n    }\n  } else {\n    // text\n    para = dom.createElement('p')\n    td2.appendChild(para)\n    para.textContent = text\n  }\n  if (para) {\n    const bgcolor = colorizeByAuthor\n      ? UI.pad.lightColorHash(creator)\n      : getBgColor(fresh)\n    para.setAttribute(\n      'style',\n      messageBodyStyle + 'background-color: ' + bgcolor + ';'\n    )\n  }\n\n  function getBgColor (fresh) {\n    return fresh ? '#e8ffe8' : 'white'\n  }\n\n  // Sentiment strip\n  const strip = sentimentStripLinked(message, message.doc())\n  if (strip.children.length) {\n    td2.appendChild(dom.createElement('br'))\n    td2.appendChild(strip)\n  }\n\n  // Message tool bar button\n  const td3 = dom.createElement('td')\n  messageRow.appendChild(td3)\n  const toolsButton = UI.widgets.button(\n    dom,\n    UI.icons.iconBase + 'noun_243787.svg',\n    '...'\n  )\n  td3.appendChild(toolsButton)\n  toolsButton.addEventListener('click', function (_event) {\n    if (messageRow.toolTR) {\n      // already got a toolbar? Toogle\n      messageRow.parentNode.removeChild(messageRow.toolTR)\n      delete messageRow.toolTR\n      return\n    }\n    const toolsTR = dom.createElement('tr')\n    const tools = messageToolbar(message, messageRow, userContext)\n    tools.style =\n      'border: 0.05em solid #888; border-radius: 0 0 0.7em 0.7em;  border-top: 0; height:3.5em; background-color: #fff;' // @@ fix\n    if (messageRow.nextSibling) {\n      messageRow.parentElement.insertBefore(toolsTR, messageRow.nextSibling)\n    } else {\n      messageRow.parentElement.appendChild(toolsTR)\n    }\n    messageRow.toolTR = toolsTR\n    toolsTR.appendChild(dom.createElement('td')) // left\n    const toolsTD = toolsTR.appendChild(dom.createElement('td'))\n    toolsTR.appendChild(dom.createElement('td')) // right\n    toolsTD.appendChild(tools)\n  })\n  return messageRow\n}\n"],"file":"message.js"}