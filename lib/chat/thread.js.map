{"version":3,"sources":["../../src/chat/thread.js"],"names":["UI","authn","icons","ns","media","pad","store","style","utils","widgets","thread","dom","kb","subject","messageStore","options","doc","WF","$rdf","Namespace","DCT","newestFirst","messageBodyStyle","div","createElement","messageTable","me","updater","anchor","text","term","a","uri","setAttribute","addEventListener","openHrefInOutlineMode","textContent","mention","message","pre","appendChild","createTextNode","announce","log","warn","error","newMessageForm","form","lhs","middle","rhs","AJAR_date","sendMessage","field","disabled","sts","now","Date","timestamp","getTime","dateStamp","sym","push","Statement","wf","sioc","literal","value","foaf","sendComplete","success","body","errorMessageBlock","bindings","renderMessage","update","sendButton","turnOnInput","creatorAndDate","innerHTML","rows","e","keyCode","altKey","button","iconBase","buttonStyle","context","logIn","then","nick","person","s","any","label","td1","creator","date","nickAnchor","fetcher","nowOrWhenFetched","undefined","_ok","_body","syncMessages","about","displayed","ele","ele2","firstChild","nextSibling","AJAR_subject","messages","each","stored","forEach","m","addMessage","removeChild","deleteMessage","deletions","statementsMatching","concat","ok","fresh","content","dateString","tr","done","insertBefore","shortDate","td2","td3","delButton","_event","cancelButton","sureButton","query","Query","v","vs","x","vars","variable","pat","add","msg","dct","doneQuery","refresh"],"mappings":"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","sourcesContent":["/**\n * Contains the [[thread]] function\n * @packageDocumentation\n */\n\nimport { authn } from '../authn/index'\nimport { icons } from '../iconBase'\nimport { store } from '../logic'\nimport { media } from '../media/index'\nimport * as ns from '../ns'\nimport * as pad from '../pad'\nimport * as $rdf from 'rdflib' // pull in first avoid cross-refs\nimport * as style from '../style'\nimport * as utils from '../utils'\nimport * as widgets from '../widgets'\n\nconst UI = { authn, icons, ns, media, pad, store, style, utils, widgets }\n\n/**\n * HTML component for a chat thread\n */\nexport function thread (dom, kb, subject, messageStore, options) {\n  kb = kb || UI.store\n  messageStore = messageStore.doc() // No hash\n  const ns = UI.ns\n  const WF = $rdf.Namespace('http://www.w3.org/2005/01/wf/flow#')\n  const DCT = $rdf.Namespace('http://purl.org/dc/terms/')\n\n  options = options || {}\n\n  const newestFirst = !!options.newestFirst\n\n  const messageBodyStyle =\n    'white-space: pre-wrap; width: 90%; font-size:100%; border: 0.07em solid #eee; padding: .2em 0.5em; margin: 0.1em 1em 0.1em 1em;'\n  // 'font-size: 100%; margin: 0.1em 1em 0.1em 1em;  background-color: white; white-space: pre-wrap; padding: 0.1em;'\n\n  const div = dom.createElement('div')\n  // eslint-disable-next-line prefer-const\n  let messageTable // Shared by initial build and addMessageFromBindings\n\n  let me\n\n  const updater = UI.store.updater\n\n  const anchor = function (text, term) {\n    // If there is no link return an element anyway\n    const a = dom.createElement('a')\n    if (term && term.uri) {\n      a.setAttribute('href', term.uri)\n      a.addEventListener('click', UI.widgets.openHrefInOutlineMode, true)\n      a.setAttribute('style', 'color: #3B5998; text-decoration: none; ') // font-weight: bold\n    }\n    a.textContent = text\n    return a\n  }\n\n  const mention = function mention (message, style) {\n    const pre = dom.createElement('pre')\n    pre.setAttribute('style', style || 'color: grey')\n    div.appendChild(pre)\n    pre.appendChild(dom.createTextNode(message))\n    return pre\n  }\n\n  const announce = {\n    log: function (message) {\n      mention(message, 'color: #111;')\n    },\n    warn: function (message) {\n      mention(message, 'color: #880;')\n    },\n    error: function (message) {\n      mention(message, 'color: #800;')\n    }\n  }\n\n  /**\n   * Form for a new message\n   */\n  const newMessageForm = function () {\n    const form = dom.createElement('tr')\n    const lhs = dom.createElement('td')\n    const middle = dom.createElement('td')\n    const rhs = dom.createElement('td')\n    form.appendChild(lhs)\n    form.appendChild(middle)\n    form.appendChild(rhs)\n    form.AJAR_date = '9999-01-01T00:00:00Z' // ISO format for field sort\n\n    const sendMessage = function () {\n      // titlefield.setAttribute('class','pendingedit')\n      // titlefield.disabled = true\n      field.setAttribute('class', 'pendingedit')\n      field.disabled = true\n      const sts = []\n      const now = new Date()\n      const timestamp = '' + now.getTime()\n      const dateStamp = $rdf.term(now)\n      // http://www.w3schools.com/jsref/jsref_obj_date.asp\n      const message = kb.sym(messageStore.uri + '#' + 'Msg' + timestamp)\n\n      sts.push(\n        new $rdf.Statement(subject, ns.wf('message'), message, messageStore)\n      )\n      // sts.push(new $rdf.Statement(message, ns.dc('title'), kb.literal(titlefield.value), messageStore))\n      sts.push(\n        new $rdf.Statement(\n          message,\n          ns.sioc('content'),\n          kb.literal(field.value),\n          messageStore\n        )\n      )\n      sts.push(\n        new $rdf.Statement(message, DCT('created'), dateStamp, messageStore)\n      )\n      if (me) {\n        sts.push(\n          new $rdf.Statement(message, ns.foaf('maker'), me, messageStore)\n        )\n      }\n\n      const sendComplete = function (uri, success, body) {\n        if (!success) {\n          form.appendChild(\n            UI.widgets.errorMessageBlock(dom, 'Error writing message: ' + body)\n          )\n        } else {\n          const bindings = {\n            '?msg': message,\n            '?content': kb.literal(field.value),\n            '?date': dateStamp,\n            '?creator': me\n          }\n          renderMessage(bindings, false) // not green\n\n          field.value = '' // clear from out for reuse\n          field.setAttribute('class', '')\n          field.disabled = false\n        }\n      }\n      updater.update([], sts, sendComplete)\n    }\n    form.appendChild(dom.createElement('br'))\n\n    let field, sendButton\n    const turnOnInput = function () {\n      creatorAndDate(lhs, me, '', null)\n\n      field = dom.createElement('textarea')\n      middle.innerHTML = ''\n      middle.appendChild(field)\n      field.rows = 3\n      // field.cols = 40\n      field.setAttribute('style', messageBodyStyle + 'background-color: #eef;')\n\n      field.addEventListener(\n        'keyup',\n        function (e) {\n          // User preference?\n          if (e.keyCode === 13) {\n            if (!e.altKey) {\n              // Alt-Enter just adds a new line\n              sendMessage()\n            }\n          }\n        },\n        false\n      )\n\n      rhs.innerHTML = ''\n      sendButton = UI.widgets.button(\n        dom,\n        UI.icons.iconBase + 'noun_383448.svg',\n        'Send'\n      )\n      sendButton.setAttribute('style', UI.style.buttonStyle + 'float: right;')\n      sendButton.addEventListener('click', sendMessage, false)\n      rhs.appendChild(sendButton)\n    }\n\n    const context = { div: middle, dom: dom }\n    UI.authn.logIn(context).then(context => {\n      me = context.me\n      turnOnInput()\n    })\n\n    return form\n  }\n\n  function nick (person) {\n    const s = UI.store.any(person, UI.ns.foaf('nick'))\n    if (s) return '' + s.value\n    return '' + utils.label(person)\n  }\n\n  function creatorAndDate (td1, creator, date, message) {\n    const nickAnchor = td1.appendChild(anchor(nick(creator), creator))\n    if (creator.uri) {\n      UI.store.fetcher.nowOrWhenFetched(creator.doc(), undefined, function (\n        _ok,\n        _body\n      ) {\n        nickAnchor.textContent = nick(creator)\n      })\n    }\n    td1.appendChild(dom.createElement('br'))\n    td1.appendChild(anchor(date, message))\n  }\n\n  // ///////////////////////////////////////////////////////////////////////\n\n  function syncMessages (about, messageTable) {\n    const displayed = {}\n    let ele, ele2\n    for (ele = messageTable.firstChild; ele; ele = ele.nextSibling) {\n      if (ele.AJAR_subject) {\n        displayed[ele.AJAR_subject.uri] = true\n      }\n    }\n    const messages = kb.each(about, ns.wf('message'))\n    const stored = {}\n    messages.forEach(function (m) {\n      stored[m.uri] = true\n      if (!displayed[m.uri]) {\n        addMessage(m)\n      }\n    })\n\n    // eslint-disable-next-line space-in-parens\n    for (ele = messageTable.firstChild; ele; ) {\n      ele2 = ele.nextSibling\n      if (ele.AJAR_subject && !stored[ele.AJAR_subject.uri]) {\n        messageTable.removeChild(ele)\n      }\n      ele = ele2\n    }\n  }\n  const deleteMessage = function (message) {\n    const deletions = kb\n      .statementsMatching(message)\n      .concat(kb.statementsMatching(undefined, undefined, message))\n    updater.update(deletions, [], function (uri, ok, body) {\n      if (!ok) {\n        announce.error('Cant delete messages:' + body)\n      } else {\n        syncMessages(subject, messageTable)\n      }\n    })\n  }\n\n  var addMessage = function (message) {\n    const bindings = {\n      '?msg': message,\n      '?creator': kb.any(message, ns.foaf('maker')),\n      '?date': kb.any(message, DCT('created')),\n      '?content': kb.any(message, ns.sioc('content'))\n    }\n    renderMessage(bindings, true) // fresh from elsewhere\n  }\n\n  var renderMessage = function (bindings, fresh) {\n    const creator = bindings['?creator']\n    const message = bindings['?msg']\n    const date = bindings['?date']\n    const content = bindings['?content']\n\n    const dateString = date.value\n    const tr = dom.createElement('tr')\n    tr.AJAR_date = dateString\n    tr.AJAR_subject = message\n\n    let done = false\n    for (let ele = messageTable.firstChild; ; ele = ele.nextSibling) {\n      if (!ele) {\n        // empty\n        break\n      }\n      if (\n        (dateString > ele.AJAR_date && newestFirst) ||\n        (dateString < ele.AJAR_date && !newestFirst)\n      ) {\n        messageTable.insertBefore(tr, ele)\n        done = true\n        break\n      }\n    }\n    if (!done) {\n      messageTable.appendChild(tr)\n    }\n\n    const td1 = dom.createElement('td')\n    tr.appendChild(td1)\n    creatorAndDate(td1, creator, UI.widgets.shortDate(dateString), message)\n\n    const td2 = dom.createElement('td')\n    tr.appendChild(td2)\n    const pre = dom.createElement('p')\n    pre.setAttribute(\n      'style',\n      messageBodyStyle +\n        (fresh ? 'background-color: #e8ffe8;' : 'background-color: #white;')\n    )\n    td2.appendChild(pre)\n    pre.textContent = content.value\n\n    const td3 = dom.createElement('td')\n    tr.appendChild(td3)\n\n    const delButton = dom.createElement('button')\n    td3.appendChild(delButton)\n    delButton.textContent = '-'\n\n    tr.setAttribute('class', 'hoverControl') // See tabbedtab.css (sigh global CSS)\n    delButton.setAttribute('class', 'hoverControlHide')\n    delButton.setAttribute('style', 'color: red;')\n    delButton.addEventListener(\n      'click',\n      function (_event) {\n        td3.removeChild(delButton) // Ask -- are you sure?\n        const cancelButton = dom.createElement('button')\n        cancelButton.textContent = 'cancel'\n        td3.appendChild(cancelButton).addEventListener(\n          'click',\n          function (_event) {\n            td3.removeChild(sureButton)\n            td3.removeChild(cancelButton)\n            td3.appendChild(delButton)\n          },\n          false\n        )\n        var sureButton = dom.createElement('button')\n        sureButton.textContent = 'Delete message'\n        td3.appendChild(sureButton).addEventListener(\n          'click',\n          function (_event) {\n            td3.removeChild(sureButton)\n            td3.removeChild(cancelButton)\n            deleteMessage(message)\n          },\n          false\n        )\n      },\n      false\n    )\n  }\n\n  // Messages with date, author etc\n\n  messageTable = dom.createElement('table')\n  messageTable.fresh = false\n  div.appendChild(messageTable)\n  messageTable.setAttribute('style', 'width: 100%;') // fill that div!\n\n  const tr = newMessageForm()\n  if (newestFirst) {\n    messageTable.insertBefore(tr, messageTable.firstChild) // If newestFirst\n  } else {\n    messageTable.appendChild(tr) // not newestFirst\n  }\n\n  let query\n  // Do this with a live query to pull in messages from web\n  if (options.query) {\n    query = options.query\n  } else {\n    query = new $rdf.Query('Messages')\n    const v = {} // semicolon needed\n    const vs = ['msg', 'date', 'creator', 'content']\n    vs.forEach(function (x) {\n      query.vars.push((v[x] = $rdf.variable(x)))\n    })\n    query.pat.add(subject, WF('message'), v.msg)\n    query.pat.add(v.msg, ns.dct('created'), v.date)\n    query.pat.add(v.msg, ns.foaf('maker'), v.creator)\n    query.pat.add(v.msg, ns.sioc('content'), v.content)\n  }\n\n  function doneQuery () {\n    messageTable.fresh = true // any new are fresh and so will be greenish\n  }\n  kb.query(query, renderMessage, undefined, doneQuery)\n  div.refresh = function () {\n    syncMessages(subject, messageTable)\n  }\n  // syncMessages(subject, messageTable) // no the query will do this async\n  return div\n}\n"],"file":"thread.js"}